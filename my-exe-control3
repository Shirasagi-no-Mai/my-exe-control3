import openpyxl
from openpyxl import Workbook
from selenium.common.exceptions import ElementNotInteractableException
from openpyxl.styles import PatternFill
import re
import sys
import tkinter as tk
import inspect

from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from selenium.webdriver.common.action_chains import ActionChains
from datetime import datetime
import os
import time
from selenium.common.exceptions import NoAlertPresentException
from selenium.webdriver.support.ui import Select
from selenium.common.exceptions import StaleElementReferenceException
from tkinter import Toplevel
from tkinter import ttk
import requests
from collections import Counter
import shutil
import glob
from seleniumwire.utils import decode
import requests
import json
import base64
import zlib
import gzip
import subprocess
from requests.exceptions import ConnectionError, Timeout, RequestException
import traceback
from openpyxl import load_workbook
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from requests.exceptions import ConnectionError, Timeout, RequestException
import msoffcrypto
import string
import re
import numpy as np  # å¯¼å…¥numpyä»¥æ£€æŸ¥NaNå’ŒInfå€¼

# *************************é€šè¿‡ä¸ªäººç½‘é¡µæ›´æ–°è¿‡æœŸæ—¥æœŸ*************************************************************************
CONFIG_URL = "https://raw.githubusercontent.com/Shirasagi-no-Mai/my-exe-control/main/expiration_config.json"


def fetch_expiration_date():
    try:
        response = requests.get(CONFIG_URL)
        response.raise_for_status()
        config = json.loads(response.text)
        return datetime.strptime(config['expiration_date'], '%Y-%m-%d')
    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")

        return None
    except (json.JSONDecodeError, KeyError, ValueError) as e:
        print(f"è§£æé”™è¯¯: {e}")
        return None


expiration_date1 = fetch_expiration_date()
print(f"expiration_date1: {expiration_date1}")






# â‘¡ åŠŸèƒ½æƒé™é…ç½®
# ----------------------------
PERMISSION_URL = "https://raw.githubusercontent.com/Shirasagi-no-Mai/my-exe-control2/refs/heads/main/onlinecode"

def fetch_permissions():
    """ä»è¿œç¨‹è¯»å–åŠŸèƒ½æƒé™åˆ—è¡¨"""
    try:
        response = requests.get(PERMISSION_URL, timeout=10)
        response.raise_for_status()
        data = response.json()
        permissions = {f["name"]: f["allowed_users"] for f in data.get("functions", [])}
        return permissions
    except requests.exceptions.RequestException as e:
        print(f"ç½‘ç»œè¯·æ±‚å¤±è´¥: {e}")
    except (json.JSONDecodeError, KeyError, ValueError) as e:
        print(f"è§£æé”™è¯¯: {e}")
    return {}


permissions = fetch_permissions()


def is_user_allowed(func_name, username):
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸå‡½æ•°"""
    return username in permissions.get(func_name, [])


# ----------------------------
# âœ… ç¤ºä¾‹æ‰§è¡Œ
# ----------------------------


permissions = fetch_permissions()
print("æƒé™åˆ—è¡¨ç¤ºä¾‹ï¼š")
print(json.dumps(permissions, indent=2, ensure_ascii=False))








# *************************é€šè¿‡ä¸ªäººç½‘é¡µæ›´æ–°è¿‡æœŸæ—¥æœŸ*************************************************************************


# *************************é¢„è®¾*****************************************************************************************

# æ›´æ–°è¾“å‡ºæ–‡æœ¬æ¡†
windowname = ""
from selenium.common.exceptions import UnexpectedAlertPresentException, ElementClickInterceptedException


def update_output_text(output_text, message):
    output_text.insert(tk.END, message)
    output_text.yview(tk.END)


# *************************é¢„è®¾*****************************************************************************************

def FDA_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶,ä¸‹æ¬¡è¿è¡Œå°†å¼€å§‹æ“ä½œï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    def get_fda_entry_status(entry_number):
        url = f"https://www.access.fda.gov/itacs/ws/api/submission/{entry_number}/?feiNum=null&token=0cAFcWeA4bdocblwHFTljvFqa3R0J9MmTPnL4y3c-ZWc-dFVlUW6_ua7RrUeBfJZ0eWw5OZvzUiHzYbi8jxmuzPPYdP6qb2t7565VZOVd8ETPtIGW9oavQ8Sy9Mv-zTGtfgcSX3WSzOjamHdgWysPtHC55CBPM_aHvqmHRbDEofVrqyjU-tJ6sn5cNO7sTffZ-DVwTjJwGgUC3GCUyXr-ExK7NYuJK44maAlK5jRtgwCbb4g-YjzCLK2dQNgn31pf8j0MMwjCq3cmEIYBG8dvH2pGVipjf4cRvI3ID0NBpFGPKT-B4CHg3wU5Pcx7oju6WUeldAN30Qnn7I_Rt3MC4VvxKwt3sye_IynRWC5McJ0nlFySsnD-qWuIuFGXNl-FFid8Te6BunF_xtljwm1TKFSZ7aug-SLt44dzCL_ljLCoWVVXh0j64_JWNDknU1VqbfycWggHlPF1Txgh1_6Z7jZw-DKXBZj9Vy8A-zefvyfX5yBgWUubsAEEV1JPHKIyc7n5JWPzj5SoZ8_5tFLKJJnv4mEHLC2HQI_Qs6AFidS3JQdfuUlk1Nnh9Llrw0TFCMzndL4FJPI2y9mV0LnRiL7OQHrX1pa1wNFkHdMrmWoPLo89rHtftYKyuOp6IegWoha1CsivbD2SqyLGvPtxlXEdG2oOaH7OUEvWMNIp1S52Pzn5_9zYc2t9ddLmPskozKl78np2VEDmaAOFX5dvNYaXALBd8D2uIILPcg9d3Ux-p2D3k9CTNRLXRtO8IafAAJTefdCHxjyF5Kz1t-vPEE1u9jTOk1DkunSaVDsTgpvRvvDqebSOstg3Rn0tXd7-B1rpEJHwz09PU0-4vgPlwmAMTF6cFleF8mhG0D4nIaD2B9oa-9ryTUeo5jticNmeR3G9yBRNEXThh6bE1jZl2xRgmGgIZqHQXa2RC7j1r_cK4VoIv0r6Uq8Vg8JZI_boZsyncT3wyBzdkN17HUxglEVK8eR5zf1vUlU3iHmCiTHWsuyGaq6V2ie-N8admgEL5s3H6dqDdUYY961Ko4KkwZ3nhXMv9764I0QmxMk5Dkt-atvtwJr2Cqy6VRrims4S9ddVh1wdwRXOzf7FonHS6yiiM63sfMOSI7kyz0q3Xvn0bI9nIR1wTJydrsOdXkACwOaKCqCdZQCWUub23FPNXRAB2WUblWG_2bw-LdD5A2uxtHMnhPcFcVjGLeU4e8B2BBABuernaMTtTkYGJUzuZVhydvn8ITs538lPX-hKKWAdWaczpNPfuWc_jPM9zh5bAPQ82oqhWJd1ESMrCcyaZLojKjnGiDBaOGLiqAS6JfP8-nyHQaMySSXcnnaYicV7qxK65q282qZBa5s63-wC8bR6Q0unzZUWZXRwkO84Q0jxxcwizSD8quAZFLPSQbQFK8WPBW66eRk0rANpp8aGROxGWIBW4gg8PWSDFlX5mG8foUpV-eVUE9kXF8pbBl4SVxtacaMjvFV0hmhvnE5V4fbWlNQmvjC9_DhDAU5vKoTgOc0BPTXSbXKulLa23w8eL7SNcBFzSOy0cOfk5TqJxLajRV6dWBJuIY2LfWnhJTPOen3Vei-PUVKDygWvr8L6kmWKbIAqtE1HNMKSYgOEKtyfJdBNRNzZS-w"

        headers = {
            "accept": "application/json, text/plain, */*",
            "authorization": "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlcyI6IltcIlBVQkxJQ1wiXSIsImlzcyI6ImF1dGgwIiwiY3JlYXRlVGltZXN0YW1wIjoxNzU1ODk3NTQ3NTcxfQ.WCnz5k1mMk4pfBFa3zzCa_r4GoH9l3_1jMfxPTX5n6w",
            "referer": "https://www.access.fda.gov/itacs/",
            "user-agent": "Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 CrKey/1.54.250320"
        }

        session = requests.Session()
        retries = Retry(total=3, backoff_factor=1, status_forcelist=[502, 503, 504])
        session.mount('https://', HTTPAdapter(max_retries=retries))

        try:
            response = session.get(url, headers=headers, timeout=30)
            if response.status_code == 200:
                return response.json()
            else:
                print(f"Error: {response.status_code}")
                return "N/A"
        except (ConnectionError, Timeout, RequestException) as e:
            print(f"è¯·æ±‚å¤±è´¥: {e}")
            return "N/A"

    def get_cpsc_entry_status(entry_number):
        url = "https://www.cpsc.gov/shipmenttracking/api/entries"

        headers = {
            "accept": "*/*",
            "content-type": "application/json",
            "origin": "https://www.cpsc.gov",
            "referer": "https://www.cpsc.gov/shipmenttracking/",
            "user-agent": "Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 CrKey/1.54.250320"
        }
        payload = {
            "entry_number": entry_number,
            "entry_line_number": "",
            "page_number": "",
            "page_size": ""
        }

        session = requests.Session()
        retries = Retry(total=3, backoff_factor=1, status_forcelist=[502, 503, 504])
        session.mount('https://', HTTPAdapter(max_retries=retries))

        try:
            response = session.post(url, headers=headers, json=payload, timeout=30)
            response.raise_for_status()  # å¦‚æœä¸æ˜¯ 200ï¼Œä¼šæŠ›å¼‚å¸¸
            return response.json()
        except (ConnectionError, Timeout, RequestException) as e:
            print(f"è¯·æ±‚å¤±è´¥: {e}")
            return "N/A"

    data = get_cpsc_entry_status('NUP18426901')
    print(data)

    def check_status_for_keyword(data):
        """
        æ£€æŸ¥ entry_lines ä¸­çš„æ¯ä¸€è¡Œ public_status æ˜¯å¦éƒ½åŒ…å«
        "Released by" æˆ– "Entry Data Received"
        è¿”å›ä¸¤ä¸ªå‚æ•°:
            - status (str): "released" æˆ– "not released: {status}"
            - earliest_proceed_date (str): æœ€æ—©çš„æ—¥æœŸï¼Œæ ¼å¼ MM/DD/YYYY hh:mm:ss AM/PM TZï¼Œè‹¥æ— æœ‰æ•ˆæ—¥æœŸè¿”å› ""
        """
        # å¤„ç† data ä¸º "N/A" çš„æƒ…å†µ
        if data == "N/A":
            return "not found", ""

        entry_lines = data.get("entry_lines", [])
        if not entry_lines:
            return "not found", ""

        # æ”¶é›†æ‰€æœ‰åˆæ³•çš„ proceed_date
        dates = []
        for line in entry_lines:
            spcs_proceed_date = line.get("proceed_date", "").strip()
            if spcs_proceed_date and spcs_proceed_date.lower() != "n/a":
                try:
                    pd_no_tz = " ".join(spcs_proceed_date.split()[:-1])  # å»æ‰æœ€åçš„ EDT
                    spcs_proceed_date_proceeded = datetime.strptime(pd_no_tz, "%m/%d/%Y %I:%M:%S %p")
                    dates.append(spcs_proceed_date_proceeded)
                except ValueError:
                    # æ—¥æœŸæ ¼å¼ä¸åŒ¹é…ï¼Œå¿½ç•¥
                    pass

        earliest_date = min(dates).strftime("%m/%d/%Y %I:%M:%S %p") if dates else ""

        # æ£€æŸ¥æ¯æ¡ public_status
        for line in entry_lines:
            status_text = line.get("public_status", "").lower()
            if "released" not in status_text and "entry data received" not in status_text:
                return f"not released: {line.get('public_status', '')}", earliest_date

        return "released", earliest_date

    file_path = os.path.join(desktop_path, "BBCreview.xlsx")

    # æ‰“å¼€ Excel
    wb = openpyxl.load_workbook(file_path)
    ws = wb.active
    first_column_values = [ws.cell(row=row, column=1).value for row in range(1, ws.max_row + 1)]
    update_output_text(output_text, f"æ‰€æœ‰è¦å¤„ç†çš„entry:{first_column_values}\n")
    # éå†ç¬¬ä¸€åˆ—ï¼Œè·å– entry_number å¹¶è°ƒç”¨æ¥å£
    GREEN = PatternFill(start_color="00C6EFCE", end_color="00C6EFCE", fill_type="solid")  # ç»¿è‰²
    RED = PatternFill(start_color="00FFC7CE", end_color="00FFC7CE", fill_type="solid")  # çº¢è‰²

    # åˆå§‹åŒ–ç»“æœåˆ—è¡¨
    fda_results = []
    cpsc_results = []

    # éå†ç¬¬ä¸€åˆ—
    wb = openpyxl.load_workbook(file_path)
    ws = wb.active
    for row in range(1, ws.max_row + 1):
        cell_value = str(ws.cell(row=row, column=1).value)

        # æ£€æŸ¥è¡¨å¤´ï¼ˆé¿å…å¯¹è¡¨å¤´è°ƒç”¨ APIï¼‰
        if row == 1 and "entry" in cell_value.lower():
            fda_results.append("FDA Header")
            cpsc_results.append(("CPSC Header", ""))
            update_output_text(output_text, f"{cell_value}æ˜¯è¡¨å¤´ï¼Œè·³è¿‡APIè°ƒç”¨\n")
            continue

        # æ£€æŸ¥ cell_value æ˜¯å¦ä¸º 8 ä½æ•°å­—
        if not (cell_value.isdigit() and len(cell_value) == 8):
            fda_results.append("æ ¼å¼é”™è¯¯")
            cpsc_results.append(("æ ¼å¼é”™è¯¯", "æ ¼å¼é”™è¯¯"))
            update_output_text(output_text, f"{cell_value}æ ¼å¼é”™è¯¯ï¼Œéœ€ä¸º8ä½æ•°å­—\n")
            continue

        # æ ¼å¼åŒ– entry number
        fda_entry_number = f"NUP-{cell_value[:-1]}-{cell_value[-1]}" if len(cell_value) >= 2 else cell_value
        cpsc_entry_number = f"NUP{cell_value}" if len(cell_value) >= 2 else cell_value

        # è·å– FDA çŠ¶æ€
        response1 = get_fda_entry_status(fda_entry_number)
        if not response1 or response1 == "N/A" or response1.get("status", "").upper() == "ERROR":
            entry_level_status1 = "FDAæ‰¾ä¸åˆ°æ­¤entry"
        else:
            if response1.get("entryLevelStatus") is None:
                if response1.get("entryActive", False):
                    entry_level_status1 = "No public status available"
                else:
                    entry_level_status1 = "entry closed"
            else:
                entry_level_status1 = response1.get("entryLevelStatus")

        # è·å– CPSC çŠ¶æ€
        response2 = get_cpsc_entry_status(cpsc_entry_number)
        if not response2 or response2 == "N/A":
            entry_level_status2 = "N/A"
            entry_level_status2_time = ""
        else:
            entry_level_status2, entry_level_status2_time = check_status_for_keyword(response2)

        fda_results.append(entry_level_status1)
        cpsc_results.append((entry_level_status2, entry_level_status2_time))
        update_output_text(output_text, f"{cell_value}è¿è¡Œå®Œæˆ\n")

    # æ‰¹é‡å†™å…¥

    for row, (fda_res, cpsc_res) in enumerate(zip(fda_results, cpsc_results), start=1):
        # å†™å…¥ç¬¬ 3-5 åˆ—
        ws.cell(row=row, column=3, value=fda_res)
        ws.cell(row=row, column=4, value=cpsc_res[0])
        ws.cell(row=row, column=5, value=cpsc_res[1])

        # ç¬¬ 3 åˆ—é¢œè‰²æ ‡æ³¨
        if "FDAæ‰¾ä¸åˆ°æ­¤entry" in fda_res or "entry closed" in fda_res:
            ws.cell(row=row, column=3).fill = GREEN
        else:
            ws.cell(row=row, column=3).fill = RED

        # ç¬¬ 6 åˆ—ç”Ÿæˆé€»è¾‘
        if "æ ¼å¼é”™è¯¯" in cpsc_res[0].lower():
            ws.cell(row=row, column=6, value="æ ¼å¼æœ‰é—®é¢˜è·³è¿‡æ­¤è¡Œ")
        else:
            if "not released" in cpsc_res[0].lower():
                ws.cell(row=row, column=6, value="CPSC REVIEW")
            elif "FDAæ‰¾ä¸åˆ°æ­¤entry" not in fda_res and "entry closed" not in fda_res:
                if "No public" in fda_res:

                    ws.cell(row=row, column=6, value="FDA REVIEW")
                elif "FDA entry status information is not" in fda_res:
                    ws.cell(row=row, column=6, value="MAY PROCEED")
                    ws.cell(row=row, column=7, value="Arrival Notifacation ä¹Ÿè®¸å¯ä»¥æ”¾è´§")

                else:
                    ws.cell(row=row, column=6, value="FDA HOLD")

            else:
                ws.cell(row=row, column=6, value="MAY PROCEED")

    # ä¿å­˜æ–‡ä»¶
    try:
        wb.save(file_path)
        update_output_text(output_text, "è¿è¡Œå®Œæˆ\n")
    except Exception as e:
        print(f"Error saving file: {e}")
        update_output_text(output_text, f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}\n")

    wb.close()


def inbond_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "inbond extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    if desktop_path:
        file_path2 = os.path.join(desktop_path, "inbond output.xlsx")
        if os.path.exists(file_path2):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path2}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path2)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path2}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None)  # å…³é”®ä¿®æ”¹ï¼šheader=None

    # åˆå§‹åŒ–åˆ—è¡¨
    list61, list62, list63 = [], [], []

    # ç¡®ä¿ DataFrame éç©º
    if not df.empty:
        first_col = df.iloc[:, 0]  # è·å–ç¬¬ä¸€åˆ—
        third_col = df.iloc[:, 2]  # è·å–ç¬¬ä¸‰åˆ—

        # å¤„ç†ç¬¬ä¸€åˆ—æ•°æ®
        # cleaned_values = first_col.apply(lambda x: ''.join(filter(str.isdigit, str(x)))[-8:] if x else '')
        cleaned_values = first_col.apply(lambda x: str(x)[4:] if x and len(str(x)) > 4 else '')  # å–ç¬¬ä¸€åˆ—é™¤å»å‰å››ä½

        # éå†æ¯è¡Œæ•°æ®ï¼Œå°†æ•°æ®æŒ‰ç¬¬ä¸‰åˆ—çš„å€¼åˆ†ç±»
        for value, category in zip(cleaned_values, third_col):
            if value:  # ç¡®ä¿å€¼éç©º
                if category == 61:
                    list61.append(value)
                elif category == 62:
                    list62.append(value)
                elif category == 63:
                    list63.append(value)
    update_output_text(output_text, f"list61:{list61}\n\n")
    update_output_text(output_text, f"list62:{list62}\n\n")
    update_output_text(output_text, f"list63:{list63}\n\n")
    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)
    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    output_data = []
    target_url = "https://www.netchb.com/app/inbond/viewInbondEntries.do"
    driver.get(target_url)
    # éå†æ¯ä¸ªè®°å½•å¹¶æ ‡è®°å…ƒç´ ç¼–å·
    for idx, (record, select_value) in enumerate(
            [(r, '61') for r in list61] + [(r, '62') for r in list62] + [(r, '63') for r in list63], 1):
        # è®¿é—®ç›®æ ‡é¡µé¢
        driver.get(target_url)

        # å¡«å†™ ES å•å·
        es_no_xpath = '//*[@id="esNo"]'
        es_no_input = driver.find_element(By.XPATH, es_no_xpath)
        es_no_input.clear()
        es_no_input.send_keys(record)

        # é€‰æ‹© Inbond ç±»å‹
        select_xpath = '//*[@id="ibTy"]'
        select_element = driver.find_element(By.XPATH, select_xpath)
        select_dropdown = Select(select_element)
        select_dropdown.select_by_value(select_value)

        # é€‰æ‹©ç”¨æˆ·ï¼ˆæ‰€æœ‰ç”¨æˆ·ï¼‰
        user_xpath = '//*[@id="usr"]'
        user_select = driver.find_element(By.XPATH, user_xpath)
        user_dropdown = Select(user_select)
        user_dropdown.select_by_value("")

        # è®¾ç½®æ¯é¡µæ˜¾ç¤º 100 æ¡æ•°æ®
        no_per_page_xpath = '//*[@id="nop"]'
        no_per_page_select = driver.find_element(By.XPATH, no_per_page_xpath)
        no_per_page_dropdown = Select(no_per_page_select)
        no_per_page_dropdown.select_by_value('100')

        # æäº¤è¡¨å•
        submit_button_xpath = '//*[@id="inbondEntriesForm"]/div[1]/div[2]/table/tbody/tr[7]/td[5]/input'
        submit_button = driver.find_element(By.XPATH, submit_button_xpath)
        submit_button.click()

        # ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
        WebDriverWait(driver, 200).until(
            lambda driver: driver.execute_script('return document.readyState') == 'complete'
        )
        time.sleep(0.5)

        # è·å–è¡¨æ ¼æ•°æ®
        table_xpath = '//*[@id="inbondEntriesForm"]/div[2]/table/tbody'
        rows = driver.find_elements(By.XPATH, table_xpath + '/tr')

        for row in rows[1:]:  # è·³è¿‡æ ‡é¢˜è¡Œï¼Œä»ç¬¬äºŒè¡Œå¼€å§‹
            try:
                col_1 = row.find_element(By.XPATH, './td[1]/a').text  # ç¬¬ä¸€åˆ—ï¼ˆå¸¦é“¾æ¥ï¼‰
            except:
                col_1 = row.find_element(By.XPATH, './td[1]').text  # å¤‡ç”¨æ–¹æ¡ˆï¼Œæ— é“¾æ¥æ—¶å–æ™®é€šæ–‡æœ¬

            col_2 = row.find_element(By.XPATH, './td[2]').text  # ç¬¬äºŒåˆ—
            col_3 = row.find_element(By.XPATH, './td[3]').text  # ç¬¬ä¸‰åˆ—
            col_6 = row.find_element(By.XPATH, './td[6]').text  # ç¬¬å…­åˆ—
            col_10 = row.find_element(By.XPATH, './td[10]').text  # ç¬¬ååˆ—
            col_11 = row.find_element(By.XPATH, './td[11]').text  # ç¬¬åä¸€åˆ—

            # å°†å…ƒç´ ç¼–å·æ·»åŠ åˆ° G åˆ—
            output_data.append([col_1, col_2, col_3, col_6, col_10, col_11, idx])  # æ·»åŠ å…ƒç´ ç¼–å·ä½œä¸º G åˆ—æ•°æ®

    # é€€å‡ºæµè§ˆå™¨
    driver.quit()

    # å°†æ•°æ®å†™å…¥ Excel
    df_output = pd.DataFrame(output_data,
                             columns=["inbond", "type", "masterbill", "port", "status", "arrive/export", "index"])
    df_output.to_excel(file_path2, index=False)

    wb = load_workbook(file_path2)
    ws = wb.active  # é»˜è®¤è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨

    # é¢œè‰²å¡«å……æ ·å¼
    green_fill = PatternFill(start_color="00FF00", end_color="00FF00", fill_type="solid")  # ç»¿è‰² (ACP)
    red_fill = PatternFill(start_color="FF0000", end_color="FF0000", fill_type="solid")  # çº¢è‰² (REJ)
    light_blue_fill = PatternFill(start_color="87CEFA", end_color="87CEFA", fill_type="solid")  # æµ…è“è‰² (INP)
    yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")  # é»„è‰² (TRN)

    # éå† E åˆ—
    for row in ws.iter_rows(min_row=1, max_row=ws.max_row, min_col=5, max_col=5):  # Eåˆ—æ˜¯ç¬¬5åˆ—
        cell = row[0]
        if cell.value == "ACP":
            cell.fill = green_fill
        elif cell.value == "REJ":
            cell.fill = red_fill
        elif cell.value == "INP":
            cell.fill = light_blue_fill
        elif cell.value == "TRN":
            cell.fill = yellow_fill

    # ä¿å­˜æ–‡ä»¶
    wb.save(file_path2)
    wb.close()

    # ç­‰å¾…ç”¨æˆ·è¾“å…¥åå…³é—­æµè§ˆå™¨
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


def rejectfix_program(account, password, output_text):
    from seleniumwire import webdriver
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    def get_code(account, password):
        data_dict = {}

        user_home = os.path.expanduser("~")
        possible_paths = [
            os.path.join(user_home, "Desktop"),
            os.path.join(user_home, "æ¡Œé¢"),
            os.path.join(user_home, "OneDrive", "Desktop"),
            os.path.join(user_home, "OneDrive", "æ¡Œé¢")
        ]

        desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

        if desktop_path:
            file_path = os.path.join(desktop_path, "BBCreview.xlsx")
            if os.path.exists(file_path):
                update_output_text(output_text, "å·²æ‰¾åˆ°BBCreview\n")
                pass
            else:
                # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
                wb = Workbook()
                wb.save(file_path)
                update_output_text(output_text, "å·²åˆ›å»ºBBCreviewï¼Œå†æ¬¡è¿è¡Œå³å¯å¼€å§‹ä»£ç \n")
                sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
        else:
            update_output_text(output_text, "åˆ›å»ºexcelå¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

        # å›ºå®šè·¯å¾„ï¼šAppData\Local
        fixed_path = os.path.join(user_home, "AppData", "Local")
        txt_file_path = os.path.join(fixed_path, "origincode.txt")

        if not os.path.exists(txt_file_path):
            try:
                with open(txt_file_path, 'w', encoding='utf-8') as f:
                    pass  # åˆ›å»ºç©ºæ–‡ä»¶
                update_output_text(output_text, 'å·²åŒ¹é…è‡³larryæœ¬åœ°æœåŠ¡å™¨, è¯·å†ç‚¹å‡»ä¸€æ¬¡è¿è¡Œä»¥è¿è¡Œ\n')
                sys.exit()
            except Exception as e:
                update_output_text(output_text, 'è¿æ¥å¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n')
                sys.exit()
        else:
            update_output_text(output_text, 'æ­£åœ¨åƒlarryæœåŠ¡å™¨ä¼ é€å†…å®¹ï¼Œå¼€å§‹ä»£ç \n')
            time.sleep(5)
            update_output_text(output_text, 'å·²è¿æ¥larryæœ¬åœ°æœåŠ¡å™¨ï¼Œå¼€å§‹ä»£ç \n')

        chrome_options = webdriver.ChromeOptions()
        chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
        chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
        chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
        chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
        chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
        chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

        # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
        driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
        driver.set_window_size(1920, 1080)

        # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
        driver.get("https://www.google.com")
        driver.execute_script("document.body.style.zoom='50%'")
        url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
        driver.get(url)
        driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

        all_tabs = driver.window_handles
        all_tabs = driver.window_handles

        # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
        for tab in all_tabs:
            driver.switch_to.window(tab)
            if "data:" in driver.current_url:
                driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

        # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
        all_tabs = driver.window_handles

        # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
        if all_tabs:
            driver.switch_to.window(all_tabs[0])

        try:
            # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
            WebDriverWait(driver, 10).until(
                lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
            )
            print("'sign' found in page source. Continuing...")
        except Exception as e:
            print("Timeout or error while waiting for 'sign':", e)
            driver.quit()
            exit()

        # è¾“å…¥è´¦å·å’Œå¯†ç 
        username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
        password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

        # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
        username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
        username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
        username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

        # è¾“å…¥å¯†ç 
        password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
        password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
        password_field.send_keys(password)  # è¾“å…¥å¯†ç 

        # ç‚¹å‡»ç™»å½•æŒ‰é’®
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
        login_button.click()
        print("Current page title is:", driver.title)
        WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

        try:
            # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()

            # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
            try:
                logout_button = WebDriverWait(driver, 10).until(
                    EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
                )
                logout_button.click()
                print("Clicked the logout button in the alert.")

                # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
                WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
                )
                time.sleep(2)
                username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
                username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
                username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

                # è¾“å…¥å¯†ç 
                password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
                password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
                password_field.send_keys(password)  # è¾“å…¥å¯†ç 
                # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
                login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
                login_button.click()
                print("Clicked the login button.")

            except TimeoutException:
                print("No alert appeared, proceeding with the login.")

            # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
            WebDriverWait(driver, 10).until(
                EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
            )
            print("Login successful. Page title is:", driver.title)

        except (TimeoutException, NoSuchElementException) as e:
            print(f"Error occurred during login: {e}")
        outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
        driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
        step_status = True

        def check_alert(driver):
            try:
                time.sleep(1)
                alert = driver.switch_to.alert
                alert_text = alert.text
                print("å¼¹çª—å†…å®¹:", alert_text)

                if "cotton" not in alert_text.lower():
                    alert.accept()
                    print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
                else:
                    alert.dismiss()
                    print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

                time.sleep(1)
            except NoAlertPresentException:
                pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

        def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
            end_time = time.time() + timeout
            while time.time() < end_time:
                try:
                    # æŸ¥æ‰¾é®ç½©å±‚
                    blocking_elements = driver.find_elements(By.CSS_SELECTOR, ".blockUI.blockOverlay")
                    if not blocking_elements:
                        print("âœ… é˜»æŒ¡å…ƒç´ æ¶ˆå¤±ï¼Œç»§ç»­æ“ä½œ")
                        return
                    print("â³ æ£€æµ‹åˆ°é®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                    time.sleep(check_interval)
                except UnexpectedAlertPresentException:

                    try:
                        alert = driver.switch_to.alert
                        print("âš ï¸ æ£€æµ‹åˆ° alert å¼¹çª—ï¼š", alert.text)
                        alert.accept()
                        print("âœ… å·²ç‚¹å‡»ç¡®è®¤å…³é—­ alert")
                        time.sleep(1)
                    except NoAlertPresentException:
                        print("âŒ æƒ³å¤„ç† alertï¼Œä½†æ‰¾ä¸åˆ°")
                    continue
                except Exception as e:
                    print(f"âš ï¸ æ£€æµ‹é®ç½©å±‚æ—¶å‡ºç°é”™è¯¯: {e}")
                    time.sleep(check_interval)
                    continue

        def open_entry(driver):
            try:
                driver.switch_to.default_content()
                print("âœ… å·²è¿”å›ä¸»é¡µé¢")
            except Exception as e:
                print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")

            try:
                # æ£€æŸ¥ iframe
                iframes = driver.find_elements(By.TAG_NAME, "iframe")
                print(f"ğŸ” æ£€æµ‹åˆ° {len(iframes)} ä¸ª iframe")
                iframe_switched = False
                if iframes:
                    for i, iframe in enumerate(iframes):
                        try:
                            driver.switch_to.frame(iframe)
                            print(f"âœ… åˆ‡æ¢åˆ° iframe {i}")
                            driver.find_element(By.XPATH,
                                                "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]")
                            print("âœ… æ‚¬åœå…ƒç´ åœ¨ iframe ä¸­")
                            iframe_switched = True
                            break
                        except:
                            driver.switch_to.default_content()
                            print(f"âŒ iframe {i} ä¸­æ— ç›®æ ‡å…ƒç´ ï¼Œåˆ‡æ¢å›ä¸»é¡µé¢")
                else:
                    print("âœ… æ—  iframe")

                # å®šä½æ‚¬åœå…ƒç´ å¹¶æå– <td> çš„ id
                img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
                print(f"ğŸ” å°è¯•å®šä½æ‚¬åœå…ƒç´ : {img_xpath}")
                img_elements = driver.find_elements(By.XPATH, img_xpath)
                print(f"ğŸ” æ‰¾åˆ° {len(img_elements)} ä¸ªæ‚¬åœå…ƒç´ ")
                if len(img_elements) > 1:
                    print("âš ï¸ è­¦å‘Š: æ‚¬åœ XPath åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯")
                    for i, elem in enumerate(img_elements):
                        print(f"ğŸ” æ‚¬åœå…ƒç´  {i}: {elem.get_attribute('outerHTML')}")
                img_element = img_elements[0] if img_elements else driver.find_element(By.XPATH, img_xpath)
                print(f"âœ… æ‚¬åœå…ƒç´ : {img_element.get_attribute('outerHTML')}")

                # è·å–çˆ¶ <td> çš„ id
                td_element = img_element.find_element(By.XPATH, "./ancestor::td[contains(@id, 'EntrySummary')]")
                td_id = td_element.get_attribute("id")
                print(f"âœ… æ‰¾åˆ°çˆ¶ <td> id: {td_id}")

                # æ‚¬åœå¹¶ç­‰å¾…èœå•åŠ è½½
                ActionChains(driver).move_to_element(img_element).perform()
                print("âœ… å·²æ‰§è¡Œæ‚¬åœæ“ä½œ")
                try:
                    WebDriverWait(driver, 5).until(
                        EC.presence_of_element_located((By.XPATH, "//a[contains(@class,'shipment-row')]"))
                    )
                    print("âœ… èœå•å·²åŠ è½½")
                except TimeoutException:
                    print("âŒ èœå•æœªåŠ è½½ï¼Œå¯èƒ½æ‚¬åœå¤±è´¥")

                # æ£€æŸ¥å¼¹çª—
                def check_alert(driver):
                    try:
                        alert = driver.switch_to.alert
                        alert.accept()
                        print("âœ… å·²å…³é—­å¼¹çª—")
                    except:
                        print("âœ… æ— å¼¹çª—")

                check_alert(driver)

                # æ£€æŸ¥é«˜ z-index å…ƒç´ 
                overlays = driver.find_elements(By.XPATH,
                                                "//*[contains(@style, 'z-index') and not(contains(@style, 'z-index: 0'))]")
                print(f"ğŸ” æ£€æµ‹åˆ° {len(overlays)} ä¸ªé«˜ z-index å…ƒç´ ")
                for overlay in overlays[:3]:
                    print(f"ğŸ” è¦†ç›–å±‚: {overlay.get_attribute('outerHTML')}")

                # å®šä½ Edit æŒ‰é’®ï¼Œä½¿ç”¨çˆ¶ <td> çš„ id çº¦æŸ
                timeout = 10
                interval = 1
                start_time = time.time()
                edit_xpath = f"//td[@id='{td_id}']//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]"
                print(f"ğŸ” å°è¯•å®šä½ Edit æŒ‰é’®: {edit_xpath}")
                edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                print(f"ğŸ” æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                if len(edit_elements) > 1:
                    print("âš ï¸ è­¦å‘Š: Edit XPath ä»åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ")
                    for i, elem in enumerate(edit_elements):
                        print(f"ğŸ” Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")
                elif len(edit_elements) == 0:
                    print("âŒ Edit æŒ‰é’®æœªæ‰¾åˆ°ï¼ŒXPath å¯èƒ½é”™è¯¯æˆ–å…ƒç´ æœªåŠ è½½")
                    print(
                        "ğŸ” å°è¯•å¤‡ç”¨ XPath: //a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                    edit_elements = driver.find_elements(By.XPATH,
                                                         "//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                    print(f"ğŸ” å¤‡ç”¨ XPath æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                    for i, elem in enumerate(edit_elements):
                        print(f"ğŸ” å¤‡ç”¨ Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")

                while True:
                    try:
                        edit_img = WebDriverWait(driver, interval).until(
                            EC.element_to_be_clickable((By.XPATH, edit_xpath))
                        )
                        print(f"âœ… Edit æŒ‰é’®å®šä½æˆåŠŸ: {edit_img.get_attribute('outerHTML')}")
                        print(f"ğŸ” å…ƒç´ å¯è§: {edit_img.is_displayed()}, å…ƒç´ å¯ç‚¹å‡»: {edit_img.is_enabled()}")
                        try:
                            edit_img.click()
                            print("âœ… ç‚¹å‡» Edit æŒ‰é’®æˆåŠŸ")
                            break
                        except ElementClickInterceptedException as e:
                            print(f"âŒ ç‚¹å‡»è¢«æ‹¦æˆª: {e}")
                            print("ğŸ” å°è¯• JavaScript ç‚¹å‡»")
                            driver.execute_script("arguments[0].click();", edit_img)
                            print("âœ… ä½¿ç”¨ JavaScript ç‚¹å‡» Edit æŒ‰é’®")
                            break
                    except TimeoutException as e:
                        elapsed = time.time() - start_time
                        print(f"âŒ TimeoutException: {e}")
                        if elapsed >= timeout:
                            print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                            if edit_elements:
                                print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†ä¸å¯ç‚¹å‡»: {edit_elements[0].get_attribute('outerHTML')}")
                            else:
                                print("ğŸ” Edit æŒ‰é’®æœªåœ¨ DOM ä¸­æ‰¾åˆ°")
                            break
                        else:
                            print("âŒ å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                            time.sleep(interval)
                    except ElementClickInterceptedException as e:
                        elapsed = time.time() - start_time
                        print(f"âŒ ElementClickInterceptedException: {e}")
                        if elapsed >= timeout:
                            print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                            if edit_elements:
                                print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†è¢«é®æŒ¡: {edit_elements[0].get_attribute('outerHTML')}")
                            break
                        else:
                            print("âŒ å…ƒç´ è¢«æ‹¦æˆªï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                            time.sleep(interval)

                # åˆ‡æ¢å›ä¸»é¡µé¢
                if iframe_switched:
                    driver.switch_to.default_content()
                    print("âœ… åˆ‡æ¢å›ä¸»é¡µé¢")

            except Exception as e:
                print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
                print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                if edit_elements:
                    print(f"ğŸ” Edit æŒ‰é’®: {edit_elements[0].get_attribute('outerHTML')}")
                else:
                    print("ğŸ” Edit æŒ‰é’®æœªæ‰¾åˆ°")

        def search_entry_num(entry_number, timeout=5):
            driver.switch_to.default_content()

            wait_for_block_to_disappear(driver)
            start_time = time.time()
            while True:
                try:

                    find_element = WebDriverWait(driver, 10).until(
                        EC.visibility_of_element_located(
                            (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                    )
                    # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                    actions = ActionChains(driver)
                    actions.move_to_element(find_element).perform()
                    # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                    input_box = WebDriverWait(driver, 3).until(
                        EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                    )
                    input_box.clear()
                    input_box.send_keys(entry_number)

                    # å°è¯•ç‚¹å‡»æŒ‰é’®
                    search_button = WebDriverWait(driver, 3).until(
                        EC.element_to_be_clickable(
                            (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                    )
                    search_button.click()

                    break  # æˆåŠŸåè·³å‡ºå¾ªç¯

                except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                    if time.time() - start_time > timeout:
                        return "è¶…æ—¶"
                        break
                    else:
                        time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

        def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
            for attempt in range(retries):
                try:
                    check_alert(driver)
                    result = action()
                    check_alert(driver)
                    return result
                except Exception as e:
                    print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                    check_alert(driver)
                    if attempt < retries - 1:
                        time.sleep(retry_delay)
                    else:
                        print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                        return "tryfalse"

        def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
            import time
            from selenium.common.exceptions import NoSuchElementException
            from selenium.webdriver.common.by import By

            start_time = time.time()

            while time.time() - start_time < duration:
                try:
                    element = driver.find_element(By.XPATH, xpath)
                    if element.is_displayed():
                        print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                        time.sleep(1)
                        return True
                except NoSuchElementException:
                    print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

                time.sleep(interval)

            print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
            return False

        def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
            try:
                # æ¸…ç©ºå¹¶è¾“å…¥
                safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

                # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
                import time, re
                start_time = time.time()

                # æå– ul çš„ç´¢å¼•
                ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
                if not ul_pattern:
                    print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                    return

                base_index = int(ul_pattern.group(1))
                prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

                while time.time() - start_time < duration:
                    for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                        trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                        print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                        result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                            EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                         f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                        if result != "tryfalse":
                            print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                            return

                print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

            except Exception as e:
                print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
                check_alert(driver)

        def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

            try:
                safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            except Exception as e:
                # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
                print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

        def page_viewd(driver, entry_number):
            try:
                iframe = driver.find_element(By.ID, "iframeInvoices")
                driver.switch_to.frame(iframe)
            except:
                pass

            # ç‚¹å‡»å‰è®°å½•å½“å‰è¯·æ±‚æ•°é‡
            already_seen = set((r.id for r in driver.requests))

            # ç‚¹å‡» save
            safe_do(driver, lambda: WebDriverWait(driver, 60, 0.5).until(
                EC.element_to_be_clickable((By.XPATH,
                                            "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))
            ).click(), "ç‚¹å‡»saveæŒ‰é’®", retries=1, retry_delay=0.5)

            request_data = None
            max_wait_seconds = 30
            interval = 0.5
            elapsed = 0

            while elapsed < max_wait_seconds:
                for request in driver.requests:
                    if request.id in already_seen:
                        continue
                    if request.response:
                        if "SaveJSONV3" in request.url and request.method == 'POST':
                            payload = decode(request.body, request.headers.get('Content-Encoding', 'identity')).decode()
                            request_data = {
                                "url": request.url,
                                "cookie": request.headers.get("Cookie"),
                                "payload": payload,
                                "status_code": request.response.status_code
                            }
                            break
                if request_data:
                    break
                time.sleep(interval)
                elapsed += interval

            wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

            if request_data is None:
                update_output_text(output_text, f"{entry_number}ä¼ è¾“ä¿¡æ¯è‡³Larryçš„æœåŠ¡å™¨å¤±è´¥\n")
            else:
                update_output_text(output_text, f"{entry_number}æˆåŠŸä¼ è¾“ä¿¡æ¯è‡³Larryçš„æœåŠ¡å™¨\n")
                return request_data

        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        file_path = file_path
        df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

        # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
        a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

        # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
        filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()
        wait_for_block_to_disappear(driver, timeout=40, check_interval=1)
        all_data = {}

        for entry_number in filtered_lista:
            search_entry_num(entry_number, timeout=5)
            wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
            check_alert(driver)
            open_entry(driver)
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable(
                    (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                    "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

            data = page_viewd(driver, entry_number)
            if data:
                all_data[entry_number] = data
            else:
                all_data[entry_number] = None  # æˆ–è€…ä½ å¯ä»¥é€‰æ‹©è·³è¿‡
            try:
                driver.switch_to.default_content()
                print("æˆåŠŸåˆ‡æ¢å›æ¥")
            except Exception as e:
                print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
                pass
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable(
                    (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                    "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
            wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
            time.sleep(1)
        return all_data, txt_file_path

    def decode_and_save(encoded_data: str, save_path: str):
        """
        è§£ç  Base64+gzip å‹ç¼©çš„ JSON æ•°æ®å¹¶ä¿å­˜ä¸ºæ ¼å¼åŒ–çš„ txt/json æ–‡ä»¶
        """
        if not encoded_data.strip():
            print("âŒ encoded_data ä¸ºç©º")
            return

        try:
            # base64 è§£ç 
            decoded_bytes = base64.b64decode(encoded_data)

            # zlib è§£å‹ï¼ˆå¸¦ gzip å¤´ï¼‰
            decompressed_bytes = zlib.decompress(decoded_bytes, 16 + zlib.MAX_WBITS)

            # è½¬æˆå­—ç¬¦ä¸²
            json_str = decompressed_bytes.decode('utf-8')

            # è§£æä¸º dict
            data_dict = json.loads(json_str)

            # ä¿å­˜
            with open(save_path, "w", encoding="utf-8") as f:
                json.dump(data_dict, f, indent=2, ensure_ascii=False)

            print(f"âœ… è§£ç å®Œæˆï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ°: {save_path}")
        except Exception as e:
            print(f"âš ï¸ è§£ç å¤±è´¥: {e}")

    def extract_encoded_data(entry_number, data):
        """
        ä»å•æ¡ data ä¸­æå– encodedDataï¼Œå¸¦å¼‚å¸¸å¤„ç†å’Œæç¤ºã€‚
        è¿”å› encoded_data å­—ç¬¦ä¸²ï¼Œå¤±è´¥è¿”å› Noneã€‚
        """
        if data is None:
            print(f"{entry_number} æ— æ•°æ®ï¼Œè·³è¿‡")
            return None

        payload_str = data.get('payload')
        if not payload_str:
            print(f"{entry_number} payloadå­—æ®µä¸ºç©ºï¼Œè·³è¿‡")
            return None

        try:
            payload_json = json.loads(payload_str)
        except Exception as e:
            print(f"{entry_number} payloadè§£æå¤±è´¥: {e}")
            return None

        encoded_data = payload_json.get("encodedData")
        if not encoded_data:
            print(f"{entry_number} encodedDataå­—æ®µä¸å­˜åœ¨ï¼Œè·³è¿‡")
            return None

        return encoded_data

    def find_linenumbers_by_tariff(file_path, target_tariff_no):
        """
        ä»æŒ‡å®š JSON æ–‡ä»¶ä¸­ï¼ŒæŸ¥æ‰¾æ‰€æœ‰æœ€åä¸€ä¸ª TariffNo æˆ– TariffNumber ç­‰äº target_tariff_no çš„ LineNumberã€‚

        å‚æ•°ï¼š
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹æ˜¯ JSON æ ¼å¼ï¼‰
            target_tariff_no: è¦åŒ¹é…çš„ç¨å·å­—ç¬¦ä¸²

        è¿”å›ï¼š
            ç¬¦åˆæ¡ä»¶çš„ LineNumber åˆ—è¡¨ï¼Œæ‰¾ä¸åˆ°è¿”å›ç©ºåˆ—è¡¨
        """
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        def recursive_search(d, result):
            if isinstance(d, dict):
                if "LineNumber" in d and "Tariff" in d:
                    line_number = d["LineNumber"]
                    tariff = d.get("Tariff", [])
                    if isinstance(tariff, list) and tariff:
                        last_tariff = tariff[-1]
                        tariff_no = str(last_tariff.get("TariffNo") or last_tariff.get("TariffNumber") or "").strip()
                        if tariff_no == target_tariff_no:
                            result.append(line_number)
                for v in d.values():
                    recursive_search(v, result)
            elif isinstance(d, list):
                for item in d:
                    recursive_search(item, result)

        results = []
        recursive_search(data, results)
        return results

    def ep7(file_path, target_ln):
        """
        è¯»å– JSON æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å¯¹åº” LineNumberï¼Œå°† Tariff æœ€åä¸€ä¸ªå¯¹è±¡æ·»åŠ å›ºå®š PGAv21Recordsï¼Œ
        å¹¶ä¿å­˜å›æ–‡ä»¶ã€‚

        å‚æ•°:
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
            target_ln: ç›®æ ‡ LineNumberï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰

        è¿”å›:
            True ä¿®æ”¹æˆåŠŸï¼ŒFalse æœªæ‰¾åˆ°æˆ–å¤±è´¥
        """

        fixed_pgav21records_json = '''
            [
              {
                "EntityInfoObject": [],
                "NonPNData": false,
                "ActionCode": null,
                "PGOI": {
                  "ControlIdentifier": null,
                  "Filler": null,
                  "CommercialDescription": "Moisturizing Cream"
                },
                "PG01": {
                  "ControlIdentifier": null,
                  "RecordType": null,
                  "PGALineNumber": "001",
                  "GovernmentAgencyCode": "FDA",
                  "GovernmentAgencyProgramCode": "BIO",
                  "GovernmentAgencyProcessingCode": null,
                  "ElectronicImageSubmitted": null,
                  "ConfidentialInformationIndicator": null,
                  "GloballyUniqueProductIdentificationCodeQualifier": null,
                  "GloballyUniqueProductIdentificationCode": null,
                  "IntendedUseCode": null,
                  "IntendedUseDescription": null,
                  "Disclaimer": "A",
                  "PriorNoticeConfirmationNumber": null
                },
                "PG02": null,
                "PG04": [],
                "PG05": [],
                "PG06": [],
                "PG07": [],
                "PG08": [],
                "PG10": [],
                "PG13": [],
                "PG14": [],
                "PG17": [],
                "PG18": [],
                "PG19": null,
                "PG20": null,
                "PG21": [],
                "PG22": [],
                "PG23": [],
                "PG24": [],
                "PG25": [],
                "PG26": [],
                "PG27": [],
                "PG28": null,
                "PG29": null,
                "PG30": [],
                "PG31": [],
                "PG32": [],
                "PG33": null,
                "PG34": null,
                "PG35": null,
                "PG60": [],
                "PG50": null,
                "PG51": null,
                "PG55": null,
                "PG00": null,
                "TariffIndex": "3"
              },
              {
                "PG01": {
                  "PGALineNumber": "002",
                  "GovernmentAgencyCode": "EPA",
                  "IntendedUseCode": "",
                  "IntendedUseDescription": "",
                  "ConfidentialInformationIndicator": "",
                  "GloballyUniqueProductIdentificationCodeQualifier": "",
                  "GloballyUniqueProductIdentificationCode": "",
                  "PriorNoticeConfirmationNumber": "",
                  "GovernmentAgencyProgramCode": "TS1",
                  "GovernmentAgencyProcessingCode": "",
                  "Disclaimer": "A",
                  "ElectronicImageSubmitted": ""
                },
                "PGOI": {
                  "CommercialDescription": "Moisturizing Cream"
                },
                "PG24": [
                  {
                    "RemarksTypeCode": "",
                    "RemarksText": "",
                    "RemarksCode": ""
                  }
                ],
                "NonPNData": false,
                "PG07": [
                  {
                    "ControlIdentifier": 0,
                    "TradeNameorBrandName": "",
                    "ManufacturerMonthandYear": "",
                    "Model": "",
                    "ItemIdentityNumberQualifier": ""
                  }
                ],
                "EntityInfoObject": [],
                "ActionCode": "",
                "TariffIndex": "3"
              }
            ]
            '''
        fixed_pgav21records = json.loads(fixed_pgav21records_json)

        def recursive_update(d):
            if isinstance(d, dict):
                if "LineNumber" in d and str(d["LineNumber"]) == str(target_ln):
                    tariff = d.get("Tariff", [])
                    if isinstance(tariff, list) and tariff:
                        last_tariff = tariff[-1]
                        last_tariff["PGAv21Records"] = fixed_pgav21records
                        return True
                    else:
                        print(f"âš ï¸ æ‰¾åˆ° LineNumber={target_ln}ï¼Œä½† Tariff åˆ—è¡¨ä¸ºç©ºã€‚")
                        return False
                for v in d.values():
                    if recursive_update(v):
                        return True
            elif isinstance(d, list):
                for item in d:
                    if recursive_update(item):
                        return True
            return False

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        except Exception as e:
            print(f"è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return False

        modified = recursive_update(data)

        if not modified:
            return False

        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
            return False

        return True

    def al8205_update(file_path, target_ln):
        """
        è¯»å– JSON æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å¯¹åº” LineNumberï¼Œå°† Tariff æœ€åä¸€ä¸ªå¯¹è±¡æ·»åŠ å›ºå®š PGAv21Recordsï¼Œ
        å¹¶ä¿å­˜å›æ–‡ä»¶ã€‚

        å‚æ•°:
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
            target_ln: ç›®æ ‡ LineNumberï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰

        è¿”å›:
            True ä¿®æ”¹æˆåŠŸï¼ŒFalse æœªæ‰¾åˆ°æˆ–å¤±è´¥
        """

        fixed_pgav21records_json = '''
        [
          {
            "EntityInfoObject": [],
            "NonPNData": false,
            "ActionCode": null,
            "PGOI": {
              "ControlIdentifier": null,
              "Filler": null,
              "CommercialDescription": "bottle opener"
            },
            "PG01": {
              "ControlIdentifier": null,
              "RecordType": null,
              "PGALineNumber": "001",
              "GovernmentAgencyCode": "FDA",
              "GovernmentAgencyProgramCode": "BIO",
              "GovernmentAgencyProcessingCode": null,
              "ElectronicImageSubmitted": null,
              "ConfidentialInformationIndicator": null,
              "GloballyUniqueProductIdentificationCodeQualifier": null,
              "GloballyUniqueProductIdentificationCode": null,
              "IntendedUseCode": null,
              "IntendedUseDescription": null,
              "Disclaimer": "A",
              "PriorNoticeConfirmationNumber": null
            },
            "PG02": null,
            "PG04": [],
            "PG05": [],
            "PG06": [],
            "PG07": [],
            "PG08": [],
            "PG10": [],
            "PG13": [],
            "PG14": [],
            "PG17": [],
            "PG18": [],
            "PG19": null,
            "PG20": null,
            "PG21": [],
            "PG22": [],
            "PG23": [],
            "PG24": [],
            "PG25": [],
            "PG26": [],
            "PG27": [],
            "PG28": null,
            "PG29": null,
            "PG30": [],
            "PG31": [],
            "PG32": [],
            "PG33": null,
            "PG34": null,
            "PG35": null,
            "PG60": [],
            "PG50": null,
            "PG51": null,
            "PG55": null,
            "PG00": null
          },
          {
            "EntityInfoObject": [],
            "NonPNData": false,
            "ActionCode": "",
            "PGOI": {
              "ControlIdentifier": null,
              "Filler": null,
              "CommercialDescription": "bottle opener"
            },
            "PG01": {
              "ControlIdentifier": null,
              "RecordType": null,
              "PGALineNumber": "002",
              "GovernmentAgencyCode": "APH",
              "GovernmentAgencyProgramCode": "APL",
              "GovernmentAgencyProcessingCode": "",
              "ElectronicImageSubmitted": "",
              "ConfidentialInformationIndicator": "",
              "GloballyUniqueProductIdentificationCodeQualifier": "",
              "GloballyUniqueProductIdentificationCode": "",
              "IntendedUseCode": "",
              "IntendedUseDescription": "",
              "Disclaimer": "A",
              "PriorNoticeConfirmationNumber": ""
            },
            "PG02": null,
            "PG04": [],
            "PG05": [],
            "PG06": [],
            "PG07": [
              {
                "ControlIdentifier": "0",
                "RecordType": null,
                "TradeNameorBrandName": "",
                "Model": "",
                "ManufacturerMonthandYear": "",
                "ItemIdentityNumberQualifier": "",
                "ItemIdentityNumber": null
              }
            ],
            "PG08": [],
            "PG10": [],
            "PG13": [],
            "PG14": [],
            "PG17": [],
            "PG18": [],
            "PG19": null,
            "PG20": null,
            "PG21": [],
            "PG22": [],
            "PG23": [],
            "PG24": [
              {
                "ControlIdentifier": null,
                "RecordType": null,
                "RemarksTypeCode": "",
                "RemarksCode": "",
                "RemarksText": ""
              }
            ],
            "PG25": [],
            "PG26": [],
            "PG27": [],
            "PG28": null,
            "PG29": null,
            "PG30": [],
            "PG31": [],
            "PG32": [],
            "PG33": null,
            "PG34": null,
            "PG35": null,
            "PG60": [],
            "PG50": null,
            "PG51": null,
            "PG55": null,
            "PG00": null
          }
        ]
            '''
        fixed_pgav21records = json.loads(fixed_pgav21records_json)

        def recursive_update(d):
            if isinstance(d, dict):
                if "LineNumber" in d and str(d["LineNumber"]) == str(target_ln):
                    tariff = d.get("Tariff", [])
                    if isinstance(tariff, list) and tariff:
                        last_tariff = tariff[-1]
                        last_tariff["PGAv21Records"] = fixed_pgav21records
                        return True
                    else:
                        print(f"âš ï¸ æ‰¾åˆ° LineNumber={target_ln}ï¼Œä½† Tariff åˆ—è¡¨ä¸ºç©ºã€‚")
                        return False
                for v in d.values():
                    if recursive_update(v):
                        return True
            elif isinstance(d, list):
                for item in d:
                    if recursive_update(item):
                        return True
            return False

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        except Exception as e:
            print(f"è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return False

        modified = recursive_update(data)

        if not modified:
            return False

        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
            return False

        return True

    def al8214_update(file_path, target_ln):
        """
        è¯»å– JSON æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å¯¹åº” LineNumberï¼Œå°† Tariff æœ€åä¸€ä¸ªå¯¹è±¡æ·»åŠ å›ºå®š PGAv21Recordsï¼Œ
        å¹¶ä¿å­˜å›æ–‡ä»¶ã€‚

        å‚æ•°:
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
            target_ln: ç›®æ ‡ LineNumberï¼ˆå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰

        è¿”å›:
            True ä¿®æ”¹æˆåŠŸï¼ŒFalse æœªæ‰¾åˆ°æˆ–å¤±è´¥
        """

        fixed_pgav21records_json = '''[
          {
            "EntityInfoObject": [],
            "NonPNData": false,
            "ActionCode": "",
            "PGOI": {
              "ControlIdentifier": null,
              "Filler": null,
              "CommercialDescription": "Pencil sharpener"
            },
            "PG01": {
              "ControlIdentifier": null,
              "RecordType": null,
              "PGALineNumber": "001",
              "GovernmentAgencyCode": "APH",
              "GovernmentAgencyProgramCode": "APL",
              "GovernmentAgencyProcessingCode": "",
              "ElectronicImageSubmitted": "",
              "ConfidentialInformationIndicator": "",
              "GloballyUniqueProductIdentificationCodeQualifier": "",
              "GloballyUniqueProductIdentificationCode": "",
              "IntendedUseCode": "",
              "IntendedUseDescription": "",
              "Disclaimer": "A",
              "PriorNoticeConfirmationNumber": ""
            },
            "PG02": null,
            "PG04": [],
            "PG05": [],
            "PG06": [],
            "PG07": [
              {
                "ControlIdentifier": "0",
                "RecordType": null,
                "TradeNameorBrandName": "",
                "Model": "",
                "ManufacturerMonthandYear": "",
                "ItemIdentityNumberQualifier": "",
                "ItemIdentityNumber": null
              }
            ],
            "PG08": [],
            "PG10": [],
            "PG13": [],
            "PG14": [],
            "PG17": [],
            "PG18": [],
            "PG19": null,
            "PG20": null,
            "PG21": [],
            "PG22": [],
            "PG23": [],
            "PG24": [
              {
                "ControlIdentifier": null,
                "RecordType": null,
                "RemarksTypeCode": "",
                "RemarksCode": "",
                "RemarksText": ""
              }
            ],
            "PG25": [],
            "PG26": [],
            "PG27": [],
            "PG28": null,
            "PG29": null,
            "PG30": [],
            "PG31": [],
            "PG32": [],
            "PG33": null,
            "PG34": null,
            "PG35": null,
            "PG60": [],
            "PG50": null,
            "PG51": null,
            "PG55": null,
            "PG00": null
          }
        ]'''
        fixed_pgav21records = json.loads(fixed_pgav21records_json)

        def recursive_update(d):
            if isinstance(d, dict):
                if "LineNumber" in d and str(d["LineNumber"]) == str(target_ln):
                    tariff = d.get("Tariff", [])
                    if isinstance(tariff, list) and tariff:
                        last_tariff = tariff[-1]
                        last_tariff["PGAv21Records"] = fixed_pgav21records
                        return True
                    else:
                        print(f"âš ï¸ æ‰¾åˆ° LineNumber={target_ln}ï¼Œä½† Tariff åˆ—è¡¨ä¸ºç©ºã€‚")
                        return False
                for v in d.values():
                    if recursive_update(v):
                        return True
            elif isinstance(d, list):
                for item in d:
                    if recursive_update(item):
                        return True
            return False

        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        except Exception as e:
            print(f"è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return False

        modified = recursive_update(data)

        if not modified:
            return False

        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
            return False

        return True

    def main_update(file_path):
        """
        ä¸»ç¨‹åºï¼š
        æŒ‰ç¨å·æŸ¥æ‰¾ LineNumber å¹¶åˆ†åˆ«è°ƒç”¨ä¸‰ä¸ªæ›´æ–°å‡½æ•°
        """
        # 1ï¸âƒ£ æŸ¥æ‰¾ä¸‰ä¸ªç¨å·å¯¹åº”çš„ line åˆ—è¡¨
        lines_8205 = find_linenumbers_by_tariff(file_path, '8205.51.3030')
        lines_3307 = find_linenumbers_by_tariff(file_path, '3307.90.0000')
        lines_8214 = find_linenumbers_by_tariff(file_path, '8214.10.0000')

        print(f"ğŸ” 8205.51.3030 çš„ LineNumber: {lines_8205}")
        print(f"ğŸ” 3307.90.0000 çš„ LineNumber: {lines_3307}")
        print(f"ğŸ” 8214.10.0000 çš„ LineNumber: {lines_8214}")
        update_output_text(output_text, f"ğŸ” AL1 çš„ LineNumber: {lines_8205}\n")
        update_output_text(output_text, f"ğŸ” EP7 çš„ LineNumber: {lines_3307}\n")
        update_output_text(output_text, f"ğŸ” AL1 çš„ LineNumber: {lines_8214}\n")
        # 2ï¸âƒ£ åˆ†åˆ«æ›´æ–°
        for ln in lines_8205:
            if al8205_update(file_path, ln):
                print(f"âœ… al8205_update: LineNumber={ln} æ›´æ–°æˆåŠŸ")
            else:
                print(f"âš ï¸ al8205_update: LineNumber={ln} æ›´æ–°å¤±è´¥")

        for ln in lines_3307:
            if ep7(file_path, ln):
                print(f"âœ… ep7: LineNumber={ln} æ›´æ–°æˆåŠŸ")
            else:
                print(f"âš ï¸ ep7: LineNumber={ln} æ›´æ–°å¤±è´¥")

        for ln in lines_8214:
            if al8214_update(file_path, ln):
                print(f"âœ… al8214_update: LineNumber={ln} æ›´æ–°æˆåŠŸ")
            else:
                print(f"âš ï¸ al8214_update: LineNumber={ln} æ›´æ–°å¤±è´¥")

    def encode_json_file(txt_path):
        # === ç¬¬1æ­¥ï¼šè¯»å– txt æ–‡ä»¶ ===
        with open(txt_path, 'r', encoding='utf-8') as f:
            json_str = f.read()

        # éªŒè¯æ˜¯åˆæ³• JSON
        json_obj = json.loads(json_str)

        # æ ¼å¼åŒ–æˆç´§å‡‘ JSON å­—ç¬¦ä¸²
        json_str = json.dumps(json_obj, separators=(',', ':'), ensure_ascii=False)

        # === ç¬¬2æ­¥ï¼šgzip å‹ç¼© + base64 ç¼–ç  ===
        compressed_bytes = gzip.compress(json_str.encode('utf-8'))
        encoded_data = base64.b64encode(compressed_bytes).decode('utf-8')

        return encoded_data

    def upload_encoded_data(
            encoded_data: str,
            importer_id: int,
            reference_number: str,
            cookie: str,
            url: str = "https://my.acelynknavigator.com/Desktop/Invoices/Default.aspx/SaveJSONV3"
    ):
        payload = {
            "encodedData": encoded_data,
            "fileType": "EntrySummary",
            "importerId": importer_id,
            "referenceNumber": reference_number
        }

        headers = {
            "Content-Type": "application/json; charset=UTF-8",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Origin": "https://my.acelynknavigator.com",
            "Referer": f"https://my.acelynknavigator.com/Desktop/Invoices/?t=EntrySummary&id={reference_number}",
            "User-Agent": "Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 CrKey/1.54.250320",
            "Cookie": cookie,
            "x-requested-with": "XMLHttpRequest"
        }

        response = requests.post(url, headers=headers, json=payload)

        return response.status_code, response.text

    def check_cookie_and_extract(entry_number, data):
        cookie = data.get("cookie")
        payload_str = data.get("payload")

        if not cookie or not cookie.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ cookieï¼Œè·³è¿‡")
            return None
        if not payload_str or not payload_str.strip():
            print(f"{entry_number} payload ä¸ºç©ºï¼Œè·³è¿‡")
            return None

        try:
            payload = json.loads(payload_str)
        except Exception as e:
            print(f"{entry_number} payload è§£æå¤±è´¥: {e}ï¼Œè·³è¿‡")
            return None

        importer_id = payload.get("importerId")
        reference_number = payload.get("referenceNumber")

        if not encoded_data or not encoded_data.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ encodedDataï¼Œè·³è¿‡")
            return None
        if not importer_id:
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ importer_idï¼Œè·³è¿‡")
            return None
        if not reference_number or not str(reference_number).strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ reference_numberï¼Œè·³è¿‡")
            return None

        return {
            "cookie": cookie,
            "importer_id": importer_id,
            "reference_number": reference_number,
        }

    all_data, txt_file_path = get_code(account, password)
    print(all_data)
    for entry_number, data in all_data.items():
        encoded_data = extract_encoded_data(entry_number, data)

        # å¦‚æœæ˜¯ None æˆ–è€…ç©ºå­—ç¬¦ä¸²ï¼Œè·³è¿‡
        if not encoded_data or not encoded_data.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ encoded_dataï¼Œè·³è¿‡")
            update_output_text(output_text, f"\nLarryæœåŠ¡å™¨æ— æ³•æˆåŠŸä¸Šä¼ æ­¤entry{entry_number}")
            continue

        decode_and_save(encoded_data, txt_file_path)
        main_update(txt_file_path)
        info = check_cookie_and_extract(entry_number, data)
        if info is None:
            update_output_text(output_text, f"\n{entry_number}ä¸Šä¼ å¤±è´¥")
            continue  # ä»»ä½•ä¸€ä¸ªä¿¡æ¯ç¼ºå¤±ï¼Œè·³è¿‡

        cookie = info['cookie']
        importer_id = info['importer_id']
        reference_number = info['reference_number']
        encoded_data = encode_json_file(txt_file_path)

        status, text = upload_encoded_data(encoded_data, importer_id, reference_number, cookie)
        if status == 200:
            update_output_text(output_text, f"\n{entry_number} å¤„ç†å®Œæˆ\n")
        else:
            update_output_text(output_text, f"\n{entry_number} å¤„ç†å¤±è´¥: {status}\n")

        print("çŠ¶æ€ç :", status)

        print(f"{entry_number} å¤„ç†å®Œæˆ\n")
    update_output_text(output_text, f"------------å…¨éƒ¨å¤„ç†å®Œæˆ-----------------------------------")


def query_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "customextract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    if desktop_path:
        output_path = os.path.join(desktop_path, "customoutput.xlsx")
        if os.path.exists(output_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{output_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(output_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{update_output_text}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    token = "eyJhbGciOiJIUzI1NiIsInR5cCI6ImFjY2VzcyJ9.eyJpYXQiOjE3NDQxNTU2MzEsImV4cCI6MTc3NTY5MTYzMSwiYXVkIjoiaHR0cHM6Ly95b3VyZG9tYWluLmNvbSIsImlzcyI6ImZlYXRoZXJzIiwic3ViIjoiNjc2MzA0NWJmYjUzZDM1NDc0ZTExZjQ2IiwianRpIjoiZDhlMmU3OWEtMWFjNC00YmNjLWFmNmItYTVkMTljZGFjODdiIn0.q5_Cp_wURZEz4fV6P1mySAbbj0PYC1acS3Fd4m7G3Dk"

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    mawb_list = df.iloc[0:, 0].tolist()
    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    update_output_text(output_text, f"æ‰€æœ‰å³å°†æå–çš„master: {mawb_list}\n\n\n")

    def createquery(token, mawb):
        url = "https://api.customscity.com/api/manifest-query"
        headers = {
            "accept": "application/json",
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        }
        data = {
            "type": "AWBNUMBER",
            "masterBOLNumber": mawb,
            "houseBOLNumber": "null",
            "limitOutputOption": "",
            "requestRelatedBOL": False,
            "requestBOLAndEntryInformation": False
        }
        response = requests.post(url, headers=headers, json=data, timeout=10)
        if response.status_code != 200:
            print("Response:", response.status_code, response.text)

    for mawb in mawb_list:
        createquery(token, mawb)

    def delete_first_row(output_path):
        try:
            # æ‰“å¼€ Excel æ–‡ä»¶
            wb = openpyxl.load_workbook(output_path)
            sheet = wb.active

            # åˆ é™¤ç¬¬ä¸€è¡Œ
            sheet.delete_rows(1)

            # ä¿å­˜ä¿®æ”¹åçš„ Excel æ–‡ä»¶
            wb.save(output_path)
        except Exception as e:
            print(f"åˆ é™¤ç¬¬ä¸€è¡Œæ—¶å‘ç”Ÿé”™è¯¯: {e}")

    # ç¤ºä¾‹è°ƒç”¨ï¼šåˆ é™¤æŒ‡å®šè·¯å¾„æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ
    delete_first_row(output_path)

    def clear_excel_file(output_path):
        try:
            # æ‰“å¼€ Excel æ–‡ä»¶
            wb = openpyxl.load_workbook(output_path)
            sheet = wb.active

            # æ¸…ç©ºæ‰€æœ‰æ•°æ®
            for row in sheet.iter_rows(min_row=1, max_row=sheet.max_row):
                for cell in row:
                    cell.value = None

            # åˆ é™¤ç©ºè¡Œ
            # é€šè¿‡åˆ¤æ–­æ¯è¡Œæ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®æ¥åˆ é™¤ç©ºè¡Œ
            for row in range(sheet.max_row, 1, -1):
                if all(cell.value is None for cell in sheet[row]):
                    sheet.delete_rows(row)

            # ä¿å­˜æ¸…ç©ºåçš„ Excel æ–‡ä»¶
            wb.save(output_path)
        except Exception as e:
            print(f"æ— æ³•æ¸…ç©º: {e}")

    def extract_and_update_excel(response_data, output_path, awbcode):
        try:
            first_record = response_data['data']['response'][0]

            if 'masterPartIndicator' in first_record and first_record['masterPartIndicator'] != '':
                print(f"{awbcode} æ˜¯åˆ†æ‰¹ï¼ï¼")

            wb = openpyxl.load_workbook(output_path)
            sheet = wb.active

            if sheet.max_row == 1:
                sheet.append(
                    ['Master BOL Number', 'Carrier Code', 'Vessel', 'Voyage/Flight No', 'Arrival Date', 'FIRMS',
                     '1D Count', '1H Count', '1A Count', '2H Count', '1I Count', '2I Count', '1C Count', '1B Count',
                     'House', 'port', 'qty',"1R Count","1X Count"])

            # æå–å­—æ®µï¼Œæ¯ä¸ªå­—æ®µéƒ½ try-except é˜²æ­¢æŠ¥é”™
            def safe_extract(label, func):
                try:
                    return func()
                except Exception as e:
                    print(f"âŒ æå–å­—æ®µ [{label}] æ—¶å‡ºé”™: {e}")
                    return "N/A"

            master_bol_number = safe_extract("master_bol_number", lambda: first_record.get('awbNumber', 'N/A'))
            carrier_code = safe_extract("carrier_code",
                                        lambda: first_record.get('houses', [{}])[0].get('importingCarrierCode', 'N/A'))
            vessel = safe_extract("vessel",
                                  lambda: first_record.get('importingVesselCodeOrImpConveyanceName', 'N/A').split()[0])
            voyage_flight_no = safe_extract("voyage_flight_no",
                                            lambda: first_record.get('houses', [{}])[0].get('flightNumber', 'N/A'))
            arrival_date = safe_extract("arrival_date",
                                        lambda: response_data.get('data', {}).get('response', [{}])[0].get(
                                            'wr1DateOfArrival', 'N/A'))
            firms = safe_extract("firms", lambda: first_record.get('firmsCode', 'N/A'))
            hawb_number = safe_extract("hawb_number",
                                       lambda: first_record.get('houses', [{}])[0].get('hawbNumber', 'N/A'))
            actual_port_of_unlading = safe_extract("actual_port_of_unlading",
                                                   lambda: first_record.get('manifestedPortOfUnlading', 'N/A'))
            qty = safe_extract("qty", lambda: first_record.get('houses', [{}])[0].get('manifestQty', 'N/A'))

            # ç»Ÿè®¡ dispositionCode
            disposition_codes = ['1D', '1H', '1A', '2H', '1I', '2I', '1B',"1R","1X"]
            all_disp_codes = []

            for house in first_record.get('houses', []):
                awb_number = house.get('awbNumber', 'N/A')
                disposition_msg = house.get('dispositionMsg', [])
                for disp in disposition_msg:
                    try:
                        code = disp['dispositionCode']
                        if code in ['1H', '1A', '2H', '1I', '2I', '1B']:
                            update_output_text(output_text, f"{awb_number} {house.get('hawbNumber', 'N/A')} {code}\n")
                        all_disp_codes.append(code)
                    except Exception as e:
                        print(f"âš ï¸ dispositionMsg é”™è¯¯: {e}")

            code_counts = Counter(all_disp_codes)
            count_1d = code_counts.get('1D', 0)
            count_1h = code_counts.get('1H', 0)
            count_1a = code_counts.get('1A', 0)
            count_2h = code_counts.get('2H', 0)
            count_1i = code_counts.get('1I', 0)
            count_2i = code_counts.get('2I', 0)
            count_1c = code_counts.get('1C', 0)
            count_1B = code_counts.get('1B', 0)
            count_1r = code_counts.get('1R', 0)
            count_1x = code_counts.get('1X', 0)


            qty = count_1h + count_2h + count_1a - count_1i - count_2i - count_1B
            # å†™å…¥ Excel
            sheet.append([
                master_bol_number, carrier_code, vessel, voyage_flight_no, arrival_date, firms,
                count_1d, count_1h, count_1a, count_2h, count_1i, count_2i, count_1c,
                count_1B, hawb_number, actual_port_of_unlading, qty,count_1r,count_1x
            ])

            red_fill = PatternFill(start_color="FF9999", end_color="FF9999", fill_type="solid")
            green_fill = PatternFill(start_color="99FF99", end_color="99FF99", fill_type="solid")

            row_idx = sheet.max_row  # è·å–åˆšå†™å…¥çš„è¡Œå·
            qty_cell = sheet.cell(row=row_idx, column=17)  # QTY åˆ—åœ¨ç¬¬17åˆ—

            if qty != 0:
                qty_cell.fill = red_fill
            else:
                qty_cell.fill = green_fill
            wb.save(output_path)

        except Exception as e:
            awb = first_record.get('awbNumber', 'æœªçŸ¥AWB') if 'first_record' in locals() else awbcode
            print(f"âŒ æå–ä¿¡æ¯ [{awb}] æ—¶æ€»é”™è¯¯: {e}")

    def checkstatus(token, awbcode, output_path):
        url = "https://api.customscity.com/api/ManifestQueryLatestResponse"
        params = {"type": "AWBNUMBER", "masterBOLNumber": awbcode}
        headers = {"accept": "application/json", "Authorization": "Bearer " + token}
        max_retries = 10
        for attempt in range(max_retries):
            try:
                response = requests.get(url, headers=headers, params=params)

                if response.status_code == 200:
                    response_data = response.json()
                    if "message" in response_data and response_data["message"] == "No response yet":
                        time.sleep(5)
                        continue
                    extract_and_update_excel(response_data, output_path, awbcode)
                    print(response_data)
                    return response_data
                else:
                    time.sleep(5)
            except requests.exceptions.RequestException as e:
                time.sleep(5)
        print(f"Max retries reached for AWB {awbcode}. Unable to get a valid response.")
        return None

    # ç¤ºä¾‹è°ƒç”¨ï¼šè¯·ç¡®ä¿ `mawb_list` å’Œ `output_path` å·²å®šä¹‰
    clear_excel_file(output_path)
    for mawb in mawb_list:
        checkstatus(token, mawb, output_path)
    update_output_text(output_text, "æ“ä½œå·²å®Œæˆè¯·æ£€æŸ¥masteræ•°é‡\n\n")


def QP_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰è¦å¤„ç†çš„inbond: {filtered_list}\n\n\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={'054294590'}"
    # æ‰“å¼€é¡µé¢
    driver.get(target_url)
    # éå† filtered_list ä¸­çš„æ¯ä¸ªé¡¹ç›®
    for item in filtered_list:
        if windowname != "task":
            print("çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚")  # è°ƒè¯•æ‰“å°
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n\n\n")
            sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº
        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        # æ‰“å¼€é¡µé¢
        driver.get(target_url)

        current_title = driver.title
        update_output_text(output_text, f"æ­£åœ¨å¤„ç†{item}\n")

        try:
            # æŸ¥æ‰¾ç‰¹å®šçš„å…ƒç´ ï¼Œå¢åŠ æœ€é•¿ç­‰å¾…æ—¶é—´
            element_xpath = '/html/body/table/tbody/tr[2]/td[1]/table[4]/tbody/tr[1]/td[2]/a'
            # ç­‰å¾…æœ€å¤š 50 ç§’ï¼Œç›´åˆ°å…ƒç´ å¯ç‚¹å‡»
            element = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, element_xpath))
            )

            # å¦‚æœå…ƒç´ å­˜åœ¨å¹¶ä¸”å¯ç‚¹å‡»ï¼Œç‚¹å‡»å®ƒ
            element.click()

        except Exception as e:
            # å¦‚æœå…ƒç´ æœªæ‰¾åˆ°æˆ–ä¸å¯ç‚¹å‡»ï¼Œæ‰“å°æ¶ˆæ¯
            update_output_text(output_text, f"åœ¨å¤„ç† {item}æ—¶å‡ºç°é—®é¢˜ï¼é”™è¯¯: {e}\n")

    # ç­‰å¾…ç”¨æˆ·è¾“å…¥åå…³é—­æµè§ˆå™¨
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


import os
import msoffcrypto
import pandas as pd
from datetime import datetime

def line_extract(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # Step 2 â€” æ‰¾æ¡Œé¢è·¯å¾„
    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)
    if not desktop_path:
        update_output_text(output_text, "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()

    folder_path = os.path.join(desktop_path, "Line extract")
    if not os.path.exists(folder_path):
        os.makedirs(folder_path)
        update_output_text(output_text, f"âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¤¹ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼š{folder_path}\n\n")
        sys.exit()

    # Step 3 â€” æ‰¾æ–‡ä»¶
    excel_files = [f for f in os.listdir(folder_path) if f.lower().endswith(('.xls', '.xlsx')) and not f.startswith('~$')]
    packing_list_file = None
    invoice_file = None
    for file in excel_files:
        if "packing list" in file.lower():
            packing_list_file = file
        elif "invoice" in file.lower():
            invoice_file = file

    if not packing_list_file or not invoice_file:
        update_output_text(output_text, "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶ï¼Œç¨‹åºé€€å‡º\n")
        exit()

    packing_list_passwords = ["4!vCwY65@8", "bC_72=ukwG", "Gcp76!Ch3Y", "A&$*yv#3m5"]

    def try_decrypt(file_path, passwords):
        decrypted_file_path = file_path + ".decrypted.xlsx"
        success = False
        for pwd in passwords:
            try:
                with open(file_path, "rb") as f:
                    doc = msoffcrypto.OfficeFile(f)
                    doc.load_key(pwd)
                    with open(decrypted_file_path, "wb") as decrypted_file:
                        doc.decrypt(decrypted_file)
                update_output_text(output_text, f"âœ… ä½¿ç”¨å¯†ç  '{pwd}' è§£å¯†æˆåŠŸï¼š{os.path.basename(file_path)}\n")
                success = True
                break
            except Exception as e:
                update_output_text(output_text, f"âŒ ä½¿ç”¨å¯†ç  '{pwd}' å¤±è´¥: {e}\n")
        return decrypted_file_path if success else None

    # è§£å¯† packing list
    packing_list_path = os.path.join(folder_path, packing_list_file)
    decrypted_packing_list = try_decrypt(packing_list_path, packing_list_passwords)
    if not decrypted_packing_list:
        update_output_text(output_text, "âŒ Packing list æ— æ³•è§£å¯†\n")
        exit()

    df_packing = pd.read_excel(decrypted_packing_list, header=8)  # ç¬¬9è¡Œheader
    aa_column = df_packing.iloc[:, 26].astype(str)  # AAåˆ—
    ab_column = df_packing.iloc[:, 27].astype(str)  # ABåˆ—

    # è¯»å– df (BBCreview.xlsx ç¬¬ä¸€åˆ—)
    df_file = os.path.join(desktop_path, "BBCreview.xlsx")
    df = pd.read_excel(df_file, header=None, dtype=str)
    
    first_column_list = df.iloc[:, 0].dropna().tolist()
    
    # ç”¨äºè®°å½•è¡¥äº†0çš„å€¼
    padded_values = []
    
    # å¤„ç†æ¯ä¸ªå€¼ï¼Œä¸è¶³12ä½å‰é¢è¡¥0
    for i in range(len(first_column_list)):
        original = first_column_list[i]
        if len(original) < 12:
            first_column_list[i] = original.zfill(12)
            padded_values.append(first_column_list[i])
    
    # è¾“å‡ºå¤„ç†åçš„åˆ—è¡¨
    update_output_text(output_text, first_column_list)
    
    # å¦‚æœæœ‰è¡¥0çš„ï¼Œè¾“å‡ºæç¤º
    if padded_values:
        update_output_text(output_text, f"è¿™äº›è¡¥äº†0: {padded_values}")

















    result_dict = {}
    for val in first_column_list:
        matched_indices = aa_column[aa_column.str.contains(str(val), na=False)].index.tolist()
        ab_values = [ab_column.iloc[i] for i in matched_indices]
        result_dict[val] = ab_values

    invoice_path = os.path.join(folder_path, invoice_file)
    df_invoice = pd.read_excel(invoice_path, header=0)
    x_column = df_invoice.iloc[:, 23].astype(str)
    y_column = df_invoice.iloc[:, 24].astype(str)
    bl_column = df_invoice.iloc[:, 63]

    from openpyxl import load_workbook
    import re

    # åŠ è½½ Excel æ–‡ä»¶
    wb = load_workbook(df_file)  # df_file æ˜¯è·¯å¾„
    ws = wb.active  # é»˜è®¤ç¬¬ä¸€ä¸ª sheet

    row_idx = 1  # ä»ç¬¬ä¸€è¡Œå¼€å§‹å†™
    from openpyxl import load_workbook
    import re

    wb = load_workbook(df_file)  # df_file æ˜¯è·¯å¾„
    ws = wb.active

    row_idx = 1  # ä»ç¬¬ä¸€è¡Œå¼€å§‹å†™
    for key, ab_vals in result_dict.items():
        for ab_val in ab_vals:
            entry_match = re.search(r"_entry_(\d+)", ab_val)
            line_match = re.search(r"_line_(\d+)", ab_val)

            if entry_match and line_match:
                entry_num = entry_match.group(1)
                line_num = line_match.group(1)

                update_output_text(output_text, f"åŒ¹é… entry:{entry_num}, line:{line_num}\n")

                matches = df_invoice[
                    (df_invoice.iloc[:, 23].astype(str).str.strip() == entry_num) &
                    (df_invoice.iloc[:, 24].astype(str).str.strip() == line_num)
                    ]

                found_value = "N/A"
                if not matches.empty:
                    found_value = matches.iloc[0, 63]  # BL åˆ—
                    update_output_text(output_text, f"{key} {found_value}\n")
                else:
                    update_output_text(output_text,
                                       f"âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯¹åº” entry:{entry_num} line:{line_num} çš„ Invoice æ•°æ®\n")

                # å†™å…¥ Excel
                ws.cell(row=row_idx, column=1, value=key)  # ç¬¬ä¸€åˆ—å†™ key
                ws.cell(row=row_idx, column=3, value=found_value)  # ç¬¬ä¸‰åˆ—å†™ found_value
                row_idx += 1

    wb.save(df_file)

    # åˆ é™¤å¤šä½™è§£å¯†æ–‡ä»¶
    for file in os.listdir(folder_path):
        if file.endswith(".decrypted.xlsx"):
            os.remove(os.path.join(folder_path, file))
            update_output_text(output_text, f"ğŸ—‘ åˆ é™¤ä¸´æ—¶è§£å¯†æ–‡ä»¶: {file}\n")

    update_output_text(output_text, "âœ… å®Œæˆæ‰€æœ‰æ­¥éª¤\n")

def Nikki_template(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # Step 2 â€” æ‰¾æ¡Œé¢è·¯å¾„
    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)
    if not desktop_path:
        update_output_text(output_text, "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()

    folder_path = os.path.join(desktop_path, "Nikki")
    if not os.path.exists(folder_path):
        os.makedirs(folder_path)
        update_output_text(output_text, f"âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¤¹ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼š{folder_path}\n\n")
        sys.exit()
    # è·å–Excelæ–‡ä»¶è·¯å¾„ï¼ˆå‡è®¾æ–‡ä»¶å¤¹é‡Œåªæœ‰ä¸€ä¸ªExcelæ–‡ä»¶ï¼‰
    try:
        folder_path = os.path.join(desktop_path, "Nikki")
        if not os.path.exists(folder_path):
            os.makedirs(folder_path)
            update_output_text(output_text, f"âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¤¹ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼š{folder_path}\n\n")
            return

        files = [f for f in os.listdir(folder_path) if f.endswith('.xlsx')]

        if not files:
            update_output_text(output_text, "âŒ æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ° Excel æ–‡ä»¶ï¼\n\n")
            return

        if len(files) > 1:
            update_output_text(output_text, "âŒ æ–‡ä»¶å¤¹ä¸­æœ‰å¤šä¸ª Excel æ–‡ä»¶ï¼Œè¯·åªä¿ç•™ä¸€ä¸ªï¼\n\n")
            return

        file_name = os.path.splitext(files[0])[0]  # è·å–å”¯ä¸€æ–‡ä»¶åï¼ˆæ— åç¼€ï¼‰
        file_path = os.path.join(folder_path, files[0])

    except Exception as e:
        update_output_text(output_text, f"âŒ è¯»å–æ–‡ä»¶å¤¹å‡ºé”™ï¼š{e}\n\n")
        return

        file_name = os.path.splitext(files[0])[0]
        file_path = os.path.join(folder_path, files[0])
    except Exception as e:
        update_output_text(output_text, f"âŒ æ£€æŸ¥æˆ–åˆ›å»ºæ–‡ä»¶å¤¹æ—¶å‡ºé”™ï¼š{e}\n\n")
        return

    # ===== Step 4. è¯»å– Excel =====
    try:
        df = pd.read_excel(file_path, header=None)
        print(df.head(15))
    except Exception as e:
        update_output_text(output_text, f"âŒ è¯»å– Excel æ–‡ä»¶å¤±è´¥ï¼š{e}\n\n")
        return

    try:
        header_row = df.iloc[8].tolist()
        df = df.iloc[10:].reset_index(drop=True)
        df.columns = header_row
        print(header_row)
    except Exception as e:
        update_output_text(output_text, f"âŒ å¤„ç†è¡¨å¤´æ—¶å‡ºé”™ï¼š{e}\n\n")
        return

    # ===== Step 5. æ‰¾åˆ°æœ‰æ•ˆæ•°æ®èŒƒå›´ =====
    try:
        k_col = df.iloc[:, 10]
        first_blank_index = k_col[k_col.isna() | (k_col.astype(str).str.strip() == '')].index
        if len(first_blank_index) > 0:
            stop_index = first_blank_index[0]
            df = df.loc[:stop_index - 1].reset_index(drop=True)
    except Exception as e:
        update_output_text(output_text, f"âŒ æŸ¥æ‰¾ç©ºè¡Œæ—¶å‡ºé”™ï¼š{e}\n\n")
        return

    # ===== Step 6. æŸ¥æ‰¾åˆ—å‡½æ•° =====
    def find_col(keyword):
        try:
            tenth_row = pd.Series(header_row)  # è½¬æ¢ä¸º Series
            match = tenth_row[tenth_row.astype(str).str.contains(keyword, case=False, na=False)]
            return match.index[0] if not match.empty else None
        except Exception as e:
            update_output_text(output_text, f"âŒ æŸ¥æ‰¾åˆ—æ—¶å‡ºé”™ï¼ˆå…³é”®å­— {keyword}ï¼‰ï¼š{e}\n\n")
            return None

    hts_col = find_col("HS")
    qty_col = find_col("Quantity")
    usd_col = find_col("Amount")
    kg_col = find_col("N.W")
    net_col = find_col("G.W")
    # ===== Step 7. ç”Ÿæˆæ–°è¡¨ =====
    try:
        new_df = pd.DataFrame(index=df.index)
        new_df[1] = ""
        new_df[2] = ""
        new_df[3] = "CN"
        new_df[4] = "CN"

        new_df[5] = df.iloc[:, hts_col].apply(
            lambda x: ''.join(re.findall(r'\d+', str(x)))) if hts_col is not None else ""
        new_df[6] = df.iloc[:, qty_col] if qty_col is not None else ""
        new_df[7] = "PCS"
        new_df[8] = df.iloc[:, usd_col].astype(float) / df.iloc[:, qty_col].astype(
            float) if usd_col is not None and qty_col is not None else ""

        def round_value(value):
            try:
                return round(float(value), 0)
            except Exception:
                return value

        new_df[9] = df.iloc[:, usd_col].apply(
            lambda x: round_value(x) if pd.notna(x) else "") if usd_col is not None else ""
        new_df[10] = df.iloc[:, kg_col] if kg_col is not None else ""
        new_df[11] = df.iloc[:, net_col] if net_col is not None else ""


    except Exception as e:
        update_output_text(output_text, f"âŒ ç”Ÿæˆæ–°è¡¨æ—¶å‡ºé”™ï¼š{e}\n\n")
        return

    # ===== Step 8. æ‹†åˆ†å¹¶å¯¼å‡º =====
    try:
        header_row = [
            "Invoice_No", "Part", "Commercial_Description", "Country_of_Origin", "Country_of_Export",
            "Tariff_Number", "Quantity", "Quantity_UOM", "Unit_Price", "Total_Line_Value", "Net_Weight_KG",
            "Gross_Weight_KG", "Manufacturer_Name", "Manufacturer_Address_1", "Manufacturer_Address_2",
            "Manufacturer_City", "Manufacturer_State", "Manufacturer_Zip", "Manufacturer_Country", "MID_Code",
            "Buyer_Name", "Buyer_Address_1", "Buyer_Address_2", "Buyer_City", "Buyer_State", "Buyer_Zip",
            "Buyer_Country", "Buyer_ID_Number", "Consignee_Name", "Consignee_Address_1", "Consignee_Address_2",
            "Consignee_City", "Consignee_State", "Consignee_Zip", "Consignee_Country", "Consignee_ID_Number",
            "SICountry", "SP1", "SP2", "Zone_Status", "Privileged_Filing_Date", "Line_Piece_Count",
            "ADD_Case_Number", "CVD_Case_Number", "AD_Non_Reimbursement_Statement", "AD-CVD_Certification_Designation"
        ]

        split_size = 998
        num_files = (len(new_df) // split_size) + (1 if len(new_df) % split_size != 0 else 0)
        letters = list(string.ascii_uppercase)

        def safe_write_value(value):
            if isinstance(value, (float, int)) and (np.isnan(value) or np.isinf(value)):
                return ""
            return value

        for i in range(num_files):
            start_row = i * split_size
            end_row = start_row + split_size
            split_df = new_df.iloc[start_row:end_row].copy()

            split_df.insert(0, "File Name", file_name + "-" + letters[i])
            output_file = os.path.join(folder_path, f"{file_name}-{letters[i]}.xlsx")

            wb = Workbook()
            ws = wb.active
            ws.title = "Sheet1"

            # å†™å…¥è¡¨å¤´
            for col_num, value in enumerate(header_row, start=1):
                ws.cell(row=1, column=col_num, value=value)

            # å†™å…¥æ•°æ®
            for row_num, row in enumerate(split_df.values, start=2):
                for col_num, value in enumerate(row, start=1):
                    ws.cell(row=row_num, column=col_num, value=safe_write_value(value))

            wb.save(output_file)
    except Exception as e:
        update_output_text(output_text, f"âŒ å¯¼å‡ºæ–‡ä»¶æ—¶å‡ºé”™ï¼š{e}\n\n")
        return

    update_output_text(output_text, f"âœ… æ‹†åˆ†å®Œæˆï¼Œå…±ç”Ÿæˆ {num_files} ä¸ª Excel æ–‡ä»¶ã€‚\n\n")

def wechat(account, password, output_text):
    from seleniumwire import webdriver
    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://raw.githubusercontent.com/Shirasagi-no-Mai/weixinQR-code/refs/heads/main/91c3d7487460721a695e43613d8203d.jpg"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles 

def reverse_line_extract(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # Step 2 â€” æ‰¾æ¡Œé¢è·¯å¾„
    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)
    if not desktop_path:
        update_output_text(output_text, "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()

    folder_path = os.path.join(desktop_path, "Line extract")
    if not os.path.exists(folder_path):
        os.makedirs(folder_path)
        update_output_text(output_text, f"âš ï¸ æœªæ‰¾åˆ°æ–‡ä»¶å¤¹ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼š{folder_path}\n\n")
        sys.exit()

    # Step 3 â€” æ‰¾æ–‡ä»¶
    excel_files = [f for f in os.listdir(folder_path) if f.lower().endswith(('.xls', '.xlsx')) and not f.startswith('~$')]
    packing_list_file = None
    invoice_file = None
    for file in excel_files:
        if "packing list" in file.lower():
            packing_list_file = file
        elif "invoice" in file.lower():
            invoice_file = file

    if not packing_list_file or not invoice_file:
        update_output_text(output_text, "âŒ ç¼ºå°‘å¿…è¦æ–‡ä»¶ï¼Œç¨‹åºé€€å‡º\n")
        exit()

    packing_list_passwords = ["4!vCwY65@8", "bC_72=ukwG", "Gcp76!Ch3Y", "A&$*yv#3m5"]

    def try_decrypt(file_path, passwords):
        decrypted_file_path = file_path + ".decrypted.xlsx"
        success = False
        for pwd in passwords:
            try:
                with open(file_path, "rb") as f:
                    doc = msoffcrypto.OfficeFile(f)
                    doc.load_key(pwd)
                    with open(decrypted_file_path, "wb") as decrypted_file:
                        doc.decrypt(decrypted_file)
                update_output_text(output_text, f"âœ… ä½¿ç”¨å¯†ç  '{pwd}' è§£å¯†æˆåŠŸï¼š{os.path.basename(file_path)}\n")
                success = True
                break
            except Exception as e:
                update_output_text(output_text, f"âŒ ä½¿ç”¨å¯†ç  '{pwd}' å¤±è´¥: {e}\n")
        return decrypted_file_path if success else None

    # è§£å¯† packing list
    packing_list_path = os.path.join(folder_path, packing_list_file)
    decrypted_packing_list = try_decrypt(packing_list_path, packing_list_passwords)
    if not decrypted_packing_list:
        update_output_text(output_text, "âŒ Packing list æ— æ³•è§£å¯†\n")
        exit()

    df_packing = pd.read_excel(decrypted_packing_list, header=8, dtype=str)  # ç¬¬9è¡Œheader
    aa_column = df_packing.iloc[:, 26].astype(str)  # AAåˆ—
    ab_column = df_packing.iloc[:, 27].astype(str)  # ABåˆ—

    # è¯»å– df (BBCreview.xlsx ç¬¬ä¸€åˆ—å’Œç¬¬ä¸‰åˆ—)
    df_file = os.path.join(desktop_path, "BBCreview.xlsx")
    df = pd.read_excel(df_file, header=None, dtype=str)

    invoice_path = os.path.join(folder_path, invoice_file)
    df_invoice = pd.read_excel(invoice_path, header=0, dtype=str)

    from openpyxl import load_workbook
    import re

    # åŠ è½½ Excel æ–‡ä»¶
    wb = load_workbook(df_file)
    ws = wb.active

    for row_idx in range(1, ws.max_row + 1):
        entry_val = str(ws.cell(row=row_idx, column=1).value).strip()
        line_val = str(ws.cell(row=row_idx, column=3).value).strip()

        if not entry_val or not line_val:
            continue

        # æ‰¾ invoice ä¸­å¯¹åº”è¡Œ (BJ=entry_val, BL=line_val)
        matches = df_invoice[
            (df_invoice.iloc[:, 61].astype(str).str.strip() == entry_val) &  # BJåˆ—
            (df_invoice.iloc[:, 63].astype(str).str.strip() == line_val)     # BLåˆ—
        ]

        if matches.empty:
            update_output_text(output_text, f"âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯¹åº” entry:{entry_val} line:{line_val} çš„ Invoice æ•°æ®\n")
            continue

        X = matches.iloc[0, 23]  # Xåˆ—
        Y = matches.iloc[0, 24]  # Yåˆ—
        target_suffix = f"entry_{X}_line_{Y}"

        # åœ¨ packing list æ‰¾åç¼€åŒ¹é…
        aa_match = None
        for i, ab_val in enumerate(ab_column):
            if str(ab_val).strip().endswith(target_suffix):
                aa_val = str(aa_column.iloc[i])
                aa_match = aa_val[-12:] if len(aa_val) >= 12 else aa_val
                break

        # å†™å…¥ç¬¬äº”åˆ—
        ws.cell(row=row_idx, column=5, value=aa_match if aa_match else "N/A")
        update_output_text(output_text, f"åŒ¹é… entry:{entry_val}, line:{line_val} -> {aa_match if aa_match else 'N/A'}\n")

    wb.save(df_file)

    # åˆ é™¤å¤šä½™è§£å¯†æ–‡ä»¶
    for file in os.listdir(folder_path):
        if file.endswith(".decrypted.xlsx"):
            os.remove(os.path.join(folder_path, file))
            update_output_text(output_text, f"ğŸ—‘ åˆ é™¤ä¸´æ—¶è§£å¯†æ–‡ä»¶: {file}\n")

    update_output_text(output_text, "âœ… å®Œæˆåå‘æå–æ­¥éª¤\n")



def document_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            pass
        else:
            wb = Workbook()
            wb.save(file_path)
            sys.exit()
    else:
        sys.exit()

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    try:
        # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
        WebDriverWait(driver, 10).until(
            lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
        )
        print("'sign' found in page source. Continuing...")
    except Exception as e:
        print("Timeout or error while waiting for 'sign':", e)
        driver.quit()
        exit()

    # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
    login_button.click()
    print("Current page title is:", driver.title)
    WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

    try:
        # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
        login_button.click()

        # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
        try:
            logout_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
            )
            logout_button.click()
            print("Clicked the logout button in the alert.")

            # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
            )
            time.sleep(2)
            username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
            username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

            # è¾“å…¥å¯†ç 
            password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
            password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            password_field.send_keys(password)  # è¾“å…¥å¯†ç 
            # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()
            print("Clicked the login button.")

        except TimeoutException:
            print("No alert appeared, proceeding with the login.")

        # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
        WebDriverWait(driver, 10).until(
            EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
        )
        print("Login successful. Page title is:", driver.title)

    except (TimeoutException, NoSuchElementException) as e:
        print(f"Error occurred during login: {e}")
    outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
    driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
    step_status = True

    def check_alert(driver):
        try:
            time.sleep(1)
            alert = driver.switch_to.alert
            alert_text = alert.text
            print("å¼¹çª—å†…å®¹:", alert_text)

            if "cotton" not in alert_text.lower():
                alert.accept()
                print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
            else:
                alert.dismiss()
                print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

            time.sleep(1)
        except NoAlertPresentException:
            pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

    def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
        end_time = time.time() + timeout
        while time.time() < end_time:
            try:
                # æŸ¥æ‰¾é®ç½©å±‚
                blocking_elements = driver.find_elements(By.CSS_SELECTOR, ".blockUI.blockOverlay")
                if not blocking_elements:
                    print("âœ… é˜»æŒ¡å…ƒç´ æ¶ˆå¤±ï¼Œç»§ç»­æ“ä½œ")
                    return
                print("â³ æ£€æµ‹åˆ°é®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                time.sleep(check_interval)
            except UnexpectedAlertPresentException:
                try:
                    alert = driver.switch_to.alert
                    print("âš ï¸ æ£€æµ‹åˆ° alert å¼¹çª—ï¼š", alert.text)
                    alert.accept()
                    print("âœ… å·²ç‚¹å‡»ç¡®è®¤å…³é—­ alert")
                    time.sleep(1)
                except NoAlertPresentException:
                    print("âŒ æƒ³å¤„ç† alertï¼Œä½†æ‰¾ä¸åˆ°")
                continue
            except Exception as e:
                print(f"âš ï¸ æ£€æµ‹é®ç½©å±‚æ—¶å‡ºç°é”™è¯¯: {e}")
                time.sleep(check_interval)
                continue

    def open_entry(driver):

        try:
            driver.switch_to.default_content()
            print("âœ… å·²è¿”å›ä¸»é¡µé¢")
        except Exception as e:
            print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")
        try:

            # ç‚¹å‡»å›¾ç‰‡ï¼ˆå¦‚æœéç»¿æ ‡çš„æƒ…å†µä¸‹ï¼‰
            img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
            img_element = driver.find_element(By.XPATH, img_xpath)

            # ç”¨WebElementä¼ å…¥move_to_element
            ActionChains(driver).move_to_element(img_element).perform()
            time.sleep(1)  # é€‚å½“ç­‰å¾…æ‚¬åœè§¦å‘çš„æ•ˆæœ

            check_alert(driver)
            # ç­‰å¾…editæŒ‰é’®å¯ç‚¹å‡»å¹¶ç‚¹å‡»ï¼ˆå¾ªç¯10ç§’ï¼Œæ¯ç§’å°è¯•ï¼‰
            timeout = 10  # æœ€å¤§ç­‰å¾…æ—¶é—´10ç§’
            interval = 1  # æ¯éš”1ç§’å°è¯•ä¸€æ¬¡
            start_time = time.time()

            while True:
                try:
                    edit_img = WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable(
                            (By.XPATH, "//a[contains(@class,'shipment-row')]/img[@src='/images/icons/edit_30x30.png']"))
                    )
                    edit_img.click()
                    print("ç‚¹å‡»æˆåŠŸ")
                    break  # ç‚¹å‡»æˆåŠŸè·³å‡ºå¾ªç¯
                except (ElementClickInterceptedException, TimeoutException) as e:
                    elapsed = time.time() - start_time
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        break
                    else:
                        print("ç‚¹å‡»è¢«æ‹¦æˆªæˆ–å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)

        except Exception as e:
            print(f"âŒ Error occurred: {e}")

    def search_entry_num(entry_number, timeout=5):
        driver.switch_to.default_content()

        wait_for_block_to_disappear(driver)
        start_time = time.time()
        while True:
            try:

                find_element = WebDriverWait(driver, 10).until(
                    EC.visibility_of_element_located(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                )
                # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                actions = ActionChains(driver)
                actions.move_to_element(find_element).perform()
                # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                input_box = WebDriverWait(driver, 3).until(
                    EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                )
                input_box.clear()
                input_box.send_keys(entry_number)

                # å°è¯•ç‚¹å‡»æŒ‰é’®
                search_button = WebDriverWait(driver, 3).until(
                    EC.element_to_be_clickable(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                )
                search_button.click()

                break  # æˆåŠŸåè·³å‡ºå¾ªç¯

            except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                if time.time() - start_time > timeout:
                    return "è¶…æ—¶"
                    break
                else:
                    time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

    def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
        for attempt in range(retries):
            try:
                check_alert(driver)
                result = action()
                check_alert(driver)
                return result
            except Exception as e:
                print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                check_alert(driver)
                if attempt < retries - 1:
                    time.sleep(retry_delay)
                else:
                    print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                    return "tryfalse"

    def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
        import time
        from selenium.common.exceptions import NoSuchElementException
        from selenium.webdriver.common.by import By

        start_time = time.time()

        while time.time() - start_time < duration:
            try:
                element = driver.find_element(By.XPATH, xpath)
                if element.is_displayed():
                    print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                    time.sleep(1)
                    return True
            except NoSuchElementException:
                print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

            time.sleep(interval)

        print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
        return False

    def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
        try:
            # æ¸…ç©ºå¹¶è¾“å…¥
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
            import time, re
            start_time = time.time()

            # æå– ul çš„ç´¢å¼•
            ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
            if not ul_pattern:
                print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                return

            base_index = int(ul_pattern.group(1))
            prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

            while time.time() - start_time < duration:
                for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                    trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                    print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                    result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                     f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                    if result != "tryfalse":
                        print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                        return

            print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

        except Exception as e:
            print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
            check_alert(driver)

    def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

        try:
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

        except Exception as e:
            # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
            print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

    def page_viewd(driver):
        try:
            iframe = driver.find_element(By.ID, "iframeInvoices")
            driver.switch_to.frame(iframe)
        except:
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))
        ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=20, retry_delay=0.5)
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=1, retry_delay=0.5)
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH, "//a[contains(@onclick, 'PreviewInvoice')]"))
        ).click(), "ç‚¹å‡»é¢„è§ˆæŒ‰é’®", retries=10, retry_delay=0.5)
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

    file_path = os.path.join(desktop_path, "BBCreview.xlsx")
    file_path = file_path
    df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()

    # wait_for_block_to_disappear(driver, timeout=40, check_interval=1)
    # open_entry(driver)
    # for entry_number,house in zip(filtered_lista,filtered_listc):
    #     search_entry_num(entry_number, timeout=5)
    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     check_alert(driver)
    #     # WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click()
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     page_viewd(driver,house)
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     time.sleep(1)

    wait_for_block_to_disappear(driver, timeout=40, check_interval=1)

    for entry_number in filtered_lista:

        search_entry_num(entry_number, timeout=5)
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        check_alert(driver)
        open_entry(driver)
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

        page_viewd(driver)
        try:
            driver.switch_to.default_content()
            print("æˆåŠŸåˆ‡æ¢å›æ¥")
        except Exception as e:
            print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        time.sleep(1)
        update_output_text(output_text, f"{entry_number}ç»“æŸ")
    update_output_text(output_text, "å…¨éƒ¨å®Œæˆ")



def release_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶,ä¸‹æ¬¡è¿è¡Œå°†å¼€å§‹æ“ä½œï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    try:
        options = webdriver.ChromeOptions()
        options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
        options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
        options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
        options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
        options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)

        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")
    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    try:
        # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
        WebDriverWait(driver, 10).until(
            lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
        )
        print("'sign' found in page source. Continuing...")
    except Exception as e:
        print("Timeout or error while waiting for 'sign':", e)
        driver.quit()
        exit()

    # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
    login_button.click()
    print("Current page title is:", driver.title)
    WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

    try:
        # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
        login_button.click()

        # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
        try:
            logout_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
            )
            logout_button.click()
            print("Clicked the logout button in the alert.")

            # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
            )
            time.sleep(2)
            username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
            username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

            # è¾“å…¥å¯†ç 
            password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
            password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            password_field.send_keys(password)  # è¾“å…¥å¯†ç 
            # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()
            print("Clicked the login button.")

        except TimeoutException:
            print("No alert appeared, proceeding with the login.")

        # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
        WebDriverWait(driver, 10).until(
            EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
        )
        print("Login successful. Page title is:", driver.title)

    except (TimeoutException, NoSuchElementException) as e:
        print(f"Error occurred during login: {e}")
    outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
    driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
    step_status = True

    def check_alert(driver):
        try:
            time.sleep(1)
            alert = driver.switch_to.alert
            alert_text = alert.text
            print("å¼¹çª—å†…å®¹:", alert_text)

            if "cotton" not in alert_text.lower():
                alert.accept()
                print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
            else:
                alert.dismiss()
                print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

            time.sleep(1)
        except NoAlertPresentException:
            pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

    def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
        end_time = time.time() + timeout
        while time.time() < end_time:
            try:
                # æŸ¥æ‰¾é®ç½©å±‚
                blocking_elements = driver.find_elements(By.CSS_SELECTOR, ".blockUI.blockOverlay")
                if not blocking_elements:
                    print("âœ… é˜»æŒ¡å…ƒç´ æ¶ˆå¤±ï¼Œç»§ç»­æ“ä½œ")
                    return
                print("â³ æ£€æµ‹åˆ°é®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                time.sleep(check_interval)
            except UnexpectedAlertPresentException:
                try:
                    alert = driver.switch_to.alert
                    print("âš ï¸ æ£€æµ‹åˆ° alert å¼¹çª—ï¼š", alert.text)
                    alert.accept()
                    print("âœ… å·²ç‚¹å‡»ç¡®è®¤å…³é—­ alert")
                    time.sleep(1)
                except NoAlertPresentException:
                    print("âŒ æƒ³å¤„ç† alertï¼Œä½†æ‰¾ä¸åˆ°")
                continue
            except Exception as e:
                print(f"âš ï¸ æ£€æµ‹é®ç½©å±‚æ—¶å‡ºç°é”™è¯¯: {e}")
                time.sleep(check_interval)
                continue

    def open_entry(driver):
        try:
            driver.switch_to.default_content()
            print("âœ… å·²è¿”å›ä¸»é¡µé¢")
        except Exception as e:
            print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")

        try:
            # æ£€æŸ¥ iframe
            iframes = driver.find_elements(By.TAG_NAME, "iframe")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(iframes)} ä¸ª iframe")
            iframe_switched = False
            if iframes:
                for i, iframe in enumerate(iframes):
                    try:
                        driver.switch_to.frame(iframe)
                        print(f"âœ… åˆ‡æ¢åˆ° iframe {i}")
                        driver.find_element(By.XPATH,
                                            "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]")
                        print("âœ… æ‚¬åœå…ƒç´ åœ¨ iframe ä¸­")
                        iframe_switched = True
                        break
                    except:
                        driver.switch_to.default_content()
                        print(f"âŒ iframe {i} ä¸­æ— ç›®æ ‡å…ƒç´ ï¼Œåˆ‡æ¢å›ä¸»é¡µé¢")
            else:
                print("âœ… æ—  iframe")

            # å®šä½æ‚¬åœå…ƒç´ å¹¶æå– <td> çš„ id
            img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
            print(f"ğŸ” å°è¯•å®šä½æ‚¬åœå…ƒç´ : {img_xpath}")
            img_elements = driver.find_elements(By.XPATH, img_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(img_elements)} ä¸ªæ‚¬åœå…ƒç´ ")
            if len(img_elements) > 1:
                print("âš ï¸ è­¦å‘Š: æ‚¬åœ XPath åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯")
                for i, elem in enumerate(img_elements):
                    print(f"ğŸ” æ‚¬åœå…ƒç´  {i}: {elem.get_attribute('outerHTML')}")
            img_element = img_elements[0] if img_elements else driver.find_element(By.XPATH, img_xpath)
            print(f"âœ… æ‚¬åœå…ƒç´ : {img_element.get_attribute('outerHTML')}")

            # è·å–çˆ¶ <td> çš„ id
            td_element = img_element.find_element(By.XPATH, "./ancestor::td[contains(@id, 'EntrySummary')]")
            td_id = td_element.get_attribute("id")
            print(f"âœ… æ‰¾åˆ°çˆ¶ <td> id: {td_id}")

            # æ‚¬åœå¹¶ç­‰å¾…èœå•åŠ è½½
            ActionChains(driver).move_to_element(img_element).perform()
            print("âœ… å·²æ‰§è¡Œæ‚¬åœæ“ä½œ")
            try:
                WebDriverWait(driver, 5).until(
                    EC.presence_of_element_located((By.XPATH, "//a[contains(@class,'shipment-row')]"))
                )
                print("âœ… èœå•å·²åŠ è½½")
            except TimeoutException:
                print("âŒ èœå•æœªåŠ è½½ï¼Œå¯èƒ½æ‚¬åœå¤±è´¥")

            # æ£€æŸ¥å¼¹çª—
            def check_alert(driver):
                try:
                    alert = driver.switch_to.alert
                    alert.accept()
                    print("âœ… å·²å…³é—­å¼¹çª—")
                except:
                    print("âœ… æ— å¼¹çª—")

            check_alert(driver)

            # æ£€æŸ¥é«˜ z-index å…ƒç´ 
            overlays = driver.find_elements(By.XPATH,
                                            "//*[contains(@style, 'z-index') and not(contains(@style, 'z-index: 0'))]")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(overlays)} ä¸ªé«˜ z-index å…ƒç´ ")
            for overlay in overlays[:3]:
                print(f"ğŸ” è¦†ç›–å±‚: {overlay.get_attribute('outerHTML')}")

            # å®šä½ Edit æŒ‰é’®ï¼Œä½¿ç”¨çˆ¶ <td> çš„ id çº¦æŸ
            timeout = 10
            interval = 1
            start_time = time.time()
            edit_xpath = f"//td[@id='{td_id}']//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]"
            print(f"ğŸ” å°è¯•å®šä½ Edit æŒ‰é’®: {edit_xpath}")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
            if len(edit_elements) > 1:
                print("âš ï¸ è­¦å‘Š: Edit XPath ä»åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")
            elif len(edit_elements) == 0:
                print("âŒ Edit æŒ‰é’®æœªæ‰¾åˆ°ï¼ŒXPath å¯èƒ½é”™è¯¯æˆ–å…ƒç´ æœªåŠ è½½")
                print(
                    "ğŸ” å°è¯•å¤‡ç”¨ XPath: //a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                edit_elements = driver.find_elements(By.XPATH,
                                                     "//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                print(f"ğŸ” å¤‡ç”¨ XPath æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” å¤‡ç”¨ Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")

            while True:
                try:
                    edit_img = WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, edit_xpath))
                    )
                    print(f"âœ… Edit æŒ‰é’®å®šä½æˆåŠŸ: {edit_img.get_attribute('outerHTML')}")
                    print(f"ğŸ” å…ƒç´ å¯è§: {edit_img.is_displayed()}, å…ƒç´ å¯ç‚¹å‡»: {edit_img.is_enabled()}")
                    try:
                        edit_img.click()
                        print("âœ… ç‚¹å‡» Edit æŒ‰é’®æˆåŠŸ")
                        break
                    except ElementClickInterceptedException as e:
                        print(f"âŒ ç‚¹å‡»è¢«æ‹¦æˆª: {e}")
                        print("ğŸ” å°è¯• JavaScript ç‚¹å‡»")
                        driver.execute_script("arguments[0].click();", edit_img)
                        print("âœ… ä½¿ç”¨ JavaScript ç‚¹å‡» Edit æŒ‰é’®")
                        break
                except TimeoutException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ TimeoutException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†ä¸å¯ç‚¹å‡»: {edit_elements[0].get_attribute('outerHTML')}")
                        else:
                            print("ğŸ” Edit æŒ‰é’®æœªåœ¨ DOM ä¸­æ‰¾åˆ°")
                        break
                    else:
                        print("âŒ å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)
                except ElementClickInterceptedException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ ElementClickInterceptedException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†è¢«é®æŒ¡: {edit_elements[0].get_attribute('outerHTML')}")
                        break
                    else:
                        print("âŒ å…ƒç´ è¢«æ‹¦æˆªï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)

            # åˆ‡æ¢å›ä¸»é¡µé¢
            if iframe_switched:
                driver.switch_to.default_content()
                print("âœ… åˆ‡æ¢å›ä¸»é¡µé¢")

        except Exception as e:
            print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            if edit_elements:
                print(f"ğŸ” Edit æŒ‰é’®: {edit_elements[0].get_attribute('outerHTML')}")
            else:
                print("ğŸ” Edit æŒ‰é’®æœªæ‰¾åˆ°")

    def search_entry_num(entry_number, timeout=5):
        driver.switch_to.default_content()

        wait_for_block_to_disappear(driver)
        start_time = time.time()
        while True:
            try:

                find_element = WebDriverWait(driver, 10).until(
                    EC.visibility_of_element_located(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                )
                # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                actions = ActionChains(driver)
                actions.move_to_element(find_element).perform()
                # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                input_box = WebDriverWait(driver, 3).until(
                    EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                )
                input_box.clear()
                input_box.send_keys(entry_number)

                # å°è¯•ç‚¹å‡»æŒ‰é’®
                search_button = WebDriverWait(driver, 3).until(
                    EC.element_to_be_clickable(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                )
                search_button.click()

                break  # æˆåŠŸåè·³å‡ºå¾ªç¯

            except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                if time.time() - start_time > timeout:
                    return "è¶…æ—¶"
                    break
                else:
                    time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

    def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
        for attempt in range(retries):
            try:
                check_alert(driver)
                result = action()
                check_alert(driver)
                return result
            except Exception as e:
                print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                check_alert(driver)
                if attempt < retries - 1:
                    time.sleep(retry_delay)
                else:
                    print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                    return "tryfalse"

    def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
        import time
        from selenium.common.exceptions import NoSuchElementException
        from selenium.webdriver.common.by import By

        start_time = time.time()

        while time.time() - start_time < duration:
            try:
                element = driver.find_element(By.XPATH, xpath)
                if element.is_displayed():
                    print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                    time.sleep(1)
                    return True
            except NoSuchElementException:
                print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

            time.sleep(interval)

        print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
        return False

    def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
        try:
            # æ¸…ç©ºå¹¶è¾“å…¥
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
            import time, re
            start_time = time.time()

            # æå– ul çš„ç´¢å¼•
            ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
            if not ul_pattern:
                print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                return

            base_index = int(ul_pattern.group(1))
            prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

            while time.time() - start_time < duration:
                for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                    trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                    print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                    result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                     f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                    if result != "tryfalse":
                        print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                        return

            print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

        except Exception as e:
            print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
            check_alert(driver)

    def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

        try:
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

        except Exception as e:
            # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
            print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

    def page_viewd(driver):
        try:
            iframe = driver.find_element(By.ID, "iframeInvoices")
            driver.switch_to.frame(iframe)
        except:
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))
        ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=20, retry_delay=0.5)
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=1, retry_delay=0.5)
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

        try:
            checkbox = driver.find_element(By.ID, "IsBatchProcessing")

            # ç”¨ JS å–æ¶ˆ disabled å’Œ checked
            driver.execute_script("""
                arguments[0].removeAttribute('disabled');
            """, checkbox)

            # ç‚¹å‡»ä¸€ä¸‹å‹¾ä¸Š

            driver.execute_script("""
                arguments[0].checked = false;
            """, checkbox)

            print("âœ… å·²æˆåŠŸè§£é”å¹¶å‹¾é€‰ checkbox")
        except Exception as e:
            print(f"âŒ è§£é”å‹¾é€‰ checkbox å¤±è´¥: {e}")
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH, "//a[contains(@onclick, 'SubmitValidatedInvoice')]"))
        ).click())
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

    file_path = os.path.join(desktop_path, "BBCreview.xlsx")
    file_path = file_path
    df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰è¦å¤„ç†çš„inbond: {filtered_lista}\n\n\n")
    # wait_for_block_to_disappear(driver, timeout=40, check_interval=1)
    # open_entry(driver)
    # for entry_number,house in zip(filtered_lista,filtered_listc):
    #     search_entry_num(entry_number, timeout=5)
    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     check_alert(driver)
    #     # WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click()
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     page_viewd(driver,house)
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     time.sleep(1)

    wait_for_block_to_disappear(driver, timeout=40, check_interval=1)

    for entry_number in filtered_lista:

        search_entry_num(entry_number, timeout=5)
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        check_alert(driver)
        open_entry(driver)
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

        page_viewd(driver)
        try:
            driver.switch_to.default_content()
            print("æˆåŠŸåˆ‡æ¢å›æ¥")
        except Exception as e:
            print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        time.sleep(1)
        update_output_text(output_text, f"{entry_number}ç»“æŸ")
    update_output_text(output_text, "å…¨éƒ¨å®Œæˆ")

def bolupdate_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶,ä¸‹æ¬¡è¿è¡Œå°†å¼€å§‹æ“ä½œï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    try:
        # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
        WebDriverWait(driver, 10).until(
            lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
        )
        print("'sign' found in page source. Continuing...")
    except Exception as e:
        print("Timeout or error while waiting for 'sign':", e)
        driver.quit()
        exit()

    # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
    login_button.click()
    print("Current page title is:", driver.title)
    WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

    try:
        # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
        login_button.click()

        # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
        try:
            logout_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
            )
            logout_button.click()
            print("Clicked the logout button in the alert.")

            # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
            )
            time.sleep(2)
            username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
            username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

            # è¾“å…¥å¯†ç 
            password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
            password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            password_field.send_keys(password)  # è¾“å…¥å¯†ç 
            # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()
            print("Clicked the login button.")

        except TimeoutException:
            print("No alert appeared, proceeding with the login.")

        # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
        WebDriverWait(driver, 10).until(
            EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
        )
        print("Login successful. Page title is:", driver.title)

    except (TimeoutException, NoSuchElementException) as e:
        print(f"Error occurred during login: {e}")
    outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
    driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
    step_status = True

    def check_alert(driver):
        try:
            time.sleep(1)
            alert = driver.switch_to.alert
            alert_text = alert.text
            print("å¼¹çª—å†…å®¹:", alert_text)

            if "cotton" not in alert_text.lower():
                alert.accept()
                print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
            else:
                alert.dismiss()
                print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

            time.sleep(1)
        except NoAlertPresentException:
            pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

    def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
        end_time = time.time() + timeout
        while time.time() < end_time:
            try:
                # æŸ¥æ‰¾é®ç½©å±‚
                blocking_elements = driver.find_elements(By.CSS_SELECTOR, ".blockUI.blockOverlay")
                if not blocking_elements:
                    print("âœ… é˜»æŒ¡å…ƒç´ æ¶ˆå¤±ï¼Œç»§ç»­æ“ä½œ")
                    return
                print("â³ æ£€æµ‹åˆ°é®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                time.sleep(check_interval)
            except UnexpectedAlertPresentException:
                try:
                    alert = driver.switch_to.alert
                    print("âš ï¸ æ£€æµ‹åˆ° alert å¼¹çª—ï¼š", alert.text)
                    alert.accept()
                    print("âœ… å·²ç‚¹å‡»ç¡®è®¤å…³é—­ alert")
                    time.sleep(1)
                except NoAlertPresentException:
                    print("âŒ æƒ³å¤„ç† alertï¼Œä½†æ‰¾ä¸åˆ°")
                continue
            except Exception as e:
                print(f"âš ï¸ æ£€æµ‹é®ç½©å±‚æ—¶å‡ºç°é”™è¯¯: {e}")
                time.sleep(check_interval)
                continue

    def open_entry(driver):
        try:
            driver.switch_to.default_content()
            print("âœ… å·²è¿”å›ä¸»é¡µé¢")
        except Exception as e:
            print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")

        try:
            # æ£€æŸ¥ iframe
            iframes = driver.find_elements(By.TAG_NAME, "iframe")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(iframes)} ä¸ª iframe")
            iframe_switched = False
            if iframes:
                for i, iframe in enumerate(iframes):
                    try:
                        driver.switch_to.frame(iframe)
                        print(f"âœ… åˆ‡æ¢åˆ° iframe {i}")
                        driver.find_element(By.XPATH,
                                            "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]")
                        print("âœ… æ‚¬åœå…ƒç´ åœ¨ iframe ä¸­")
                        iframe_switched = True
                        break
                    except:
                        driver.switch_to.default_content()
                        print(f"âŒ iframe {i} ä¸­æ— ç›®æ ‡å…ƒç´ ï¼Œåˆ‡æ¢å›ä¸»é¡µé¢")
            else:
                print("âœ… æ—  iframe")

            # å®šä½æ‚¬åœå…ƒç´ å¹¶æå– <td> çš„ id
            img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
            print(f"ğŸ” å°è¯•å®šä½æ‚¬åœå…ƒç´ : {img_xpath}")
            img_elements = driver.find_elements(By.XPATH, img_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(img_elements)} ä¸ªæ‚¬åœå…ƒç´ ")
            if len(img_elements) > 1:
                print("âš ï¸ è­¦å‘Š: æ‚¬åœ XPath åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯")
                for i, elem in enumerate(img_elements):
                    print(f"ğŸ” æ‚¬åœå…ƒç´  {i}: {elem.get_attribute('outerHTML')}")
            img_element = img_elements[0] if img_elements else driver.find_element(By.XPATH, img_xpath)
            print(f"âœ… æ‚¬åœå…ƒç´ : {img_element.get_attribute('outerHTML')}")

            # è·å–çˆ¶ <td> çš„ id
            td_element = img_element.find_element(By.XPATH, "./ancestor::td[contains(@id, 'EntrySummary')]")
            td_id = td_element.get_attribute("id")
            print(f"âœ… æ‰¾åˆ°çˆ¶ <td> id: {td_id}")

            # æ‚¬åœå¹¶ç­‰å¾…èœå•åŠ è½½
            ActionChains(driver).move_to_element(img_element).perform()
            print("âœ… å·²æ‰§è¡Œæ‚¬åœæ“ä½œ")
            try:
                WebDriverWait(driver, 5).until(
                    EC.presence_of_element_located((By.XPATH, "//a[contains(@class,'shipment-row')]"))
                )
                print("âœ… èœå•å·²åŠ è½½")
            except TimeoutException:
                print("âŒ èœå•æœªåŠ è½½ï¼Œå¯èƒ½æ‚¬åœå¤±è´¥")

            # æ£€æŸ¥å¼¹çª—
            def check_alert(driver):
                try:
                    alert = driver.switch_to.alert
                    alert.accept()
                    print("âœ… å·²å…³é—­å¼¹çª—")
                except:
                    print("âœ… æ— å¼¹çª—")

            check_alert(driver)

            # æ£€æŸ¥é«˜ z-index å…ƒç´ 
            overlays = driver.find_elements(By.XPATH,
                                            "//*[contains(@style, 'z-index') and not(contains(@style, 'z-index: 0'))]")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(overlays)} ä¸ªé«˜ z-index å…ƒç´ ")
            for overlay in overlays[:3]:
                print(f"ğŸ” è¦†ç›–å±‚: {overlay.get_attribute('outerHTML')}")

            # å®šä½ Edit æŒ‰é’®ï¼Œä½¿ç”¨çˆ¶ <td> çš„ id çº¦æŸ
            timeout = 10
            interval = 1
            start_time = time.time()
            edit_xpath = f"//td[@id='{td_id}']//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]"
            print(f"ğŸ” å°è¯•å®šä½ Edit æŒ‰é’®: {edit_xpath}")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
            if len(edit_elements) > 1:
                print("âš ï¸ è­¦å‘Š: Edit XPath ä»åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")
            elif len(edit_elements) == 0:
                print("âŒ Edit æŒ‰é’®æœªæ‰¾åˆ°ï¼ŒXPath å¯èƒ½é”™è¯¯æˆ–å…ƒç´ æœªåŠ è½½")
                print(
                    "ğŸ” å°è¯•å¤‡ç”¨ XPath: //a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                edit_elements = driver.find_elements(By.XPATH,
                                                     "//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                print(f"ğŸ” å¤‡ç”¨ XPath æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” å¤‡ç”¨ Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")

            while True:
                try:
                    edit_img = WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, edit_xpath))
                    )
                    print(f"âœ… Edit æŒ‰é’®å®šä½æˆåŠŸ: {edit_img.get_attribute('outerHTML')}")
                    print(f"ğŸ” å…ƒç´ å¯è§: {edit_img.is_displayed()}, å…ƒç´ å¯ç‚¹å‡»: {edit_img.is_enabled()}")
                    try:
                        edit_img.click()
                        print("âœ… ç‚¹å‡» Edit æŒ‰é’®æˆåŠŸ")
                        break
                    except ElementClickInterceptedException as e:
                        print(f"âŒ ç‚¹å‡»è¢«æ‹¦æˆª: {e}")
                        print("ğŸ” å°è¯• JavaScript ç‚¹å‡»")
                        driver.execute_script("arguments[0].click();", edit_img)
                        print("âœ… ä½¿ç”¨ JavaScript ç‚¹å‡» Edit æŒ‰é’®")
                        break
                except TimeoutException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ TimeoutException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†ä¸å¯ç‚¹å‡»: {edit_elements[0].get_attribute('outerHTML')}")
                        else:
                            print("ğŸ” Edit æŒ‰é’®æœªåœ¨ DOM ä¸­æ‰¾åˆ°")
                        break
                    else:
                        print("âŒ å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)
                except ElementClickInterceptedException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ ElementClickInterceptedException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†è¢«é®æŒ¡: {edit_elements[0].get_attribute('outerHTML')}")
                        break
                    else:
                        print("âŒ å…ƒç´ è¢«æ‹¦æˆªï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)

            # åˆ‡æ¢å›ä¸»é¡µé¢
            if iframe_switched:
                driver.switch_to.default_content()
                print("âœ… åˆ‡æ¢å›ä¸»é¡µé¢")

        except Exception as e:
            print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            if edit_elements:
                print(f"ğŸ” Edit æŒ‰é’®: {edit_elements[0].get_attribute('outerHTML')}")
            else:
                print("ğŸ” Edit æŒ‰é’®æœªæ‰¾åˆ°")

    def search_entry_num(entry_number, timeout=5):
        driver.switch_to.default_content()

        wait_for_block_to_disappear(driver)
        start_time = time.time()
        while True:
            try:

                find_element = WebDriverWait(driver, 10).until(
                    EC.visibility_of_element_located(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                )
                # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                actions = ActionChains(driver)
                actions.move_to_element(find_element).perform()
                # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                input_box = WebDriverWait(driver, 3).until(
                    EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                )
                input_box.clear()
                input_box.send_keys(entry_number)

                # å°è¯•ç‚¹å‡»æŒ‰é’®
                search_button = WebDriverWait(driver, 3).until(
                    EC.element_to_be_clickable(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                )
                search_button.click()

                break  # æˆåŠŸåè·³å‡ºå¾ªç¯

            except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                if time.time() - start_time > timeout:
                    return "è¶…æ—¶"
                    break
                else:
                    time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

    def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
        for attempt in range(retries):
            try:
                check_alert(driver)
                result = action()
                check_alert(driver)
                return result
            except Exception as e:
                print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                check_alert(driver)
                if attempt < retries - 1:
                    time.sleep(retry_delay)
                else:
                    print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                    return "tryfalse"

    def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
        import time
        from selenium.common.exceptions import NoSuchElementException
        from selenium.webdriver.common.by import By

        start_time = time.time()

        while time.time() - start_time < duration:
            try:
                element = driver.find_element(By.XPATH, xpath)
                if element.is_displayed():
                    print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                    time.sleep(1)
                    return True
            except NoSuchElementException:
                print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

            time.sleep(interval)

        print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
        return False

    def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
        try:
            # æ¸…ç©ºå¹¶è¾“å…¥
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
            import time, re
            start_time = time.time()

            # æå– ul çš„ç´¢å¼•
            ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
            if not ul_pattern:
                print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                return

            base_index = int(ul_pattern.group(1))
            prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

            while time.time() - start_time < duration:
                for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                    trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                    print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                    result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                     f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                    if result != "tryfalse":
                        print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                        return

            print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

        except Exception as e:
            print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
            check_alert(driver)

    def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

        try:
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

        except Exception as e:
            # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
            print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

    def page_viewd(driver):
        try:
            iframe = driver.find_element(By.ID, "iframeInvoices")
            driver.switch_to.frame(iframe)
        except:
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))
        ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=20, retry_delay=0.5)
        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[4]/a"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®", retries=1, retry_delay=0.5)
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

        safe_do(driver, lambda: WebDriverWait(driver, 10, poll_frequency=0.5).until(
            EC.element_to_be_clickable((By.XPATH, "//a[contains(@onclick, 'UpdateACEBOL')]"))
        ).click())
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

    file_path = os.path.join(desktop_path, "BBCreview.xlsx")
    file_path = file_path
    df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰è¦å¤„ç†çš„inbond: {filtered_lista}\n\n\n")
    # wait_for_block_to_disappear(driver, timeout=40, check_interval=1)
    # open_entry(driver)
    # for entry_number,house in zip(filtered_lista,filtered_listc):
    #     search_entry_num(entry_number, timeout=5)
    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     check_alert(driver)
    #     # WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click()
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     page_viewd(driver,house)
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
    #     safe_do(driver, lambda: WebDriverWait(driver, 10).until(
    #         EC.element_to_be_clickable((By.XPATH, "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))    ).click(), "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

    #     wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
    #     time.sleep(1)

    wait_for_block_to_disappear(driver, timeout=40, check_interval=1)

    for entry_number in filtered_lista:

        search_entry_num(entry_number, timeout=5)
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        check_alert(driver)
        open_entry(driver)
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

        page_viewd(driver)
        try:
            driver.switch_to.default_content()
            print("æˆåŠŸåˆ‡æ¢å›æ¥")
        except Exception as e:
            print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        time.sleep(1)
        update_output_text(output_text, f"{entry_number}ç»“æŸ")
    update_output_text(output_text, "å…¨éƒ¨å®Œæˆ")


def BBC_House(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, 'æ‰¾åˆ°bbcreviewï¼Œé©¬ä¸Šè¿è¡Œ\n')
            pass
        else:
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, 'æ²¡èƒ½æ‰¾åˆ°bbcreviewï¼Œå·²åˆ›å»ºï¼Œå†æ¬¡ç‚¹å‡»å¼€å§‹è¿è¡Œä»£ç \n')

            sys.exit()
    else:
        sys.exit()
        update_output_text(output_text, 'æœªèƒ½æ‰¾åˆ°bbcreview ä¸”æœªèƒ½åˆ›å»ºexcelï¼Œggäº†\n')

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    try:
        # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
        WebDriverWait(driver, 10).until(
            lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
        )
        print("'sign' found in page source. Continuing...")
    except Exception as e:
        print("Timeout or error while waiting for 'sign':", e)
        driver.quit()
        exit()

    # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
    login_button.click()
    print("Current page title is:", driver.title)
    WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

    try:
        # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
        login_button.click()

        # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
        try:
            logout_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
            )
            logout_button.click()
            print("Clicked the logout button in the alert.")

            # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
            )
            time.sleep(2)
            username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
            username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

            # è¾“å…¥å¯†ç 
            password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
            password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            password_field.send_keys(password)  # è¾“å…¥å¯†ç 
            # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()
            print("Clicked the login button.")

        except TimeoutException:
            print("No alert appeared, proceeding with the login.")

        # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
        WebDriverWait(driver, 10).until(
            EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
        )
        print("Login successful. Page title is:", driver.title)

    except (TimeoutException, NoSuchElementException) as e:
        print(f"Error occurred during login: {e}")
    outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
    driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
    step_status = True

    def check_alert(driver):
        try:
            time.sleep(1)
            alert = driver.switch_to.alert
            alert_text = alert.text
            print("å¼¹çª—å†…å®¹:", alert_text)

            if "cotton" not in alert_text.lower():
                alert.accept()
                print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
            else:
                alert.dismiss()
                print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

            time.sleep(1)
        except NoAlertPresentException:
            pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

    def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
        """
        ç­‰å¾…ä»»ä½• .blockUI.blockMsg å¼€å¤´çš„é®ç½©å±‚ï¼ˆå¦‚ blockElement æˆ– blockPageï¼‰å®Œå…¨æ¶ˆå¤±
        """
        end_time = time.time() + timeout
        while time.time() < end_time:
            try:
                # æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„é®ç½©å±‚ï¼ˆå¯èƒ½å¤šä¸ªï¼‰
                elements = driver.find_elements(By.CSS_SELECTOR, "div.blockUI.blockMsg")
                visible_elements = [el for el in elements if el.is_displayed()]

                if visible_elements:
                    print(f"â³ æ£€æµ‹åˆ° {len(visible_elements)} ä¸ªé®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                    time.sleep(check_interval)
                else:
                    print("âœ… æ‰€æœ‰é®ç½©å±‚å·²éšè—")
                    return
            except (NoSuchElementException, StaleElementReferenceException):
                print("âœ… é®ç½©å±‚ä¸å­˜åœ¨æˆ–å·²è¢«ç§»é™¤")
                return
        print("âŒ ç­‰å¾…è¶…æ—¶ï¼Œé®ç½©å±‚ä»æœªæ¶ˆå¤±")

    def open_entry(driver):
        try:
            driver.switch_to.default_content()
            print("âœ… å·²è¿”å›ä¸»é¡µé¢")
        except Exception as e:
            print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")

        try:
            # æ£€æŸ¥ iframe
            iframes = driver.find_elements(By.TAG_NAME, "iframe")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(iframes)} ä¸ª iframe")
            iframe_switched = False
            if iframes:
                for i, iframe in enumerate(iframes):
                    try:
                        driver.switch_to.frame(iframe)
                        print(f"âœ… åˆ‡æ¢åˆ° iframe {i}")
                        driver.find_element(By.XPATH,
                                            "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]")
                        print("âœ… æ‚¬åœå…ƒç´ åœ¨ iframe ä¸­")
                        iframe_switched = True
                        break
                    except:
                        driver.switch_to.default_content()
                        print(f"âŒ iframe {i} ä¸­æ— ç›®æ ‡å…ƒç´ ï¼Œåˆ‡æ¢å›ä¸»é¡µé¢")
            else:
                print("âœ… æ—  iframe")

            # å®šä½æ‚¬åœå…ƒç´ å¹¶æå– <td> çš„ id
            img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
            print(f"ğŸ” å°è¯•å®šä½æ‚¬åœå…ƒç´ : {img_xpath}")
            img_elements = driver.find_elements(By.XPATH, img_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(img_elements)} ä¸ªæ‚¬åœå…ƒç´ ")
            if len(img_elements) > 1:
                print("âš ï¸ è­¦å‘Š: æ‚¬åœ XPath åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯")
                for i, elem in enumerate(img_elements):
                    print(f"ğŸ” æ‚¬åœå…ƒç´  {i}: {elem.get_attribute('outerHTML')}")
            img_element = img_elements[0] if img_elements else driver.find_element(By.XPATH, img_xpath)
            print(f"âœ… æ‚¬åœå…ƒç´ : {img_element.get_attribute('outerHTML')}")

            # è·å–çˆ¶ <td> çš„ id
            td_element = img_element.find_element(By.XPATH, "./ancestor::td[contains(@id, 'EntrySummary')]")
            td_id = td_element.get_attribute("id")
            print(f"âœ… æ‰¾åˆ°çˆ¶ <td> id: {td_id}")

            # æ‚¬åœå¹¶ç­‰å¾…èœå•åŠ è½½
            ActionChains(driver).move_to_element(img_element).perform()
            print("âœ… å·²æ‰§è¡Œæ‚¬åœæ“ä½œ")
            try:
                WebDriverWait(driver, 5).until(
                    EC.presence_of_element_located((By.XPATH, "//a[contains(@class,'shipment-row')]"))
                )
                print("âœ… èœå•å·²åŠ è½½")
            except TimeoutException:
                print("âŒ èœå•æœªåŠ è½½ï¼Œå¯èƒ½æ‚¬åœå¤±è´¥")

            # æ£€æŸ¥å¼¹çª—
            def check_alert(driver):
                try:
                    alert = driver.switch_to.alert
                    alert.accept()
                    print("âœ… å·²å…³é—­å¼¹çª—")
                except:
                    print("âœ… æ— å¼¹çª—")

            check_alert(driver)

            # æ£€æŸ¥é«˜ z-index å…ƒç´ 
            overlays = driver.find_elements(By.XPATH,
                                            "//*[contains(@style, 'z-index') and not(contains(@style, 'z-index: 0'))]")
            print(f"ğŸ” æ£€æµ‹åˆ° {len(overlays)} ä¸ªé«˜ z-index å…ƒç´ ")
            for overlay in overlays[:3]:
                print(f"ğŸ” è¦†ç›–å±‚: {overlay.get_attribute('outerHTML')}")

            # å®šä½ Edit æŒ‰é’®ï¼Œä½¿ç”¨çˆ¶ <td> çš„ id çº¦æŸ
            timeout = 10
            interval = 1
            start_time = time.time()
            edit_xpath = f"//td[@id='{td_id}']//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]"
            print(f"ğŸ” å°è¯•å®šä½ Edit æŒ‰é’®: {edit_xpath}")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            print(f"ğŸ” æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
            if len(edit_elements) > 1:
                print("âš ï¸ è­¦å‘Š: Edit XPath ä»åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")
            elif len(edit_elements) == 0:
                print("âŒ Edit æŒ‰é’®æœªæ‰¾åˆ°ï¼ŒXPath å¯èƒ½é”™è¯¯æˆ–å…ƒç´ æœªåŠ è½½")
                print(
                    "ğŸ” å°è¯•å¤‡ç”¨ XPath: //a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                edit_elements = driver.find_elements(By.XPATH,
                                                     "//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                print(f"ğŸ” å¤‡ç”¨ XPath æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                for i, elem in enumerate(edit_elements):
                    print(f"ğŸ” å¤‡ç”¨ Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")

            while True:
                try:
                    edit_img = WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, edit_xpath))
                    )
                    print(f"âœ… Edit æŒ‰é’®å®šä½æˆåŠŸ: {edit_img.get_attribute('outerHTML')}")
                    print(f"ğŸ” å…ƒç´ å¯è§: {edit_img.is_displayed()}, å…ƒç´ å¯ç‚¹å‡»: {edit_img.is_enabled()}")
                    try:
                        edit_img.click()
                        print("âœ… ç‚¹å‡» Edit æŒ‰é’®æˆåŠŸ")
                        break
                    except ElementClickInterceptedException as e:
                        print(f"âŒ ç‚¹å‡»è¢«æ‹¦æˆª: {e}")
                        print("ğŸ” å°è¯• JavaScript ç‚¹å‡»")
                        driver.execute_script("arguments[0].click();", edit_img)
                        print("âœ… ä½¿ç”¨ JavaScript ç‚¹å‡» Edit æŒ‰é’®")
                        break
                except TimeoutException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ TimeoutException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†ä¸å¯ç‚¹å‡»: {edit_elements[0].get_attribute('outerHTML')}")
                        else:
                            print("ğŸ” Edit æŒ‰é’®æœªåœ¨ DOM ä¸­æ‰¾åˆ°")
                        break
                    else:
                        print("âŒ å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)
                except ElementClickInterceptedException as e:
                    elapsed = time.time() - start_time
                    print(f"âŒ ElementClickInterceptedException: {e}")
                    if elapsed >= timeout:
                        print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                        print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                        edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                        if edit_elements:
                            print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†è¢«é®æŒ¡: {edit_elements[0].get_attribute('outerHTML')}")
                        break
                    else:
                        print("âŒ å…ƒç´ è¢«æ‹¦æˆªï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                        time.sleep(interval)

            # åˆ‡æ¢å›ä¸»é¡µé¢
            if iframe_switched:
                driver.switch_to.default_content()
                print("âœ… åˆ‡æ¢å›ä¸»é¡µé¢")

        except Exception as e:
            print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
            if edit_elements:
                print(f"ğŸ” Edit æŒ‰é’®: {edit_elements[0].get_attribute('outerHTML')}")
            else:
                print("ğŸ” Edit æŒ‰é’®æœªæ‰¾åˆ°")

    def search_entry_num(entry_number, timeout=5):
        driver.switch_to.default_content()

        wait_for_block_to_disappear(driver)
        start_time = time.time()
        while True:
            try:

                find_element = WebDriverWait(driver, 10).until(
                    EC.visibility_of_element_located(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                )
                # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                actions = ActionChains(driver)
                actions.move_to_element(find_element).perform()
                # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                input_box = WebDriverWait(driver, 3).until(
                    EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                )
                input_box.clear()
                input_box.send_keys(entry_number)

                # å°è¯•ç‚¹å‡»æŒ‰é’®
                search_button = WebDriverWait(driver, 3).until(
                    EC.element_to_be_clickable(
                        (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                )
                search_button.click()

                break  # æˆåŠŸåè·³å‡ºå¾ªç¯

            except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                if time.time() - start_time > timeout:
                    return "è¶…æ—¶"
                    break
                else:
                    time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

    def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
        """æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œï¼ŒåŠ¨ä½œå‰åéƒ½æ£€æµ‹å¹¶å¤„ç† alertï¼Œæ”¯æŒå¤±è´¥åè‡ªåŠ¨é‡è¯•"""
        wait_for_block_to_disappear(driver, timeout=40, check_interval=0.5)
        for attempt in range(retries):
            try:
                check_alert(driver)
                result = action()
                check_alert(driver)
                return result
            except Exception as e:
                print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                check_alert(driver)
                if attempt < retries - 1:
                    print(f"ğŸ” å‡†å¤‡é‡è¯• {description}...")
                    time.sleep(retry_delay)
                else:
                    print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                    return "tryfalse"

    def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
        import time
        from selenium.common.exceptions import NoSuchElementException
        from selenium.webdriver.common.by import By

        start_time = time.time()

        while time.time() - start_time < duration:
            try:
                element = driver.find_element(By.XPATH, xpath)
                if element.is_displayed():
                    print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                    time.sleep(1)
                    return True
            except NoSuchElementException:
                print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

            time.sleep(interval)

        print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
        return False

    def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
        try:
            # æ¸…ç©ºå¹¶è¾“å…¥
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
            import time, re
            start_time = time.time()

            # æå– ul çš„ç´¢å¼•
            ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
            if not ul_pattern:
                print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                return

            base_index = int(ul_pattern.group(1))
            prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

            while time.time() - start_time < duration:
                for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                    trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                    print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                    result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                        EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                     f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                    if result != "tryfalse":
                        print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                        return

            print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

        except Exception as e:
            print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
            check_alert(driver)

    def file_edit(file_path, results_dict):
        wb = openpyxl.load_workbook(file_path)
        ws = wb.active

        def find_first_empty_row_from_col(ws, start_col=5):
            max_check_rows = ws.max_row + 100  # æœ€å¤šæ£€æŸ¥100è¡Œ
            for row in range(1, max_check_rows):
                if all(ws.cell(row=row, column=col).value in [None, ""] for col in range(start_col, start_col + 20)):
                    return row
            return ws.max_row + 1

        current_row = find_first_empty_row_from_col(ws, start_col=5)

        for entry_list in results_dict.values():
            for entry in entry_list:
                # ç¬¬5åˆ— line å­—æ®µæ¸…æ´— â†’ æå– of åæ•°å­—
                raw_line = entry.get("line", "")
                match = re.search(r"of\s+(\d+)", raw_line)
                entry["line"] = match.group(1) if match else raw_line  # ä¿ç•™æ•°å­—

                # ç¬¬8åˆ— port1 å­—æ®µæ¸…æ´— â†’ æå–æœ€åæ•°å­—
                raw_port1 = entry.get("port1", "")
                if "-" in raw_port1:
                    entry["port1"] = raw_port1.split("-")[-1].strip()
                else:
                    entry["port1"] = raw_port1

                # å†™å…¥æ¸…æ´—åçš„å€¼ï¼Œä»ç¬¬5åˆ—å¼€å§‹å†™
                values = list(entry.values())
                for i, value in enumerate(values):
                    ws.cell(row=current_row, column=5 + i, value=value)
                current_row += 1

        wb.save(file_path)

    def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

        try:
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
            safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

        except Exception as e:
            # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
            print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

    results_dict = {}

    def page_viewd(driver, house):
        result = []
        data_dict = {}
        try:
            try:
                iframe = driver.find_element(By.ID, "iframeInvoices")
                driver.switch_to.frame(iframe)
            except:
                pass
            success = wait_for_autocomplete(driver,
                                            "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/a[2]",
                                            0.5, 8.0)

            if success:
                line_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/form/div/div/fieldset/div/div/div[2]/div[2]/div[1]"
                importer_xpath = "/html/body/form/div[3]/div[2]/div[1]/div/fieldset/div[1]/input"
                qty_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[2]/div[4]/input"
                port1_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/div[3]/div[4]/input"
                port2_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/div[3]/div[16]/input"
                paytype_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/div[3]/div[16]/input"
                remote_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[2]/div/div/div/table/tbody/tr[2]/td[1]/div/input"
                house_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[3]/div[3]/input"
                statementdate_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/div[4]/div[8]/input"
                try:
                    data_dict['line'] = driver.find_element(By.XPATH, line_xpath).text.strip()
                except:
                    data_dict['line'] = ""

                try:
                    data_dict['importer'] = driver.find_element(By.XPATH, importer_xpath).get_attribute("value").strip()
                except:
                    data_dict['importer'] = ""

                try:
                    data_dict['qty'] = driver.find_element(By.XPATH, qty_xpath).get_attribute("value").strip()
                except:
                    data_dict['qty'] = ""

                try:
                    data_dict['port1'] = driver.find_element(By.XPATH, port1_xpath).get_attribute("value").strip()
                except:
                    data_dict['port1'] = ""

                try:
                    data_dict['port2'] = driver.find_element(By.XPATH, port2_xpath).get_attribute("value").strip()
                except:
                    data_dict['port2'] = ""

                try:
                    data_dict['paytype'] = driver.find_element(By.XPATH, paytype_xpath).get_attribute("value").strip()
                except:
                    data_dict['paytype'] = ""

                try:
                    checkbox_element = driver.find_element(By.XPATH, remote_xpath)
                    data_dict['remote_checked'] = checkbox_element.is_selected()
                except:
                    data_dict['remote_checked'] = False

                try:
                    data_dict['house'] = driver.find_element(By.XPATH, house_xpath).get_attribute("value").strip()
                except:
                    data_dict['house'] = ""

                try:
                    data_dict['statementdate'] = driver.find_element(By.XPATH, statementdate_xpath).get_attribute(
                        "value").strip()
                except:
                    data_dict['statementdate'] = ""

                # æŠŠå­—å…¸æ”¾è¿›åˆ—è¡¨
                result.append(data_dict)

                click_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/a[2]"
                btn = driver.find_element(By.XPATH, click_xpath)
                btn.click()

                # æå– SCAC, QTR, UOM çš„ä¸‰ä¸ªè¾“å…¥æ¡†å†…å®¹
                scac_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[2]/div[2]/input"
                qtr_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[2]/div[4]/input"
                uom_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[2]/div[5]/input"

                scac = driver.find_element(By.XPATH, scac_xpath).get_attribute('value')
                qtr = driver.find_element(By.XPATH, qtr_xpath).get_attribute('value')
                uom = driver.find_element(By.XPATH, uom_xpath).get_attribute('value')

                # ç”¨ä¸‰ä¸ªå€¼å¡«å…¥è¡¨å•
                input_1_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[3]/div[2]/input"
                input_2_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[3]/div[3]/input"
                input_3_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[3]/div[4]/input"
                input_4_xpath = "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[2]/div[2]/fieldset/div[3]/div/div[4]/form/div/fieldset[3]/div/div/div[2]/div[3]/div[5]/input"
                data_entry(driver, input_1_xpath, "/html/body/ul[24]/li[1]/div", 0.5, 8.0, scac)

                normal_entry(driver, input_2_xpath, 0.5, 8.0, house)
                normal_entry(driver, input_3_xpath, 0.5, 8.0, qtr)
                data_entry(driver, input_4_xpath, "/html/body/ul[25]/li[1]/div", 0.5, 8.0, uom)
                return result

            else:
                return None
                print("å…ƒç´ æœªåŠ è½½æˆåŠŸï¼Œè·³è¿‡å¤„ç†ã€‚")

        except Exception as e:
            return None
            print("å‘ç”Ÿå¼‚å¸¸:", e)

    file_path = os.path.join(desktop_path, "BBCreview.xlsx")
    file_path = file_path
    df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—
    c_column = df.iloc[:, 2]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()
    filtered_listc = c_column[c_column.notna() & (c_column != 'na')].tolist()
    print(filtered_listc)

    results_dict = {}
    wait_for_block_to_disappear(driver, timeout=600, check_interval=1)
    # open_entry(driver)
    # wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

    for entry_number, house in zip(filtered_lista, filtered_listc):
        update_output_text(output_text, f"æ­£åœ¨å¤„ç†{entry_number}\n")
        search_entry_num(entry_number, timeout=5)
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)
        check_alert(driver)
        open_entry(driver)
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        info_text = page_viewd(driver, house)
        results_dict[entry_number] = info_text
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable((By.XPATH,
                                        "//html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)
        update_output_text(output_text, f"å¤„ç†å·²å®Œæˆ{entry_number}\n")
        try:
            driver.switch_to.default_content()
            print("æˆåŠŸåˆ‡æ¢å›æ¥")
        except Exception as e:
            print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
            pass
        safe_do(driver, lambda: WebDriverWait(driver, 10).until(
            EC.element_to_be_clickable(
                (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
        wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
        time.sleep(1)

        wait_for_block_to_disappear(driver, timeout=600, check_interval=1)
        time.sleep(1)

    file_edit(file_path, results_dict)
    update_output_text(output_text, "æ–‡ä»¶å·²ä¿å­˜\n")


def BBC_review_program(account, password, output_text):
    from seleniumwire import webdriver
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()
    data_dict = {}

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, "å·²æ‰¾åˆ°BBCreview\n")
            pass
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, "å·²åˆ›å»ºBBCreviewï¼Œå†æ¬¡è¿è¡Œå³å¯å¼€å§‹ä»£ç \n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "åˆ›å»ºexcelå¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # å›ºå®šè·¯å¾„ï¼šAppData\Local
    fixed_path = os.path.join(user_home, "AppData", "Local")
    txt_file_path = os.path.join(fixed_path, "origincode.txt")

    if not os.path.exists(txt_file_path):
        try:
            with open(txt_file_path, 'w', encoding='utf-8') as f:
                pass  # åˆ›å»ºç©ºæ–‡ä»¶
            update_output_text(output_text, 'å·²åŒ¹é…è‡³larryæœ¬åœ°æœåŠ¡å™¨, è¯·å†ç‚¹å‡»ä¸€æ¬¡è¿è¡Œä»¥è¿è¡Œ\n')
            sys.exit()
        except Exception as e:
            update_output_text(output_text, 'è¿æ¥å¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n')
            sys.exit()
    else:
        update_output_text(output_text, 'æ­£åœ¨åƒlarryæœåŠ¡å™¨ä¼ é€å†…å®¹ï¼Œå¼€å§‹ä»£ç \n')
        time.sleep(5)
        update_output_text(output_text, 'å·²è¿æ¥larryæœ¬åœ°æœåŠ¡å™¨ï¼Œå¼€å§‹ä»£ç \n')

    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
    chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
    chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
    chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
    chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
    chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

    # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
    driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
    driver.set_window_size(1920, 1080)

    # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
    driver.get("https://www.google.com")
    driver.execute_script("document.body.style.zoom='50%'")
    url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
    driver.get(url)
    driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

    all_tabs = driver.window_handles
    all_tabs = driver.window_handles

    # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
    for tab in all_tabs:
        driver.switch_to.window(tab)
        if "data:" in driver.current_url:
            driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

    # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
    all_tabs = driver.window_handles

    # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
    if all_tabs:
        driver.switch_to.window(all_tabs[0])

    try:
        # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
        WebDriverWait(driver, 10).until(
            lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
        )
        print("'sign' found in page source. Continuing...")
    except Exception as e:
        print("Timeout or error while waiting for 'sign':", e)
        driver.quit()
        exit()

    # è¾“å…¥è´¦å·å’Œå¯†ç 
    username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
    password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

    # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
    username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
    username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

    # è¾“å…¥å¯†ç 
    password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
    password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
    password_field.send_keys(password)  # è¾“å…¥å¯†ç 

    # ç‚¹å‡»ç™»å½•æŒ‰é’®
    login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
    login_button.click()
    print("Current page title is:", driver.title)
    WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

    try:
        # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
        login_button.click()

        # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
        try:
            logout_button = WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
            )
            logout_button.click()
            print("Clicked the logout button in the alert.")

            # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
            WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
            )
            time.sleep(2)
            username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
            username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

            # è¾“å…¥å¯†ç 
            password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
            password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
            password_field.send_keys(password)  # è¾“å…¥å¯†ç 
            # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()
            print("Clicked the login button.")

        except TimeoutException:
            print("No alert appeared, proceeding with the login.")

        # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
        WebDriverWait(driver, 10).until(
            EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
        )
        print("Login successful. Page title is:", driver.title)

    except (TimeoutException, NoSuchElementException) as e:
        print(f"Error occurred during login: {e}")


    def get_cookies_from_selenium(driver):
        cookies = driver.get_cookies()
        # æŠŠ selenium çš„ cookie è½¬æˆ requests èƒ½ç”¨çš„æ ¼å¼
        cookie_dict = {c['name']: c['value'] for c in cookies}
        return "; ".join([f"{k}={v}" for k, v in cookie_dict.items()])

    def status_api(entry_number, cookie_str):
        url = "https://my.acelynknavigator.com/Desktop/Default.aspx/GetImporterShipments"
        headers = {
            "Content-Type": "application/json; charset=UTF-8",
            "X-Requested-With": "XMLHttpRequest",
            "Origin": "https://my.acelynknavigator.com",
            "Referer": "https://my.acelynknavigator.com/",
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36",
            "Cookie": cookie_str,
        }
        payload = {
            "id": "0",
            "startDate": "",
            "endDate": "",
            "brokerRef": "",
            "importerRef": "",
            "bol": "",
            "invoiceNumber": "",
            "container": "",
            "entryNumber": str(entry_number),
            "partialSearch": True,
            "releasePort": "",
            "userName": "",
            "vesselName": ""
        }
        session = requests.Session()
        retries = Retry(total=3, backoff_factor=1, status_forcelist=[502, 503, 504])
        session.mount('https://', HTTPAdapter(max_retries=retries))

        try:
            response = session.post(url, headers=headers, data=json.dumps(payload), timeout=30)
            print(response.status_code)
            response = response.text
            return response
        except (ConnectionError, Timeout, RequestException) as e:
            print(f"è¯·æ±‚å¤±è´¥: {e}")
            return None

    def get_entrystatus(response):
        try:
            data_outer = json.loads(response)

            # è§£æå†…å±‚çš„å­—ç¬¦ä¸²ä¸ºåˆ—è¡¨
            data_list = json.loads(data_outer['d'])

            # å–ç¬¬ä¸€ä¸ªå­—å…¸
            item = data_list[0]

            def extract_or_error(key):
                val = item.get(key)
                if val is None:
                    return "N/A"
                return val

            def extract_img_filename_or_null(html_str):
                if not html_str or html_str == "N/A":
                    return None
                m = re.search(r'/images/icons/([^"]+\.png)', html_str)
                if m:
                    return m.group(1)
                return None

            InvoiceNumber = extract_or_error("InvoiceNumber")
            EntryNumber = extract_or_error("EntryNumber")
            StatusOverride3461 = extract_img_filename_or_null(extract_or_error("CargoReleaseStatusFlag")) or "N/A"
            EntrySummaryStatusFlag = extract_img_filename_or_null(extract_or_error("EntrySummaryStatusFlag")) or "N/A"
            BillStatusFlag = extract_img_filename_or_null(extract_or_error("BillStatusFlag")) or "N/A"
            PGA = extract_or_error("PGA")
            EntrySummaryId = extract_or_error("EntrySummaryId")

            print(InvoiceNumber)
            print(EntryNumber)
            print(StatusOverride3461)
            print(EntrySummaryStatusFlag)
            print(BillStatusFlag)
            print(PGA)
            print(EntrySummaryId)

            return InvoiceNumber, EntryNumber, StatusOverride3461, EntrySummaryStatusFlag, BillStatusFlag, PGA, EntrySummaryId


        except:
            return None, None, None, None, None, None, None

    GREEN = PatternFill(start_color="00C6EFCE", end_color="00C6EFCE", fill_type="solid")
    YELLOW = PatternFill(start_color="00FFEB9C", end_color="00FFEB9C", fill_type="solid")
    RED = PatternFill(start_color="00FFC7CE", end_color="00FFC7CE", fill_type="solid")
    GRAY = PatternFill(start_color="00D9D9D9", end_color="00D9D9D9", fill_type="solid")
    PURPLE = PatternFill(start_color="00B4A7D6", end_color="00B4A7D6", fill_type="solid")

    # ä¸»æµç¨‹
    wb = openpyxl.load_workbook(file_path)
    ws = wb.active
    # ä»ç¬¬1è¡Œå¼€å§‹è¯»å–ï¼ˆåŒ…æ‹¬è¡¨å¤´ï¼‰
    first_column_values = [ws.cell(row=row, column=1).value for row in range(1, ws.max_row + 1)]
    update_output_text(output_text, f"æ‰€æœ‰è¦å¤„ç†çš„entry:{first_column_values}\n")
    print(f"First column values: {first_column_values}")

    # è·å– cookieï¼ˆç§»åˆ°å¾ªç¯å¤–ï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
    cookie_str = get_cookies_from_selenium(driver)
    print(f"Cookie string: {cookie_str}")

    # éå†ç¬¬ä¸€åˆ—
    for row_index, entry in enumerate(first_column_values, start=1):
        if not entry:
            print(f"Skipping row {row_index}: empty entry")
            continue

        # å¦‚æœæ˜¯è¡¨å¤´è¡Œï¼Œç‰¹æ®Šå¤„ç†ï¼ˆå¯é€‰ï¼‰
        if row_index == 1 and "entry" in str(entry).lower():  # å‡è®¾è¡¨å¤´åŒ…å« "entry"
            print(f"Skipping header row: {entry}")
            continue

        # è°ƒç”¨æ¥å£
        raw_status = status_api(entry, cookie_str)
        print(f"Row {row_index}: entry = {entry}, raw_status = {raw_status}")

        # è§£ææ•°æ®
        values = get_entrystatus(raw_status)
        print(f"Row {row_index}: values = {values}")

        # å†™å…¥ 3-9 åˆ—
        for col, val in enumerate(values, start=3):
            print(f"Writing to row {row_index}, column {col}: {val}")
            ws.cell(row=row_index, column=col, value=val)

    # å†™å…¥ç¬¬ 10 åˆ—å’Œç¬¬ 11 åˆ—
    for row_index in range(1, ws.max_row + 1):
        col6_val = str(ws.cell(row=row_index, column=6).value).lower()
        col7_val = str(ws.cell(row=row_index, column=7).value).lower()

        col8_val = str(ws.cell(row=row_index, column=8).value).lower()
        print(f"Row {row_index}: col6_val = {col6_val}, col8_val = {col8_val}")
        if "red" in col7_val:
            ws.cell(row=row_index, column=7).fill = RED
        # ç¬¬10åˆ—
        if "green" in col6_val:
            ws.cell(row=row_index, column=10, value="RELEASED").fill = GREEN
        else:
            if "yellow" in col6_val:
                color = YELLOW
            elif "red" in col6_val:
                color = RED
            elif "white" in col6_val:
                color = GRAY
            else:
                color = PURPLE
            ws.cell(row=row_index, column=10, value="AI SUBMIT").fill = color

        # ç¬¬11åˆ—
        if "accepted" in col8_val:
            ws.cell(row=row_index, column=11, value="MAY PROCEED").fill = GREEN
        elif "n/a" in col8_val or "new" in col8_val:
            ws.cell(row=row_index, column=11, value="MAY PROCEED").fill = GREEN
        elif "pending" in col8_val:
            ws.cell(row=row_index, column=11, value="CPSC REVIEW").fill = YELLOW
        else:
            ws.cell(row=row_index, column=11, value="ISSUE").fill = RED

    # ä¿å­˜æ–‡ä»¶
    wb.save(file_path)
    wb.close()
    update_output_text(output_text, "ä»£ç å®Œæˆ\n\n")



def transmit_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰éœ€è¦å¤„ç†çš„inbond: {filtered_list}\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={'054294590'}"
    # æ‰“å¼€é¡µé¢
    driver.get(target_url)
    # éå† filtered_list ä¸­çš„æ¯ä¸ªé¡¹ç›®
    for item in filtered_list:
        if windowname != "task":
            print("çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚")  # è°ƒè¯•æ‰“å°
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
            sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº
        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        # æ‰“å¼€é¡µé¢
        driver.get(target_url)

        current_title = driver.title
        update_output_text(output_text, f"æ­£åœ¨å¤„ç†{item}\n")

        try:
            # æŸ¥æ‰¾ç‰¹å®šçš„å…ƒç´ ï¼Œå¢åŠ æœ€é•¿ç­‰å¾…æ—¶é—´
            element_xpath = '/html/body/table/tbody/tr[2]/td[2]/table[5]/tbody/tr[1]/td[2]/input'

            # ç­‰å¾…æœ€å¤š 50 ç§’ï¼Œç›´åˆ°å…ƒç´ å¯ç‚¹å‡»
            element = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, element_xpath))
            )

            # å¦‚æœå…ƒç´ å­˜åœ¨å¹¶ä¸”å¯ç‚¹å‡»ï¼Œç‚¹å‡»å®ƒ
            element.click()

        except Exception as e:
            # å¦‚æœå…ƒç´ æœªæ‰¾åˆ°æˆ–ä¸å¯ç‚¹å‡»ï¼Œæ‰“å°æ¶ˆæ¯
            update_output_text(output_text, f"æ²¡æœ‰æ‰¾åˆ°å…ƒç´  {item} çš„æŒ‰é’®ï¼é”™è¯¯: {e}\n")

    # ç­‰å¾…ç”¨æˆ·è¾“å…¥åå…³é—­æµè§ˆå™¨
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


def hold_program(account, password, output_text, inputnum):
    global windowname
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "æ‰¾hold.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—
    c_column = df.iloc[:, 2]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()

    filtered_listc = c_column.dropna().apply(
        lambda x: int(x) if isinstance(x, (int, float)) and x == int(x) else x).tolist()

    # æ‰“å°ç»“æœ
    update_output_text(output_text, filtered_list)
    update_output_text(output_text, "\n\n")  # æ·»åŠ ä¸¤ä¸ªæ¢è¡Œç¬¦
    update_output_text(output_text, filtered_listc)
    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = "https://www.netchb.com/app/inbond/inbondMenu.do?itNo=862326905"
    driver.get(target_url)

    current_title = driver.title
    current_frame = tk.Frame(root)
    current_frame.pack()
    print(windowname)
    if inputnum == "ä»…æŸ¥æ‰¾":
        for itNo in filtered_list:
            # è°ƒè¯•æ‰“å°
            if windowname != "task":
                print("çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚")  # è°ƒè¯•æ‰“å°
                update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
                sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº

            target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={itNo}"
            driver.get(target_url)

            try:
                # ç­‰å¾…è¡¨æ ¼åŠ è½½
                wait = WebDriverWait(driver, 10)
                table_body = wait.until(
                    EC.presence_of_element_located((By.XPATH, '//*[@id="manifestBody"]'))
                )

                for b_element in filtered_listc:
                    # if (itNo, b_element) in found_records:
                    #     continue  # è·³è¿‡å·²æ‰¾åˆ°çš„ filterb

                    try:
                        # æŸ¥æ‰¾åŒ…å« b_element çš„å…ƒç´ 
                        record_element = table_body.find_element(By.XPATH, f".//*[contains(text(), '{b_element}')]")

                        update_output_text(output_text, f"æ‰¾åˆ°åŒ¹é…é¡¹: {itNo} - {b_element}")

                    except NoSuchElementException:
                        continue  # æœªæ‰¾åˆ° b_elementï¼Œç»§ç»­æ‰¾ä¸‹ä¸€ä¸ª

            except Exception as e:
                update_output_text(output_text, f"é”™è¯¯å‘ç”Ÿåœ¨ {itNo}: {e}")
        time.sleep(0.5)
        update_output_text(output_text, f"åŒ¹é…ç»“æœ: {000}")
    if inputnum == "åˆ é™¤":

        found_records = []
        for itNo in filtered_list:
            if windowname != "task":
                update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
                sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº

            target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={itNo}"
            driver.get(target_url)

            try:
                # ç­‰å¾…è¡¨æ ¼åŠ è½½
                wait = WebDriverWait(driver, 10)
                table_body = wait.until(
                    EC.presence_of_element_located((By.XPATH, '//*[@id="manifestBody"]'))
                )

                rows = table_body.find_elements(By.XPATH, ".//tr")  # è·å–æ‰€æœ‰è¡Œ

                for b_element in filtered_listc:
                    # if (itNo, b_element) in found_records:
                    #     continue  # è·³è¿‡å·²æ‰¾åˆ°çš„ filterb

                    try:
                        record_element = table_body.find_element(By.XPATH, f".//*[contains(text(), '{b_element}')]")
                    except NoSuchElementException:
                        continue  # æ²¡æ‰¾åˆ°ç›´æ¥è·³è¿‡

                    b_element_str = str(b_element)  # è½¬æ¢ b_element ä¸ºå­—ç¬¦ä¸²
                    found_in_row = False  # æ ‡è®°æ˜¯å¦æ‰¾åˆ°åŒ¹é…é¡¹

                    for idx, row in enumerate(rows, start=1):
                        cell_elements = row.find_elements(By.XPATH, ".//td")
                        for cell in cell_elements:
                            if b_element_str in str(cell.text):  # å¼ºåˆ¶è½¬æ¢ cell.text è¿›è¡ŒåŒ¹é…
                                found_records.append((itNo, b_element))  # è®°å½•å·²æ‰¾åˆ°

                                delete_button_xpath = f'/html/body/table/tbody/tr[2]/td[2]/table[3]/tbody/tr/td[1]/table[2]/tbody/tr[{idx}]/td[5]/input'
                                abutton_xpath = f'/html/body/table/tbody/tr[2]/td[2]/table[3]/tbody/tr/td[1]/table[2]/tbody/tr[{idx}]/td[2]'

                                try:
                                    delete_button = WebDriverWait(driver, 5).until(
                                        EC.element_to_be_clickable((By.XPATH, delete_button_xpath))
                                    )

                                except Exception as e:
                                    continue  # å¦‚æœæ‰¾ä¸åˆ° delete_buttonï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ

                                try:
                                    button_element = driver.find_element(By.XPATH, abutton_xpath)
                                    update_output_text(output_text, f"{itNo}ä¸­çš„{button_element.text}")


                                except NoSuchElementException:
                                    continue  # å¦‚æœæ‰¾ä¸åˆ° abuttonï¼Œåˆ™è·³è¿‡å½“å‰è¡Œ

                                delete_button.click()
                                time.sleep(0.5)

                                try:
                                    alert = driver.switch_to.alert  # è·å–å½“å‰å¼¹çª—
                                    alert.accept()  # ç‚¹å‡»ç¡®è®¤æŒ‰é’®
                                    time.sleep(0.5)
                                    update_output_text(output_text, "æˆåŠŸåˆ é™¤")
                                except NoAlertPresentException:
                                    pass

                                # åˆ é™¤åé‡æ–°è·å– table_body å’Œ rows
                                table_body = wait.until(
                                    EC.presence_of_element_located((By.XPATH, '//*[@id="manifestBody"]'))
                                )
                                rows = table_body.find_elements(By.XPATH, ".//tr")  # é‡æ–°è·å–æ‰€æœ‰è¡Œ

                                found_in_row = True
                                break  # è·³å‡ºå½“å‰è¡Œå¤„ç†
                        if found_in_row:
                            break  # é€€å‡ºå¤–å±‚å¾ªç¯
            except Exception as e:
                continue  # å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªè®°å½•
        time.sleep(0.5)
        update_output_text(output_text, "åŒ¹é…ç»“æœ:", found_records)

    update_output_text(output_text, current_title)
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


def statuschange_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰éœ€è¦å¤„ç†çš„inbond: {filtered_list}\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={'054294590'}"
    # æ‰“å¼€é¡µé¢
    driver.get(target_url)
    # éå† filtered_list ä¸­çš„æ¯ä¸ªé¡¹ç›®
    for item in filtered_list:

        if windowname != "task":
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
            sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº

        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        # æ‰“å¼€é¡µé¢
        driver.get(target_url)

        current_title = driver.title
        update_output_text(output_text, f"æ­£åœ¨å¤„ç† {item}")

        try:
            # æŸ¥æ‰¾ç‰¹å®šçš„å…ƒç´ ï¼Œå¢åŠ æœ€é•¿ç­‰å¾…æ—¶é—´
            element_xpath = '/html/body/table/tbody/tr[2]/td[1]/table[1]/tbody/tr[10]/td[2]/a'

            # ç­‰å¾…æœ€å¤š 20 ç§’ï¼Œç›´åˆ°å…ƒç´ å¯ç‚¹å‡»
            element = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, element_xpath))
            )

            # å¦‚æœå…ƒç´ å­˜åœ¨å¹¶ä¸”å¯ç‚¹å‡»ï¼Œç‚¹å‡»å®ƒ
            element.click()

            # ç­‰å¾…æ–°é¡µé¢åŠ è½½å®Œæˆ
            select_xpath = '//*[@id="changeInbondStatusTo"]'
            select_element = WebDriverWait(driver, 20).until(
                EC.presence_of_element_located((By.XPATH, select_xpath))
            )

            # ä½¿ç”¨ Select ç±»é€‰æ‹© "Accepted" é€‰é¡¹
            select = Select(select_element)
            select.select_by_value("ACCEPTED")  # ä½¿ç”¨ value å±æ€§é€‰æ‹© "Accepted"

            update_output_text(output_text, f"Successfully selected 'Accepted' for {item}.")

            button_xpath = '//*[@id="changeInbondStatusButton"]'
            target_button = WebDriverWait(driver, 20).until(
                EC.element_to_be_clickable((By.XPATH, button_xpath))
            )
            target_button.click()
            update_output_text(output_text, f"Successfully clicked the target button for {item}.")

        except Exception as e:
            # å¦‚æœå…ƒç´ æœªæ‰¾åˆ°æˆ–ä¸å¯ç‚¹å‡»ï¼Œæ‰“å°æ¶ˆæ¯
            update_output_text(output_text, f"æ²¡æœ‰æ‰¾åˆ°å…ƒç´ æˆ–å‘ç”Ÿé”™è¯¯ {item}ï¼é”™è¯¯: {e}")

    # ç­‰å¾…ç”¨æˆ·è¾“å…¥åå…³é—­æµè§ˆå™¨
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


def del_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰éœ€è¦æ“ä½œçš„inbond: {filtered_list}\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={'054294590'}"
    # æ‰“å¼€é¡µé¢
    driver.get(target_url)
    # éå† filtered_list ä¸­çš„æ¯ä¸ªé¡¹ç›®

    for item in filtered_list:
        if windowname != "task":
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
            sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº
        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        # æ‰“å¼€é¡µé¢
        driver.get(target_url)

        current_title = driver.title
        update_output_text(output_text, f"æ­£åœ¨å¤„ç†{item}\n")

        try:
            # æŸ¥æ‰¾ç‰¹å®šçš„å…ƒç´ ï¼Œå¢åŠ æœ€é•¿ç­‰å¾…æ—¶é—´
            element_xpath = '/html/body/table/tbody/tr[2]/td[1]/table[1]/tbody/tr[8]/td[2]/a'

            # ç­‰å¾…æœ€å¤š 20 ç§’ï¼Œç›´åˆ°å…ƒç´ å¯ç‚¹å‡»
            element = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, element_xpath))
            )

            # å¦‚æœå…ƒç´ å­˜åœ¨å¹¶ä¸”å¯ç‚¹å‡»ï¼Œç‚¹å‡»å®ƒ
            element.click()
            try:
                # æŸ¥æ‰¾ç‰¹å®šçš„å…ƒç´ ï¼Œå¢åŠ æœ€é•¿ç­‰å¾…æ—¶é—´
                element_xpath = '/html/body/table/tbody/tr[2]/td[2]/table[3]/tbody/tr[2]/td/input'

                # ç­‰å¾…æœ€å¤š 20 ç§’ï¼Œç›´åˆ°å…ƒç´ å¯ç‚¹å‡»
                element = WebDriverWait(driver, 50).until(
                    EC.element_to_be_clickable((By.XPATH, element_xpath))
                )

                # å¦‚æœå…ƒç´ å­˜åœ¨å¹¶ä¸”å¯ç‚¹å‡»ï¼Œç‚¹å‡»å®ƒ
                element.click()


            except Exception as e:
                update_output_text(output_text, f"ç‚¹å‡»ç¡®è®¤æŒ‰é’®æ—¶å‡ºé”™ï¼š{e}\n")

                # å¦‚æœå…ƒç´ æœªæ‰¾åˆ°æˆ–ä¸å¯ç‚¹å‡»ï¼Œæ‰“å°æ¶ˆæ¯

        except Exception as e:
            # å¦‚æœå…ƒç´ æœªæ‰¾åˆ°æˆ–ä¸å¯ç‚¹å‡»ï¼Œæ‰“å°æ¶ˆæ¯
            update_output_text(output_text, f"æ²¡æœ‰æ‰¾åˆ°å…ƒç´  {item} çš„æŒ‰é’®ï¼é”™è¯¯: {e}\n")

    # ç­‰å¾…ç”¨æˆ·è¾“å…¥åå…³é—­æµè§ˆå™¨
    input("æŒ‰ Enter é”®å…³é—­æµè§ˆå™¨...")
    driver.quit()


def delallinbond_program(account, password, output_text):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    # è·å–ç”¨æˆ·ä¸»ç›®å½•
    user_home = os.path.expanduser("~")

    # æ£€æµ‹å¯èƒ½çš„æ¡Œé¢è·¯å¾„
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    # æŸ¥æ‰¾å­˜åœ¨çš„æ¡Œé¢è·¯å¾„
    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n")
        sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

    # è¯»å– Excel æ–‡ä»¶
    df = pd.read_excel(file_path, header=None, dtype=str)  # å¦‚æœæ²¡æœ‰åˆ—åï¼Œä½¿ç”¨ header=None

    # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
    a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—

    # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰éœ€è¦æ“ä½œçš„inbond: {filtered_list}\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    # ç­‰å¾… Password è¾“å…¥æ¡†å‡ºç°å¹¶è¾“å…¥å¯†ç 
    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()
    target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={'054294590'}"
    # æ‰“å¼€é¡µé¢
    driver.get(target_url)
    # éå† filtered_list ä¸­çš„æ¯ä¸ªé¡¹ç›®

    for item in filtered_list:
        if windowname != "task":
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
            sys.exit()  # çª—å£å·²å…³é—­ï¼Œé€€å‡ºç¨‹åº
        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        # æ‰“å¼€é¡µé¢
        driver.get(target_url)

        try:
            # ç­‰å¾…é¡µé¢åŠ è½½
            wait = WebDriverWait(driver, 10)
            table_body = wait.until(
                EC.presence_of_element_located((By.XPATH, '//*[@id="manifestBody"]'))
            )

            while True:
                try:
                    # æŸ¥æ‰¾åˆ é™¤æŒ‰é’®å¹¶ç‚¹å‡»
                    delete_button = driver.find_element(By.XPATH,
                                                        '/html/body/table/tbody/tr[2]/td[2]/table[3]/tbody/tr/td[1]/table[2]/tbody/tr[4]/td[5]/input')
                    delete_button.click()
                    time.sleep(0.5)

                    # å¤„ç†å¼¹çª—
                    try:
                        alert = driver.switch_to.alert  # æ­£ç¡®æ–¹å¼ï¼Œç›´æ¥è®¿é—® alert
                        alert.accept()  # ç‚¹å‡»ç¡®è®¤æŒ‰é’®
                        time.sleep(0.5)
                    except NoAlertPresentException:
                        update_output_text(output_text, f"æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡å¼¹çª—å¤„ç†ã€‚")

                except NoSuchElementException:
                    update_output_text(output_text, f"å…ƒç´  {filter} çš„åˆ é™¤æŒ‰é’®ä¸å­˜åœ¨ï¼Œé€€å‡ºå¾ªç¯ã€‚")

                    break

        except Exception as e:
            update_output_text(output_text, f"é”™è¯¯å‘ç”Ÿåœ¨ {filter}: {e}")


def headeredit_program(account, password, output_text, inputnum):
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    user_home = os.path.expanduser("~")
    possible_paths = [
        os.path.join(user_home, "Desktop"),
        os.path.join(user_home, "æ¡Œé¢"),
        os.path.join(user_home, "OneDrive", "Desktop"),
        os.path.join(user_home, "OneDrive", "æ¡Œé¢")
    ]

    desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

    if desktop_path:
        file_path = os.path.join(desktop_path, "extract.xlsx")
        if os.path.exists(file_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{file_path}\n\n")
        else:
            wb = Workbook()
            wb.save(file_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{file_path}\n\n")
            sys.exit()
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()

    if desktop_path:
        excel_path = os.path.join(desktop_path, "headeredit.xlsx")
        if os.path.exists(excel_path):
            update_output_text(output_text, f"æ‰¾åˆ°æ–‡ä»¶ï¼š{excel_path}\n\n")
        else:
            wb = Workbook()
            wb.save(excel_path)
            update_output_text(output_text, f"æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå·²åˆ›å»ºæ–°æ–‡ä»¶ï¼š{excel_path}\n\n")
            sys.exit()
    else:
        update_output_text(output_text, "æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ¡Œé¢è·¯å¾„\n\n")
        sys.exit()

    if inputnum not in ["61", "63"]:
        update_output_text(output_text, "æ— æ•ˆè¾“å…¥ï¼Œè¯·è¾“å…¥61æˆ–63ï¼\n\n")
        exit()

    try:
        workbook = openpyxl.load_workbook(excel_path)
        sheet = workbook.active
    except Exception as e:
        update_output_text(output_text, f"æ— æ³•æ‰“å¼€Excelæ–‡ä»¶ï¼š{e}\n\n")
        exit()

    if inputnum == "63":
        editdate = sheet["B2"].value or "N/A"
        editcarrier = sheet["B3"].value or "N/A"
        editvessel = sheet["B4"].value or "N/A"
        editdestination = sheet["B5"].value or "N/A"
        editvoyage = sheet["B6"].value or "N/A"
        presentation_port = sheet["B7"].value or "N/A"
        port_of_unlading = sheet["B8"].value or "N/A"
        consigned_to_port = sheet["B9"].value or "N/A"
        goodnow = "N/A"
        CarrierID = sheet["B10"].value or "N/A"
        Entrytype = str(sheet["B11"].value or "N/A")
        Lastfp = "N/A"
    elif inputnum == "61":
        editdate = sheet["I2"].value or "N/A"
        editcarrier = sheet["I3"].value or "N/A"
        editvessel = sheet["I4"].value or "N/A"
        goodnow = sheet["I5"].value or "N/A"
        editvoyage = sheet["I6"].value or "N/A"
        presentation_port = sheet["I7"].value or "N/A"
        port_of_unlading = sheet["I8"].value or "N/A"
        consigned_to_port = sheet["I9"].value or "N/A"
        editdestination = "N/A"
        CarrierID = sheet["I10"].value or "N/A"
        Entrytype = str(sheet["I12"].value or "N/A")
        Lastfp = sheet["I11"].value or "N/A"

    update_output_text(output_text, "æå–çš„æ•°æ®å¦‚ä¸‹ï¼š\n")
    update_output_text(output_text, f"æ—¥æœŸ: {editdate}\n")
    update_output_text(output_text, f"æ‰¿è¿äºº: {editcarrier}\n")
    update_output_text(output_text, f"èˆ¹èˆ¶: {editvessel}\n")
    update_output_text(output_text, f"ç›®çš„åœ°: {editdestination}\n")
    update_output_text(output_text, f"GNA: {goodnow}\n")
    update_output_text(output_text, f"èˆªæ¬¡: {editvoyage}\n")
    update_output_text(output_text, f"Presentation Port: {presentation_port}\n")
    update_output_text(output_text, f"Port of Unlading: {port_of_unlading}\n")
    update_output_text(output_text, f"Consigned to Port: {consigned_to_port}\n")
    update_output_text(output_text, f"carrierid: {CarrierID}\n")
    update_output_text(output_text, f"entrytype: {Entrytype}\n")
    update_output_text(output_text, f"Lastfp: {Lastfp}\n\n")

    df = pd.read_excel(file_path, header=None, dtype=str)
    a_column = df.iloc[:, 0]
    filtered_list = a_column[a_column.notna() & (a_column != 'na')].tolist()
    update_output_text(output_text, f"æ‰€æœ‰éœ€è¦æ“ä½œçš„inbond: {filtered_list}\n")

    try:
        # é…ç½® ChromeOptions
        options = webdriver.ChromeOptions()
        chrome_binary = r"C:\Program Files\Google\Chrome\Application\chrome.exe"
        options.binary_location = chrome_binary
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")

        # æ£€æŸ¥ Chrome å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if os.path.exists(chrome_binary):
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶å­˜åœ¨: {chrome_binary}\n")
        else:
            update_output_text(output_text, f"Chrome å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {chrome_binary}\n")
            raise FileNotFoundError(f"Chrome å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°: {chrome_binary}")

        # è·å– ChromeDriver è·¯å¾„å’Œç‰ˆæœ¬
        try:
            driver_path = ChromeDriverManager().install()
            update_output_text(output_text, f"ChromeDriver è·¯å¾„: {driver_path}\n")
            # æ£€æŸ¥ ChromeDriver ç‰ˆæœ¬
            driver_version = subprocess.check_output([driver_path, "--version"]).decode().strip()
            update_output_text(output_text, f"ChromeDriver ç‰ˆæœ¬: {driver_version}\n")
        except Exception as e:
            update_output_text(output_text, f"è·å– ChromeDriver è·¯å¾„æˆ–ç‰ˆæœ¬å¤±è´¥: {str(e)}\n")
            raise

        # æ£€æŸ¥ç³»ç»Ÿ PATH
        system_path = os.environ.get("PATH", "")
        update_output_text(output_text, f"ç³»ç»Ÿ PATH: {system_path}\n")

        # åˆå§‹åŒ– Chrome æµè§ˆå™¨
        update_output_text(output_text, "å¼€å§‹åˆå§‹åŒ– ChromeDriver...\n")
        driver = webdriver.Chrome(service=Service(driver_path), options=options)
        update_output_text(output_text, "ChromeDriver åˆå§‹åŒ–æˆåŠŸ\n")

    except webdriver.WebDriverException as wde:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (WebDriverException): {str(wde)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    except FileNotFoundError as fnfe:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (FileNotFoundError): {str(fnfe)}\n")
        raise
    except Exception as e:
        update_output_text(output_text, f"åˆå§‹åŒ– ChromeDriver å¤±è´¥ (æœªçŸ¥é”™è¯¯): {str(e)}\n")
        update_output_text(output_text, f"å †æ ˆè·Ÿè¸ª: {traceback.format_exc()}\n")
        raise
    url = "https://www.netchb.com/app/home.do"
    driver.get(url)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="lName"]'))
    ).send_keys(account)

    WebDriverWait(driver, 20).until(
        EC.presence_of_element_located((By.XPATH, '//*[@id="pass"]'))
    ).send_keys(password)

    xpath = '//*[@id="loginForm"]/div[2]/input'
    login_button = driver.find_element(By.XPATH, xpath)
    login_button.click()

    values_to_update = {
        '//*[@id="pDate"]': editdate,
        '//*[@id="dImp"]': editdate,
        '//*[@id="ed"]': editdate,
        '//*[@id="ad"]': editdate,
        '//*[@id="impC"]': editcarrier,
        '//*[@id="vn"]': editvessel,
        '//*[@id="forDest"]': editdestination,
        '//*[@id="vNo"]': editvoyage,
        '//*[@id="gna"]': goodnow,
        '//*[@id="presPort"]': presentation_port,
        '//*[@id="pu"]': port_of_unlading,
        '//*[@id="usp"]': consigned_to_port,
        '//*[@id="ci"]': CarrierID,
        '//*[@id="lfp"]': Lastfp
    }
    entrytype_xpath = '//*[@id="et"]'
    url = "https://www.netchb.com/app/inbond/inbondMenu.do?itNo=054302382"
    driver.get(url)
    for item in filtered_list:
        if windowname != "task":
            update_output_text(output_text, "çª—å£å·²å…³é—­ï¼Œç¨‹åºç»ˆæ­¢ã€‚\n")
            sys.exit()
        target_url = f"https://www.netchb.com/app/inbond/inbondMenu.do?itNo={item}"
        driver.get(target_url)

        try:
            element_xpath = '/html/body/table/tbody/tr[2]/td[1]/table[1]/tbody/tr[6]/td[2]/a'
            element = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, element_xpath))
            )
            element.click()
            time.sleep(1)

            if Entrytype != "N/A":
                try:
                    entrytype_element = WebDriverWait(driver, 20).until(
                        EC.element_to_be_clickable((By.XPATH, entrytype_xpath))
                    )
                    select = Select(entrytype_element)
                    select.select_by_value(Entrytype)
                    time.sleep(1)
                except Exception as e:
                    update_output_text(output_text, f"Error setting Entrytype at {entrytype_xpath}: {e}\n")
            else:
                update_output_text(output_text, f"Skipped setting Entrytype because value is 'N/A'.\n")

            for xpath, value in values_to_update.items():
                if value != "N/A":
                    try:
                        field_element = WebDriverWait(driver, 20).until(
                            EC.element_to_be_clickable((By.XPATH, xpath))
                        )
                        field_element.clear()
                        field_element.send_keys(value)
                    except Exception as e:
                        update_output_text(output_text, f"Error updating field at {xpath}: {e}\n")
                else:
                    update_output_text(output_text, f"Skipped updating field at {xpath} because value is 'N/A'.\n")

            time.sleep(2)

            save_xpath = '//*[@id="inbondHeaderForm"]/input[4]'
            saveelement = WebDriverWait(driver, 50).until(
                EC.element_to_be_clickable((By.XPATH, save_xpath))
            )
            saveelement.click()

        except Exception as e:
            update_output_text(output_text, f"Error occurred for {item}: {e}\n")

        target_url2 = f"https://www.netchb.com/app/home.do"
        driver.get(target_url2)
        time.sleep(4)

    input("Press Enter to close the browser...")
    driver.quit()


def Steel_Aluminum_dutyprogram(account, password, output_text):
    from seleniumwire import webdriver
    expiration_date = expiration_date1
    now = datetime.now()
    func_name = inspect.currentframe().f_code.co_name  # è‡ªåŠ¨è·å–å½“å‰å‡½æ•°å

    if expiration_date and now > expiration_date:
        if not is_user_allowed(func_name, account):
            update_output_text(output_text, "ç¨‹åºå·²è¿‡æœŸï¼Œè¯·è”ç³»Larryè·å–æ›´æ–°ç‰ˆæœ¬ã€‚\n\n")
            exit()

    def get_code(account, password):
        data_dict = {}

        user_home = os.path.expanduser("~")
        possible_paths = [
            os.path.join(user_home, "Desktop"),
            os.path.join(user_home, "æ¡Œé¢"),
            os.path.join(user_home, "OneDrive", "Desktop"),
            os.path.join(user_home, "OneDrive", "æ¡Œé¢")
        ]

        desktop_path = next((path for path in possible_paths if os.path.exists(path)), None)

        if desktop_path:
            file_path = os.path.join(desktop_path, "BBCreview.xlsx")
            if os.path.exists(file_path):
                update_output_text(output_text, "å·²æ‰¾åˆ°BBCreview\n")
                pass
            else:
                # åˆ›å»ºç©ºçš„ Excel æ–‡ä»¶
                wb = Workbook()
                wb.save(file_path)
                update_output_text(output_text, "å·²åˆ›å»ºBBCreviewï¼Œå†æ¬¡è¿è¡Œå³å¯å¼€å§‹ä»£ç \n")
                sys.exit()  # ç¨‹åºç«‹å³åœæ­¢
        else:
            update_output_text(output_text, "åˆ›å»ºexcelå¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n")
            sys.exit()  # ç¨‹åºç«‹å³åœæ­¢

        # å›ºå®šè·¯å¾„ï¼šAppData\Local
        fixed_path = os.path.join(user_home, "AppData", "Local")
        txt_file_path = os.path.join(fixed_path, "origincode.txt")

        if not os.path.exists(txt_file_path):
            try:
                with open(txt_file_path, 'w', encoding='utf-8') as f:
                    pass  # åˆ›å»ºç©ºæ–‡ä»¶
                update_output_text(output_text, 'å·²åŒ¹é…è‡³larryæœ¬åœ°æœåŠ¡å™¨, è¯·å†ç‚¹å‡»ä¸€æ¬¡è¿è¡Œä»¥è¿è¡Œ\n')
                sys.exit()
            except Exception as e:
                update_output_text(output_text, 'è¿æ¥å¤±è´¥ï¼Œè¯·è”ç³»larryè§£å†³\n')
                sys.exit()
        else:
            update_output_text(output_text, 'æ­£åœ¨åƒlarryæœåŠ¡å™¨ä¼ é€å†…å®¹ï¼Œå¼€å§‹ä»£ç \n')
            time.sleep(5)
            update_output_text(output_text, 'å·²è¿æ¥larryæœ¬åœ°æœåŠ¡å™¨ï¼Œå¼€å§‹ä»£ç \n')

        chrome_options = webdriver.ChromeOptions()
        chrome_options.add_argument("--start-maximized")  # å¯åŠ¨æ—¶æœ€å¤§åŒ–
        chrome_options.add_argument("--disable-gpu")  # è§£å†³æŸäº›ç³»ç»Ÿçš„å›¾å½¢æ¸²æŸ“é—®é¢˜
        chrome_options.add_argument("--no-sandbox")  # érootç”¨æˆ·éœ€è¦æ­¤å‚æ•°
        chrome_options.add_argument("--disable-dev-shm-usage")  # é¿å…æŸäº›å…±äº«å†…å­˜é—®é¢˜
        chrome_options.add_argument("--always-on-top")  # çª—å£ç½®é¡¶ (å®éªŒæ€§å‚æ•°)
        chrome_options.add_argument("--force-device-scale-factor=0.5")  # è®¾ç½®ç¼©æ”¾æ¯”ä¾‹ä¸º50%

        # å¯åŠ¨ Chrome æµè§ˆå™¨å¹¶åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æ•°æ®
        driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=chrome_options)
        driver.set_window_size(1920, 1080)

        # é€šè¿‡ JavaScript å¼ºåˆ¶è®¾ç½®ç¼©æ”¾æ¯”ä¾‹
        driver.get("https://www.google.com")
        driver.execute_script("document.body.style.zoom='50%'")
        url = "https://my.acelynknavigator.com/Account/Login.aspx?ReturnUrl=%2fDesktop%2fDefault.aspx"
        driver.get(url)
        driver.maximize_window()  # æœ€å¤§åŒ–çª—å£

        all_tabs = driver.window_handles
        all_tabs = driver.window_handles

        # éå†æ‰€æœ‰çª—å£ï¼Œå…³é—­ä¸éœ€è¦çš„ "data:" æ ‡ç­¾é¡µ
        for tab in all_tabs:
            driver.switch_to.window(tab)
            if "data:" in driver.current_url:
                driver.close()  # å…³é—­ "data:" æ ‡ç­¾é¡µ

        # é‡æ–°è·å–å½“å‰æ‰€æœ‰çª—å£å¥æŸ„
        all_tabs = driver.window_handles

        # å¦‚æœæœ‰å‰©ä½™çª—å£ï¼Œåˆ‡æ¢åˆ°ç¬¬ä¸€ä¸ª
        if all_tabs:
            driver.switch_to.window(all_tabs[0])

        try:
            # ç­‰å¾…é¡µé¢åŠ è½½å¹¶æ£€æŸ¥æ˜¯å¦åŒ…å« "sign"
            WebDriverWait(driver, 10).until(
                lambda d: "sign" in d.page_source.lower()  # ç­‰å¾…ç›´åˆ°é¡µé¢åŒ…å« "sign"
            )
            print("'sign' found in page source. Continuing...")
        except Exception as e:
            print("Timeout or error while waiting for 'sign':", e)
            driver.quit()
            exit()

        # è¾“å…¥è´¦å·å’Œå¯†ç 
        username = account  # æ›¿æ¢ä¸ºå®é™…è´¦å·
        password = password  # æ›¿æ¢ä¸ºå®é™…å¯†ç 

        # å®šä½åˆ°è´¦å·å’Œå¯†ç è¾“å…¥æ¡†
        username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
        username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
        username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

        # è¾“å…¥å¯†ç 
        password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
        password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
        password_field.send_keys(password)  # è¾“å…¥å¯†ç 

        # ç‚¹å‡»ç™»å½•æŒ‰é’®
        login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")  # æ›¿æ¢ä¸ºå®é™… ID
        login_button.click()
        print("Current page title is:", driver.title)
        WebDriverWait(driver, 10).until(EC.title_contains("Compliance"))  # ç­‰å¾…é¡µé¢æ ‡é¢˜æ›´æ–°ä¸ºç™»å½•åçš„å†…å®¹

        try:
            # å®šä½åˆ°ç™»å½•æŒ‰é’®å¹¶ç‚¹å‡»
            login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
            login_button.click()

            # ç­‰å¾…æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šæ¡†å¼¹å‡º
            try:
                logout_button = WebDriverWait(driver, 10).until(
                    EC.element_to_be_clickable((By.XPATH, "//*[@id='lbtLogOutAllSessions']"))
                )
                logout_button.click()
                print("Clicked the logout button in the alert.")

                # ç­‰å¾…é¡µé¢åˆ·æ–°ï¼ˆå¯ä»¥æ ¹æ® URL å˜åŒ–æˆ–æŸä¸ªæ ‡å¿—æ€§å…ƒç´ æ¥ç¡®è®¤ï¼‰
                WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.ID, "LoginMenu_LoginButton"))  # ç¡®ä¿ç™»å½•æŒ‰é’®å­˜åœ¨
                )
                time.sleep(2)
                username_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_UserName"]')
                username_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
                username_field.send_keys(username)  # è¾“å…¥ç”¨æˆ·å

                # è¾“å…¥å¯†ç 
                password_field = driver.find_element(By.XPATH, '//*[@id="LoginMenu_Password"]')
                password_field.clear()  # æ¸…é™¤è¾“å…¥æ¡†ä¸­çš„ä»»ä½•å†…å®¹
                password_field.send_keys(password)  # è¾“å…¥å¯†ç 
                # é‡æ–°å®šä½ç™»å½•æŒ‰é’®
                login_button = driver.find_element(By.ID, "LoginMenu_LoginButton")
                login_button.click()
                print("Clicked the login button.")

            except TimeoutException:
                print("No alert appeared, proceeding with the login.")

            # ç­‰å¾…é¡µé¢è·³è½¬å¹¶æ£€æŸ¥ç™»å½•åé¡µé¢æ ‡é¢˜
            WebDriverWait(driver, 10).until(
                EC.title_contains("Dashboard")  # è¿™é‡Œç”¨ç™»å½•åçš„é¡µé¢æ ‡é¢˜çš„ä¸€ä¸ªå…³é”®å­—
            )
            print("Login successful. Page title is:", driver.title)

        except (TimeoutException, NoSuchElementException) as e:
            print(f"Error occurred during login: {e}")
        outputdf = pd.DataFrame(columns=["entry_number", "status_img_src", "pga_img_src", "first_column_data"])
        driver.get("https://my.acelynknavigator.com/Desktop/Default.aspx")
        step_status = True

        def check_alert(driver):
            try:
                time.sleep(1)
                alert = driver.switch_to.alert
                alert_text = alert.text
                print("å¼¹çª—å†…å®¹:", alert_text)

                if "cotton" not in alert_text.lower():
                    alert.accept()
                    print("å·²ç‚¹å‡»ç¡®è®¤æŒ‰é’®")
                else:
                    alert.dismiss()
                    print("æ£€æµ‹åˆ° 'cotton'ï¼Œå·²ç‚¹å‡»å–æ¶ˆæŒ‰é’®")

                time.sleep(1)
            except NoAlertPresentException:
                pass  # æ²¡æœ‰å¼¹çª—ï¼Œè·³è¿‡

        def wait_for_block_to_disappear(driver, timeout=40, check_interval=1):
            end_time = time.time() + timeout
            while time.time() < end_time:
                try:
                    # æŸ¥æ‰¾é®ç½©å±‚
                    blocking_elements = driver.find_elements(By.CSS_SELECTOR, ".blockUI.blockOverlay")
                    if not blocking_elements:
                        print("âœ… é˜»æŒ¡å…ƒç´ æ¶ˆå¤±ï¼Œç»§ç»­æ“ä½œ")
                        return
                    print("â³ æ£€æµ‹åˆ°é®ç½©å±‚ï¼Œç­‰å¾…ä¸­...")
                    time.sleep(check_interval)
                except UnexpectedAlertPresentException:

                    try:
                        alert = driver.switch_to.alert
                        print("âš ï¸ æ£€æµ‹åˆ° alert å¼¹çª—ï¼š", alert.text)
                        alert.accept()
                        print("âœ… å·²ç‚¹å‡»ç¡®è®¤å…³é—­ alert")
                        time.sleep(1)
                    except NoAlertPresentException:
                        print("âŒ æƒ³å¤„ç† alertï¼Œä½†æ‰¾ä¸åˆ°")
                    continue
                except Exception as e:
                    print(f"âš ï¸ æ£€æµ‹é®ç½©å±‚æ—¶å‡ºç°é”™è¯¯: {e}")
                    time.sleep(check_interval)
                    continue

        def open_entry(driver):
            try:
                driver.switch_to.default_content()
                print("âœ… å·²è¿”å›ä¸»é¡µé¢")
            except Exception as e:
                print(f"âŒ è¿”å›ä¸»é¡µé¢å¤±è´¥: {e}")

            try:
                # æ£€æŸ¥ iframe
                iframes = driver.find_elements(By.TAG_NAME, "iframe")
                print(f"ğŸ” æ£€æµ‹åˆ° {len(iframes)} ä¸ª iframe")
                iframe_switched = False
                if iframes:
                    for i, iframe in enumerate(iframes):
                        try:
                            driver.switch_to.frame(iframe)
                            print(f"âœ… åˆ‡æ¢åˆ° iframe {i}")
                            driver.find_element(By.XPATH,
                                                "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]")
                            print("âœ… æ‚¬åœå…ƒç´ åœ¨ iframe ä¸­")
                            iframe_switched = True
                            break
                        except:
                            driver.switch_to.default_content()
                            print(f"âŒ iframe {i} ä¸­æ— ç›®æ ‡å…ƒç´ ï¼Œåˆ‡æ¢å›ä¸»é¡µé¢")
                else:
                    print("âœ… æ—  iframe")

                # å®šä½æ‚¬åœå…ƒç´ å¹¶æå– <td> çš„ id
                img_xpath = "(//td[contains(@id, 'EntrySummary')]//ul[@class='nav2']//img)[1]"
                print(f"ğŸ” å°è¯•å®šä½æ‚¬åœå…ƒç´ : {img_xpath}")
                img_elements = driver.find_elements(By.XPATH, img_xpath)
                print(f"ğŸ” æ‰¾åˆ° {len(img_elements)} ä¸ªæ‚¬åœå…ƒç´ ")
                if len(img_elements) > 1:
                    print("âš ï¸ è­¦å‘Š: æ‚¬åœ XPath åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ï¼Œå¯èƒ½å¯¼è‡´é”™è¯¯")
                    for i, elem in enumerate(img_elements):
                        print(f"ğŸ” æ‚¬åœå…ƒç´  {i}: {elem.get_attribute('outerHTML')}")
                img_element = img_elements[0] if img_elements else driver.find_element(By.XPATH, img_xpath)
                print(f"âœ… æ‚¬åœå…ƒç´ : {img_element.get_attribute('outerHTML')}")

                # è·å–çˆ¶ <td> çš„ id
                td_element = img_element.find_element(By.XPATH, "./ancestor::td[contains(@id, 'EntrySummary')]")
                td_id = td_element.get_attribute("id")
                print(f"âœ… æ‰¾åˆ°çˆ¶ <td> id: {td_id}")

                # æ‚¬åœå¹¶ç­‰å¾…èœå•åŠ è½½
                ActionChains(driver).move_to_element(img_element).perform()
                print("âœ… å·²æ‰§è¡Œæ‚¬åœæ“ä½œ")
                try:
                    WebDriverWait(driver, 5).until(
                        EC.presence_of_element_located((By.XPATH, "//a[contains(@class,'shipment-row')]"))
                    )
                    print("âœ… èœå•å·²åŠ è½½")
                except TimeoutException:
                    print("âŒ èœå•æœªåŠ è½½ï¼Œå¯èƒ½æ‚¬åœå¤±è´¥")

                # æ£€æŸ¥å¼¹çª—
                def check_alert(driver):
                    try:
                        alert = driver.switch_to.alert
                        alert.accept()
                        print("âœ… å·²å…³é—­å¼¹çª—")
                    except:
                        print("âœ… æ— å¼¹çª—")

                check_alert(driver)

                # æ£€æŸ¥é«˜ z-index å…ƒç´ 
                overlays = driver.find_elements(By.XPATH,
                                                "//*[contains(@style, 'z-index') and not(contains(@style, 'z-index: 0'))]")
                print(f"ğŸ” æ£€æµ‹åˆ° {len(overlays)} ä¸ªé«˜ z-index å…ƒç´ ")
                for overlay in overlays[:3]:
                    print(f"ğŸ” è¦†ç›–å±‚: {overlay.get_attribute('outerHTML')}")

                # å®šä½ Edit æŒ‰é’®ï¼Œä½¿ç”¨çˆ¶ <td> çš„ id çº¦æŸ
                timeout = 10
                interval = 1
                start_time = time.time()
                edit_xpath = f"//td[@id='{td_id}']//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]"
                print(f"ğŸ” å°è¯•å®šä½ Edit æŒ‰é’®: {edit_xpath}")
                edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                print(f"ğŸ” æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                if len(edit_elements) > 1:
                    print("âš ï¸ è­¦å‘Š: Edit XPath ä»åŒ¹é…åˆ°å¤šä¸ªå…ƒç´ ")
                    for i, elem in enumerate(edit_elements):
                        print(f"ğŸ” Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")
                elif len(edit_elements) == 0:
                    print("âŒ Edit æŒ‰é’®æœªæ‰¾åˆ°ï¼ŒXPath å¯èƒ½é”™è¯¯æˆ–å…ƒç´ æœªåŠ è½½")
                    print(
                        "ğŸ” å°è¯•å¤‡ç”¨ XPath: //a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                    edit_elements = driver.find_elements(By.XPATH,
                                                         "//a[contains(@class,'shipment-row') and .//img[contains(@src,'edit_30x30.png')]]")
                    print(f"ğŸ” å¤‡ç”¨ XPath æ‰¾åˆ° {len(edit_elements)} ä¸ª Edit æŒ‰é’®")
                    for i, elem in enumerate(edit_elements):
                        print(f"ğŸ” å¤‡ç”¨ Edit æŒ‰é’® {i}: {elem.get_attribute('outerHTML')}")

                while True:
                    try:
                        edit_img = WebDriverWait(driver, interval).until(
                            EC.element_to_be_clickable((By.XPATH, edit_xpath))
                        )
                        print(f"âœ… Edit æŒ‰é’®å®šä½æˆåŠŸ: {edit_img.get_attribute('outerHTML')}")
                        print(f"ğŸ” å…ƒç´ å¯è§: {edit_img.is_displayed()}, å…ƒç´ å¯ç‚¹å‡»: {edit_img.is_enabled()}")
                        try:
                            edit_img.click()
                            print("âœ… ç‚¹å‡» Edit æŒ‰é’®æˆåŠŸ")
                            break
                        except ElementClickInterceptedException as e:
                            print(f"âŒ ç‚¹å‡»è¢«æ‹¦æˆª: {e}")
                            print("ğŸ” å°è¯• JavaScript ç‚¹å‡»")
                            driver.execute_script("arguments[0].click();", edit_img)
                            print("âœ… ä½¿ç”¨ JavaScript ç‚¹å‡» Edit æŒ‰é’®")
                            break
                    except TimeoutException as e:
                        elapsed = time.time() - start_time
                        print(f"âŒ TimeoutException: {e}")
                        if elapsed >= timeout:
                            print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                            if edit_elements:
                                print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†ä¸å¯ç‚¹å‡»: {edit_elements[0].get_attribute('outerHTML')}")
                            else:
                                print("ğŸ” Edit æŒ‰é’®æœªåœ¨ DOM ä¸­æ‰¾åˆ°")
                            break
                        else:
                            print("âŒ å…ƒç´ æœªå¯ç‚¹ï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                            time.sleep(interval)
                    except ElementClickInterceptedException as e:
                        elapsed = time.time() - start_time
                        print(f"âŒ ElementClickInterceptedException: {e}")
                        if elapsed >= timeout:
                            print("âŒ è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç‚¹å‡»å¤±è´¥")
                            print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                            edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                            if edit_elements:
                                print(f"ğŸ” Edit æŒ‰é’®å­˜åœ¨ä½†è¢«é®æŒ¡: {edit_elements[0].get_attribute('outerHTML')}")
                            break
                        else:
                            print("âŒ å…ƒç´ è¢«æ‹¦æˆªï¼Œç­‰å¾…1ç§’åé‡è¯•...")
                            time.sleep(interval)

                # åˆ‡æ¢å›ä¸»é¡µé¢
                if iframe_switched:
                    driver.switch_to.default_content()
                    print("âœ… åˆ‡æ¢å›ä¸»é¡µé¢")

            except Exception as e:
                print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
                print("ğŸ“„ å½“å‰é¡µé¢ HTMLï¼ˆéƒ¨åˆ†ï¼‰:")
                edit_elements = driver.find_elements(By.XPATH, edit_xpath)
                if edit_elements:
                    print(f"ğŸ” Edit æŒ‰é’®: {edit_elements[0].get_attribute('outerHTML')}")
                else:
                    print("ğŸ” Edit æŒ‰é’®æœªæ‰¾åˆ°")

        def search_entry_num(entry_number, timeout=5):
            driver.switch_to.default_content()

            wait_for_block_to_disappear(driver)
            start_time = time.time()
            while True:
                try:

                    find_element = WebDriverWait(driver, 10).until(
                        EC.visibility_of_element_located(
                            (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/button[2]/span[2]"))
                    )
                    # æ¨¡æ‹Ÿé¼ æ ‡æ‚¬åœ
                    actions = ActionChains(driver)
                    actions.move_to_element(find_element).perform()
                    # å°è¯•å®šä½å¹¶è¾“å…¥ entry_number
                    input_box = WebDriverWait(driver, 3).until(
                        EC.visibility_of_element_located((By.XPATH, "//*[@id='advancedSearch']/div/div[8]/input"))
                    )
                    input_box.clear()
                    input_box.send_keys(entry_number)

                    # å°è¯•ç‚¹å‡»æŒ‰é’®
                    search_button = WebDriverWait(driver, 3).until(
                        EC.element_to_be_clickable(
                            (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[1]"))
                    )
                    search_button.click()

                    break  # æˆåŠŸåè·³å‡ºå¾ªç¯

                except (ElementNotInteractableException, NoSuchElementException, TimeoutException) as e:
                    if time.time() - start_time > timeout:
                        return "è¶…æ—¶"
                        break
                    else:
                        time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•

        def safe_do(driver, action, description="", retries=2, retry_delay=0.5):
            for attempt in range(retries):
                try:
                    check_alert(driver)
                    result = action()
                    check_alert(driver)
                    return result
                except Exception as e:
                    print(f"âš ï¸ {description} ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥: {e}")
                    check_alert(driver)
                    if attempt < retries - 1:
                        time.sleep(retry_delay)
                    else:
                        print(f"âŒ {description} æ‰€æœ‰å°è¯•å¤±è´¥")
                        return "tryfalse"

        def wait_for_autocomplete(driver, xpath: str, interval: float, duration: float):
            import time
            from selenium.common.exceptions import NoSuchElementException
            from selenium.webdriver.common.by import By

            start_time = time.time()

            while time.time() - start_time < duration:
                try:
                    element = driver.find_element(By.XPATH, xpath)
                    if element.is_displayed():
                        print("âœ… è‡ªåŠ¨è¡¥å…¨æ å·²å¼¹å‡º")
                        time.sleep(1)
                        return True
                except NoSuchElementException:
                    print("ğŸ” æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ï¼Œç»§ç»­ç­‰å¾…...")

                time.sleep(interval)

            print("âŒ è¶…æ—¶æœªæ£€æµ‹åˆ°è‡ªåŠ¨è¡¥å…¨æ ")
            return False

        def data_entry(driver, entry_xpath: str, choose_xpath: str, interval: float, duration: float, content: str):
            try:
                # æ¸…ç©ºå¹¶è¾“å…¥
                safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

                # å°è¯•ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
                import time, re
                start_time = time.time()

                # æå– ul çš„ç´¢å¼•
                ul_pattern = re.search(r'ul\[(\d+)\]', choose_xpath)
                if not ul_pattern:
                    print("âŒ choose_xpath æ— æ³•è¯†åˆ« ul[x] çš„æ ¼å¼")
                    return

                base_index = int(ul_pattern.group(1))
                prefix, suffix = choose_xpath.split(f'ul[{base_index}]')

                while time.time() - start_time < duration:
                    for i in range(11):  # æœ€å¤šå°è¯• base åˆ° base+10
                        trial_xpath = f"{prefix}ul[{base_index + i}]{suffix}"
                        print(f"å°è¯•ç‚¹å‡»: {trial_xpath}")
                        result = safe_do(driver, lambda: WebDriverWait(driver, interval).until(
                            EC.element_to_be_clickable((By.XPATH, trial_xpath))).click(),
                                         f"ç‚¹å‡»è‡ªåŠ¨è¡¥å…¨é¡¹ ul[{base_index + i}]")

                        if result != "tryfalse":
                            print(f"âœ… ç‚¹å‡»æˆåŠŸ: {trial_xpath}")
                            return

                print("âŒ æ‰€æœ‰è‡ªåŠ¨è¡¥å…¨å°è¯•å¤±è´¥")

            except Exception as e:
                print("âŒ data_entry å‡½æ•°å‘ç”Ÿå¼‚å¸¸ï¼š", e)
                check_alert(driver)

        def normal_entry(driver, entry_xpath: str, interval: float, duration: float, content: str):

            try:
                safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                    EC.presence_of_element_located((By.XPATH, entry_xpath))).clear(), "æ¸…ç©ºè¾“å…¥æ¡†")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(""), "è¾“å…¥ç©ºå†…å®¹")
                safe_do(driver, lambda: driver.find_element(By.XPATH, entry_xpath).send_keys(content), "è¾“å…¥å†…å®¹")

            except Exception as e:
                # è¿™é‡Œæ•è·å…¶ä»–å¼‚å¸¸å¹¶æ‰“å°è¯¦ç»†ä¿¡æ¯
                print("âŒ å‘ç”Ÿå…¶ä»–å¼‚å¸¸ï¼š", e)

        def page_viewd(driver, entry_number):
            try:
                iframe = driver.find_element(By.ID, "iframeInvoices")
                driver.switch_to.frame(iframe)
            except:
                pass

            # ç‚¹å‡»å‰è®°å½•å½“å‰è¯·æ±‚æ•°é‡
            already_seen = set((r.id for r in driver.requests))

            # ç‚¹å‡» save
            safe_do(driver, lambda: WebDriverWait(driver, 60, 0.5).until(
                EC.element_to_be_clickable((By.XPATH,
                                            "/html/body/form/div[3]/div[2]/div[2]/div/div[2]/div/div[1]/div[1]/div[1]/span[2]/ul/li[1]/a"))
            ).click(), "ç‚¹å‡»saveæŒ‰é’®", retries=1, retry_delay=0.5)

            request_data = None
            max_wait_seconds = 30
            interval = 0.5
            elapsed = 0

            while elapsed < max_wait_seconds:
                for request in driver.requests:
                    if request.id in already_seen:
                        continue
                    if request.response:
                        if "SaveJSONV3" in request.url and request.method == 'POST':
                            payload = decode(request.body, request.headers.get('Content-Encoding', 'identity')).decode()
                            request_data = {
                                "url": request.url,
                                "cookie": request.headers.get("Cookie"),
                                "payload": payload,
                                "status_code": request.response.status_code
                            }
                            break
                if request_data:
                    break
                time.sleep(interval)
                elapsed += interval

            wait_for_block_to_disappear(driver, timeout=600, check_interval=1)

            if request_data is None:
                update_output_text(output_text, f"{entry_number}ä¼ è¾“ä¿¡æ¯è‡³Larryçš„æœåŠ¡å™¨å¤±è´¥\n")
            else:
                update_output_text(output_text, f"{entry_number}æˆåŠŸä¼ è¾“ä¿¡æ¯è‡³Larryçš„æœåŠ¡å™¨\n")
                return request_data

        file_path = os.path.join(desktop_path, "BBCreview.xlsx")
        file_path = file_path
        df = pd.read_excel(file_path, header=None, dtype=str)  # åŠ  dtype=str è¯»è¿›æ¥å°±å…¨æ˜¯å­—ç¬¦ä¸²

        # é€šè¿‡ iloc è®¿é—®ç¬¬ä¸€åˆ—ï¼ˆå‡è®¾æ˜¯ A åˆ—ï¼‰
        a_column = df.iloc[:, 0]  # é€‰æ‹©ç¬¬ä¸€åˆ—
        c_column = df.iloc[:, 2]  # é€‰æ‹©ç¬¬ä¸€åˆ—
        # è¿‡æ»¤æ‰ 'na' å’Œ NaN å€¼
        filtered_lista = a_column[a_column.notna() & (a_column != 'na')].tolist()
        filtered_listc = c_column[c_column.notna() & (c_column != 'na')].tolist()

        wait_for_block_to_disappear(driver, timeout=40, check_interval=1)
        all_data = {}

        for entry_number in filtered_lista:
            search_entry_num(entry_number, timeout=5)
            wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
            check_alert(driver)
            open_entry(driver)
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable(
                    (By.XPATH, "/html/body/div[2]/div[2]/div[1]/div/div[2]/div[3]/div/div[13]/a[2]"))).click(),
                    "ç‚¹å‡»æŸä¸ªæŒ‰é’®")

            data = page_viewd(driver, entry_number)
            if data:
                all_data[entry_number] = data
            else:
                all_data[entry_number] = None  # æˆ–è€…ä½ å¯ä»¥é€‰æ‹©è·³è¿‡
            try:
                driver.switch_to.default_content()
                print("æˆåŠŸåˆ‡æ¢å›æ¥")
            except Exception as e:
                print(f"âš ï¸ åˆ‡æ¢å›ä¸»é¡µé¢å¤±è´¥: {e}")
                pass
            safe_do(driver, lambda: WebDriverWait(driver, 10).until(
                EC.element_to_be_clickable(
                    (By.XPATH, "/html/body/div[2]/div[2]/div[3]/div/div[1]/div[1]/div[1]/ul/li[36]/span[2]"))).click(),
                    "ç‚¹å‡»æŸä¸ªæŒ‰é’®")
            wait_for_block_to_disappear(driver, timeout=80, check_interval=1)
            time.sleep(1)
        return all_data, txt_file_path,filtered_listc

    def decode_and_save(encoded_data: str, save_path: str):
        """
        è§£ç  Base64+gzip å‹ç¼©çš„ JSON æ•°æ®å¹¶ä¿å­˜ä¸ºæ ¼å¼åŒ–çš„ txt/json æ–‡ä»¶
        """
        if not encoded_data.strip():
            print("âŒ encoded_data ä¸ºç©º")
            return

        try:
            # base64 è§£ç 
            decoded_bytes = base64.b64decode(encoded_data)

            # zlib è§£å‹ï¼ˆå¸¦ gzip å¤´ï¼‰
            decompressed_bytes = zlib.decompress(decoded_bytes, 16 + zlib.MAX_WBITS)

            # è½¬æˆå­—ç¬¦ä¸²
            json_str = decompressed_bytes.decode('utf-8')

            # è§£æä¸º dict
            data_dict = json.loads(json_str)

            # ä¿å­˜
            with open(save_path, "w", encoding="utf-8") as f:
                json.dump(data_dict, f, indent=2, ensure_ascii=False)

            print(f"âœ… è§£ç å®Œæˆï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ°: {save_path}")
        except Exception as e:
            print(f"âš ï¸ è§£ç å¤±è´¥: {e}")

    def extract_encoded_data(entry_number, data):
        """
        ä»å•æ¡ data ä¸­æå– encodedDataï¼Œå¸¦å¼‚å¸¸å¤„ç†å’Œæç¤ºã€‚
        è¿”å› encoded_data å­—ç¬¦ä¸²ï¼Œå¤±è´¥è¿”å› Noneã€‚
        """
        if data is None:
            print(f"{entry_number} æ— æ•°æ®ï¼Œè·³è¿‡")
            return None

        payload_str = data.get('payload')
        if not payload_str:
            print(f"{entry_number} payloadå­—æ®µä¸ºç©ºï¼Œè·³è¿‡")
            return None

        try:
            payload_json = json.loads(payload_str)
        except Exception as e:
            print(f"{entry_number} payloadè§£æå¤±è´¥: {e}")
            return None

        encoded_data = payload_json.get("encodedData")
        if not encoded_data:
            print(f"{entry_number} encodedDataå­—æ®µä¸å­˜åœ¨ï¼Œè·³è¿‡")
            return None

        return encoded_data

    def find_linenumbers_by_tariff(file_path, target_tariff_no):
        """
        ä»æŒ‡å®š JSON æ–‡ä»¶ä¸­ï¼ŒæŸ¥æ‰¾æ‰€æœ‰æœ€åä¸€ä¸ª TariffNo æˆ– TariffNumber ç­‰äº target_tariff_no çš„ LineNumberã€‚

        å‚æ•°ï¼š
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ–‡ä»¶ï¼Œå†…å®¹æ˜¯ JSON æ ¼å¼ï¼‰
            target_tariff_no: è¦åŒ¹é…çš„ç¨å·å­—ç¬¦ä¸²

        è¿”å›ï¼š
            ç¬¦åˆæ¡ä»¶çš„ LineNumber åˆ—è¡¨ï¼Œæ‰¾ä¸åˆ°è¿”å›ç©ºåˆ—è¡¨
        """
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        def recursive_search(d, result):
            if isinstance(d, dict):
                if "LineNumber" in d and "Tariff" in d:
                    line_number = d["LineNumber"]
                    tariff = d.get("Tariff", [])
                    if isinstance(tariff, list) and tariff:
                        last_tariff = tariff[-1]
                        tariff_no = str(last_tariff.get("TariffNo") or last_tariff.get("TariffNumber") or "").strip()
                        if tariff_no == target_tariff_no:
                            result.append(line_number)
                for v in d.values():
                    recursive_search(v, result)
            elif isinstance(d, list):
                for item in d:
                    recursive_search(item, result)

        results = []
        recursive_search(data, results)
        return results

    def update_warehouse(file_path, stmt_print_date):
        """
        è¯»å– JSON æ–‡ä»¶ï¼Œæ‰¾åˆ° Warehouse å±‚çº§ï¼Œæ›´æ–°æˆ–æ·»åŠ æŒ‡å®šçš„ Warehouse æ•°æ®ï¼Œ
        ä½¿ç”¨ä¼ å…¥çš„æ—¥æœŸè®¾ç½® StmtPrintDateï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆ StmtMonthï¼Œ
        åŒæ—¶å°† AutoCalculateStatementDate è®¾ç½®ä¸º Trueã€‚

        å‚æ•°:
            file_path: JSON æ–‡ä»¶è·¯å¾„ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
            stmt_print_date: ç›®æ ‡ StmtPrintDateï¼ˆæ ¼å¼: MM/DD/YYYYï¼‰

        è¿”å›:
            True ä¿®æ”¹æˆåŠŸï¼ŒFalse å¤±è´¥
        """
        # å›ºå®šçš„ Warehouse æ•°æ®æ¨¡æ¿
        warehouse_template = {
            "ConsInformalInd": "",
            "PaymentIndicator": "7",
            "StmtPrintDate": stmt_print_date,
            "StmtMonth": ""
        }

        # éªŒè¯å¹¶è§£ææ—¥æœŸ
        try:
            parsed_date = datetime.strptime(stmt_print_date, "%m/%d/%Y")
            warehouse_template["StmtMonth"] = parsed_date.strftime("%m")
            print(f"æ›´æ–°åçš„ Warehouse æ¨¡æ¿: {warehouse_template}")
        except ValueError as e:
            print(f"æ—¥æœŸæ ¼å¼é”™è¯¯: {e}ï¼Œè¯·ä½¿ç”¨ MM/DD/YYYY æ ¼å¼")
            return False

        def recursive_update(d):
            if isinstance(d, dict):
                if "Warehouse" in d:
                    d["Warehouse"] = [warehouse_template]
                    d["AutoCalculateStatementDate"] = False
                    print(f"æ‰¾åˆ°å¹¶æ›´æ–° Warehouse: {d['Warehouse']}")
                    print(f"å·²å°† AutoCalculateStatementDate è®¾ç½®ä¸º: {d['AutoCalculateStatementDate']}")
                    return True
                for v in d.values():
                    if recursive_update(v):
                        return True
            elif isinstance(d, list):
                for item in d:
                    if recursive_update(item):
                        return True
            return False

        # è¯»å– JSON æ–‡ä»¶
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        except Exception as e:
            print(f"è¯»å–æ–‡ä»¶å¤±è´¥: {e}")
            return False

        # æ›´æ–° Warehouse æ•°æ®å’Œ AutoCalculateStatementDate
        modified = recursive_update(data)

        if not modified:
            print("æœªæ‰¾åˆ° Warehouse å±‚çº§")
            return False

        # ä¿å­˜ä¿®æ”¹åçš„ JSON æ–‡ä»¶
        try:
            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(data, f, indent=2, ensure_ascii=False)
            print("æ–‡ä»¶ä¿å­˜æˆåŠŸ")
        except Exception as e:
            print(f"ä¿å­˜æ–‡ä»¶å¤±è´¥: {e}")
            return False

        return True

    def encode_json_file(txt_path):
        # === ç¬¬1æ­¥ï¼šè¯»å– txt æ–‡ä»¶ ===
        with open(txt_path, 'r', encoding='utf-8') as f:
            json_str = f.read()

        # éªŒè¯æ˜¯åˆæ³• JSON
        json_obj = json.loads(json_str)

        # æ ¼å¼åŒ–æˆç´§å‡‘ JSON å­—ç¬¦ä¸²
        json_str = json.dumps(json_obj, separators=(',', ':'), ensure_ascii=False)

        # === ç¬¬2æ­¥ï¼šgzip å‹ç¼© + base64 ç¼–ç  ===
        compressed_bytes = gzip.compress(json_str.encode('utf-8'))
        encoded_data = base64.b64encode(compressed_bytes).decode('utf-8')

        return encoded_data

    def upload_encoded_data(
            encoded_data: str,
            importer_id: int,
            reference_number: str,
            cookie: str,
            url: str = "https://my.acelynknavigator.com/Desktop/Invoices/Default.aspx/SaveJSONV3"
    ):
        payload = {
            "encodedData": encoded_data,
            "fileType": "EntrySummary",
            "importerId": importer_id,
            "referenceNumber": reference_number
        }

        headers = {
            "Content-Type": "application/json; charset=UTF-8",
            "Accept": "application/json, text/javascript, */*; q=0.01",
            "Origin": "https://my.acelynknavigator.com",
            "Referer": f"https://my.acelynknavigator.com/Desktop/Invoices/?t=EntrySummary&id={reference_number}",
            "User-Agent": "Mozilla/5.0 (X11; Linux aarch64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 CrKey/1.54.250320",
            "Cookie": cookie,
            "x-requested-with": "XMLHttpRequest"
        }

        response = requests.post(url, headers=headers, json=payload)

        return response.status_code, response.text

    def check_cookie_and_extract(entry_number, data):
        cookie = data.get("cookie")
        payload_str = data.get("payload")

        if not cookie or not cookie.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ cookieï¼Œè·³è¿‡")
            return None
        if not payload_str or not payload_str.strip():
            print(f"{entry_number} payload ä¸ºç©ºï¼Œè·³è¿‡")
            return None

        try:
            payload = json.loads(payload_str)
        except Exception as e:
            print(f"{entry_number} payload è§£æå¤±è´¥: {e}ï¼Œè·³è¿‡")
            return None

        importer_id = payload.get("importerId")
        reference_number = payload.get("referenceNumber")

        if not encoded_data or not encoded_data.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ encodedDataï¼Œè·³è¿‡")
            return None
        if not importer_id:
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ importer_idï¼Œè·³è¿‡")
            return None
        if not reference_number or not str(reference_number).strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ reference_numberï¼Œè·³è¿‡")
            return None

        return {
            "cookie": cookie,
            "importer_id": importer_id,
            "reference_number": reference_number,
        }

    all_data, txt_file_path,filtered_listc = get_code(account, password)
    print(all_data)
    for (entry_number, data), fixtime in zip(all_data.items(), filtered_listc):
        encoded_data = extract_encoded_data(entry_number, data)

        # å¦‚æœæ˜¯ None æˆ–è€…ç©ºå­—ç¬¦ä¸²ï¼Œè·³è¿‡
        if not encoded_data or not encoded_data.strip():
            print(f"{entry_number} æ²¡æœ‰æœ‰æ•ˆçš„ encoded_dataï¼Œè·³è¿‡")
            update_output_text(output_text, f"\nLarryæœåŠ¡å™¨æ— æ³•æˆåŠŸä¸Šä¼ æ­¤entry{entry_number}")
            continue

        decode_and_save(encoded_data, txt_file_path)
        update_warehouse(txt_file_path, fixtime)
        info = check_cookie_and_extract(entry_number, data)
        if info is None:
            update_output_text(output_text, f"\n{entry_number}ä¸Šä¼ å¤±è´¥")
            continue  # ä»»ä½•ä¸€ä¸ªä¿¡æ¯ç¼ºå¤±ï¼Œè·³è¿‡

        cookie = info['cookie']
        importer_id = info['importer_id']
        reference_number = info['reference_number']
        encoded_data = encode_json_file(txt_file_path)

        status, text = upload_encoded_data(encoded_data, importer_id, reference_number, cookie)
        if status == 200:
            update_output_text(output_text, f"\n{entry_number} å¤„ç†å®Œæˆ\n")
        else:
            update_output_text(output_text, f"\n{entry_number} å¤„ç†å¤±è´¥: {status}\n")

        print("çŠ¶æ€ç :", status)

        print(f"{entry_number} å¤„ç†å®Œæˆ\n")
    update_output_text(output_text, f"------------å…¨éƒ¨å¤„ç†å®Œæˆ-----------------------------------")

import customtkinter as ctk
from tkinter import messagebox
import threading

ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")

# ç”¨äºåœæ­¢çº¿ç¨‹çš„äº‹ä»¶
stop_event = threading.Event()


def start_program(account, password, output_text, task_type, mode=None):
    stop_event.clear()  # æ¸…é™¤åœæ­¢äº‹ä»¶ï¼Œå‡†å¤‡å¼€å§‹ä»»åŠ¡
    if task_type == "QP":
        QP_program(account, password, output_text)
    elif task_type == "inbondæå–":
        inbond_program(account, password, output_text)

    elif task_type == "Transmit":
        transmit_program(account, password, output_text)
    elif task_type == "Hold":
        hold_program(account, password, output_text, mode)
    elif task_type == "DelQP":
        del_program(account, password, output_text)
    elif task_type == "åˆ é™¤æ‰€æœ‰house":
        delallinbond_program(account, password, output_text)
    elif task_type == "headerä¿®æ”¹":
        headeredit_program(account, password, output_text, mode)
    elif task_type == "æ›´æ”¹çŠ¶æ€accept":
        statuschange_program(account, password, output_text)
    elif task_type == "BBCæ•°æ®æ˜¾ç¤º":
        BBC_review_program(account, password, output_text)
    elif task_type == "BBC Document":
        document_program(account, password, output_text)
    elif task_type == "BBC House":
        BBC_House(account, password, output_text)
    elif task_type == "æ‰¹é‡æ”¾è´§":
        release_program(account, password, output_text)
    elif task_type == "query":
        query_program(account, password, output_text)
    elif task_type == "bolupdate":
        bolupdate_program(account, password, output_text)
    elif task_type == "rejectä¿®å¤(ç›®å‰ä»…AL1,EP7)":
        rejectfix_program(account, password, output_text)
    elif task_type == "itacæ£€æµ‹":
        FDA_program(account, password, output_text)
    elif task_type == "steel/al Duty":
        Steel_Aluminum_dutyprogram(account, password, output_text)
    elif task_type == "Line æå–":
        line_extract(account, password, output_text)
    elif task_type == "åå‘Line æå–":
        reverse_line_extract(account, password, output_text)
    elif task_type == "Nikki template":
        Nikki_template(account, password, output_text)
    elif task_type == "ç™½å®«æ€»ç»ŸåŠå…¬å®¤è”ç³»æ–¹å¼":
        wechat(account, password, output_text)   


# ç™»å½•ç•Œé¢
def login_window():
    global windowname
    windowname = 'login'

    login_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    login_frame.pack(padx=20, pady=20, fill="both", expand=True)

    def proceed_login():
        account = entry_account.get()
        password = entry_password.get()
        if not account or not password:
            messagebox.showerror("é”™è¯¯", "è´¦å·æˆ–å¯†ç ä¸èƒ½ä¸ºç©ºï¼")
            return
        login_frame.destroy()
        show_main_window(account, password)

    label_account = ctk.CTkLabel(login_frame, text="è´¦å·:", font=("Arial", 16), text_color="#FFFFFF")
    label_account.pack(pady=10)
    entry_account = ctk.CTkEntry(login_frame, width=300, height=35, font=("Arial", 12), placeholder_text="è¯·è¾“å…¥è´¦å·")
    entry_account.pack(pady=10)

    label_password = ctk.CTkLabel(login_frame, text="å¯†ç :", font=("Arial", 16), text_color="#FFFFFF")
    label_password.pack(pady=10)
    entry_password = ctk.CTkEntry(login_frame, width=300, height=35, show="*", font=("Arial", 12),
                                  placeholder_text="è¯·è¾“å…¥å¯†ç ")
    entry_password.pack(pady=10)

    login_button = ctk.CTkButton(login_frame, text="ç¡®è®¤", command=proceed_login, width=200, height=40,
                                 corner_radius=10)
    login_button.pack(pady=20)


# ä¸»ç•Œé¢
def show_main_window(account, password):
    global windowname
    main_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    main_frame.pack(padx=20, pady=20, fill="both", expand=True)

    def switch_to_task(task_type):
        global windowname
        main_frame.destroy()
        show_task_window(account, password, task_type)
        windowname = 'task'

    def create_button(parent, text, command=None):
        return ctk.CTkButton(
            parent,
            text=text,
            command=command,
            width=150,
            height=150,
            corner_radius=0,
            font=("Arial", 14),
            fg_color="#2e2e2e",
            border_color="#1f6aa5",
            border_width=2,
            hover_color="#3a3a3a",
        )

    scrollable_frame = ctk.CTkScrollableFrame(main_frame, fg_color="transparent", width=540, height=260)
    scrollable_frame.pack(pady=20, padx=10, fill="both", expand=True)

    buttons = [
                  ("QP", lambda: switch_to_task("QP")),
                  ("Transmit", lambda: switch_to_task("Transmit")),
                  ("Hold", lambda: switch_to_task("Hold")),
                  ("DelQP", lambda: switch_to_task("DelQP")),
                  ("åˆ é™¤æ‰€æœ‰house", lambda: switch_to_task("åˆ é™¤æ‰€æœ‰house")),
                  ("headerä¿®æ”¹", lambda: switch_to_task("headerä¿®æ”¹")),
                  ("æ›´æ”¹çŠ¶æ€accept", lambda: switch_to_task("æ›´æ”¹çŠ¶æ€accept")),
                  ("BBCæ•°æ®æ˜¾ç¤º", lambda: switch_to_task("BBCæ•°æ®æ˜¾ç¤º")),
                  ("BBC Document", lambda: switch_to_task("BBC Document")),
                  ("BBC House", lambda: switch_to_task("BBC House")),
                  ("æ¢¦æƒ³æˆçœŸæ¨¡æ‹Ÿå™¨", lambda: switch_to_task("æ¢¦æƒ³æˆçœŸæ¨¡æ‹Ÿå™¨")),
                  ("æ‰¹é‡æ”¾è´§", lambda: switch_to_task("æ‰¹é‡æ”¾è´§")),
                  ("query", lambda: switch_to_task("query")),
                  ("bolupdate", lambda: switch_to_task("bolupdate")),
                  ("rejectä¿®å¤(ç›®å‰ä»…AL1,EP7)", lambda: switch_to_task("rejectä¿®å¤(ç›®å‰ä»…AL1,EP7)")),
                  ("inbondæå–", lambda: switch_to_task("inbondæå–")),
                  ("itacæ£€æµ‹", lambda: switch_to_task("itacæ£€æµ‹")),
                  ("steel/al Duty", lambda: switch_to_task("steel/al Duty")),
                  ("Line æå–", lambda: switch_to_task("Line æå–")),
                  ("åå‘Line æå–", lambda: switch_to_task("åå‘Line æå–")),
                  ("Nikki template", lambda: switch_to_task("Nikki template")),
                  ("ç™½å®«æ€»ç»ŸåŠå…¬å®¤è”ç³»æ–¹å¼", lambda: switch_to_task("ç™½å®«æ€»ç»ŸåŠå…¬å®¤è”ç³»æ–¹å¼")),

              ] + [("æœªè§£é”åŠŸèƒ½", None)] * 8  # å¢åŠ ç‚¹æŒ‰é’®ä»¥ä¾¿æ˜¾ç¤ºæ»šåŠ¨æ•ˆæœ

    def create_button(parent, text, command=None):
        return ctk.CTkButton(
            parent,
            text=text,
            command=command,
            width=150,
            height=150,
            corner_radius=0,
            font=("Arial", 14),
            fg_color="#2e2e2e",
            border_color="#1f6aa5",
            border_width=2,
            hover_color="#3a3a3a",
        )

    for i in range(9):  # è¡Œ
        for j in range(3):  # åˆ—
            idx = i * 3 + j
            if idx < len(buttons):
                btn_text, btn_cmd = buttons[idx]
                btn = btn = create_button(scrollable_frame, btn_text, btn_cmd)
                btn.grid(row=i, column=j, padx=10, pady=10)


# ä»»åŠ¡ç•Œé¢
def show_task_window(account, password, task_type):
    task_frame = ctk.CTkFrame(root, fg_color="#1e1e1e", corner_radius=20)
    task_frame.pack(padx=20, pady=20, fill="both", expand=True)

    output_text = ctk.CTkTextbox(
        task_frame, width=520, height=120, font=("Consolas", 11),
        fg_color="#1e1e1e", text_color="#FFFFFF", corner_radius=10,
        border_width=2, border_color="#007acc"
    )
    output_text.pack(pady=10)

    if task_type == "Hold" or task_type == "headerä¿®æ”¹":
        mode_var = ctk.StringVar()

        mode_label = ctk.CTkLabel(task_frame, text="è¯·é€‰æ‹©æ“ä½œæ¨¡å¼ï¼š", text_color="white")
        mode_label.pack()

        if task_type == "Hold":
            mode_var.set("ä»…æŸ¥æ‰¾")
            mode_dropdown = ctk.CTkOptionMenu(
                task_frame,
                variable=mode_var,
                values=["ä»…æŸ¥æ‰¾", "åˆ é™¤"],
                width=120
            )
        elif task_type == "headerä¿®æ”¹":
            mode_var.set("61")
            mode_dropdown = ctk.CTkOptionMenu(
                task_frame,
                variable=mode_var,
                values=["61", "63"],
                width=120
            )

        mode_dropdown.pack(pady=5)
    if task_type == "æ¢¦æƒ³æˆçœŸæ¨¡æ‹Ÿå™¨":
        output_text.destroy()
        title_frame = ctk.CTkFrame(task_frame, fg_color="transparent")
        title_frame.pack(pady=30)

        dream_label1 = ctk.CTkLabel(title_frame, text="æ¢¦", text_color="#FF69B4",
                                    font=("Comic Sans MS", 28, "bold"))
        dream_label1.pack(side="left")
        dream_label2 = ctk.CTkLabel(title_frame, text="æƒ³", text_color="#00BFFF",
                                    font=("Comic Sans MS", 28, "bold"))
        dream_label2.pack(side="left")
        rest_label = ctk.CTkLabel(title_frame, text="æˆçœŸæ¨¡æ‹Ÿå™¨", text_color="#FFFFFF",
                                  font=("Comic Sans MS", 26, "bold"))
        rest_label.pack(side="left")

        def transform_dreams():
            progress_win = Toplevel(root)
            progress_win.title("æ¢¦æƒ³æˆçœŸä¸­")
            progress_win.geometry("400x150")
            progress_win.configure(bg="white")

            label = tk.Label(progress_win, text="æ¢¦æƒ³æˆçœŸä¸­...", font=("Arial", 14), bg="white")
            label.pack(pady=10)

            progress_bar = ttk.Progressbar(progress_win, length=300, mode='determinate')
            progress_bar.pack(pady=10)
            progress_bar["value"] = 0

            def update_bar():
                for i in range(101):
                    progress_bar["value"] = i
                    label.config(text=f"æ¢¦æƒ³æˆçœŸä¸­... {i}%")
                    time.sleep(0.05)
                    progress_win.update_idletasks()

                label.config(text="ğŸ‰ æ¢¦æƒ³å·²æˆçœŸ ğŸ‰")

                # âœ… è¾¾åˆ° 100% æ—¶ç«‹å³æ›¿æ¢æ–‡å­—
                def replace_text(widget):
                    try:
                        if hasattr(widget, "cget") and callable(widget.cget):
                            if "text" in widget.keys():
                                text = widget.cget("text")
                                if text:
                                    new_text = text.replace("æ¢¦æƒ³", "çœŸçš„").replace("æ¢¦", "çœŸ").replace("æƒ³", "çš„")
                                    widget.configure(text=new_text)
                    except:
                        pass
                    for child in widget.winfo_children():
                        replace_text(child)

                replace_text(task_frame)

                # âœ… è‡ªåŠ¨ 1 ç§’åå…³é—­è¿›åº¦çª—å£
                time.sleep(1)
                progress_win.destroy()

            threading.Thread(target=update_bar, daemon=True).start()

        dream_button = ctk.CTkButton(
            task_frame,
            text="ç‚¹å‡»æŠŠæ¢¦æƒ³å˜æˆçœŸçš„",
            command=transform_dreams,
            width=250,
            height=60,
            corner_radius=15,
            font=("Comic Sans MS", 18, "bold"),
            fg_color="#FF69B4",
            hover_color="#FF1493"
        )
        dream_button.pack(pady=40)

        back_button = ctk.CTkButton(task_frame, text="è¿”å›",
                                    command=lambda: go_back_to_main(task_frame, account, password),
                                    width=200, height=40, corner_radius=10)
        back_button.pack(pady=20)

        return  # ä¸ç»§ç»­æ‰§è¡Œä¸‹é¢çš„é€šç”¨é€»è¾‘

    def start_task():
        output_text.insert("end", f"å¯åŠ¨ {task_type} ä»»åŠ¡...\n")
        if task_type == "Hold" or task_type == "headerä¿®æ”¹":
            mode = mode_var.get()
            threading.Thread(target=start_program, args=(account, password, output_text, task_type, mode),
                             daemon=True).start()
        else:
            threading.Thread(target=start_program, args=(account, password, output_text, task_type),
                             daemon=True).start()

    start_button = ctk.CTkButton(task_frame, text="å¼€å§‹ä»»åŠ¡", command=start_task)
    start_button.pack(pady=10)

    back_button = ctk.CTkButton(task_frame, text="è¿”å›", command=lambda: go_back_to_main(task_frame, account, password),
                                width=200, height=40, corner_radius=10)
    back_button.pack(pady=20)


# è¿”å›ä¸»ç•Œé¢å¹¶åœæ­¢ä»»åŠ¡
def go_back_to_main(current_frame, account, password):
    global windowname
    print("é”€æ¯å½“å‰çª—å£...")  # è°ƒè¯•æ‰“å°
    current_frame.destroy()
    stop_event.set()  # è®¾ç½®åœæ­¢äº‹ä»¶ï¼Œé€šçŸ¥å­çº¿ç¨‹é€€å‡º
    show_main_window(account, password)
    windowname = 'main'


# åˆå§‹åŒ–ä¸»çª—å£
root = ctk.CTk()
root.title("å†·çŸ¥è¯†ï¼Œç”Ÿé±¼ç‰‡æ˜¯æ­»é±¼ç‰‡ã€‚")
root.geometry("600x420")
root.configure(fg_color="#1e1e1e")

# æ˜¾ç¤ºç™»å½•çª—å£
login_window()

# å¯åŠ¨ GUI ä¸»å¾ªç¯
root.mainloop()
